
# تابع `abs()` در Prometheus

تابع `abs()` یکی از توابع ریاضی در Prometheus است که برای محاسبه **مقدار مطلق** (Absolute Value) یک متریک استفاده می‌شود.

## کاربرد تابع `abs()`

تابع `abs()` مقدار مطلق یک سری زمانی یا یک بردار را محاسبه می‌کند، یعنی:
- اگر مقدار مثبت باشد، بدون تغییر باقی می‌ماند
- اگر مقدار منفی باشد، علامت آن به مثبت تغییر می‌کند

### فرمت کلی:
```promql
abs(v instant-vector)
```

## مثال‌های کاربردی:

### مثال ۱: محاسبه مقدار مطلق یک متریک
```promql
abs(temperature_celsius{instance="server01"})
```
اگر مقدار `temperature_celsius` برابر با `-15` باشد، نتیجه `15` خواهد بود.

### مثال ۲: استفاده با توابع دیگر
```promql
abs(delta(cpu_temp_celsius[2h]))
```
این پرس‌وجو تغییرات دمای CPU در 2 ساعت گذشته را محاسبه و سپس مقدار مطلق آن را برمی‌گرداند.

### مثال ۳: برای متریک‌هایی که ممکن است منفی باشند
```promql
abs(disk_free_bytes - disk_total_bytes)
```

## موارد استفاده رایج:

1. **حذف جهت در تغییرات**: وقتی فقط اندازه تغییر مهم است نه جهت آن
2. **محاسبات خطا**: وقتی می‌خواهید اختلاف بین مقادیر واقعی را بدون در نظر گرفتن علامت اندازه بگیرید
3. **پردازش متریک‌هایی که ممکن است مقادیر منفی تولید کنند**

## نکات مهم:

- تابع `abs()` فقط روی instant vectorها کار می‌کند
- این تابع برچسب‌های متریک را حفظ می‌کند
- برای range vectorها باید ابتدا از توابعی مثل `delta()` یا `rate()` استفاده کنید

---


# تابع `absent()` در Prometheus

تابع `absent()` یک تابع مفید در PromQL است که برای تشخیص عدم وجود داده (missing metrics) استفاده می‌شود.

## کاربرد اصلی:

تابع `absent()` بررسی می‌کند که آیا یک متریک خاص یا مجموعه‌ای از متریک‌ها وجود دارند یا خیر. اگر متریک وجود نداشته باشد، مقدار ۱ برمی‌گرداند و اگر وجود داشته باشد، نتیجه خالی (no data) برمی‌گرداند.

## سناریوهای استفاده:

1. **مانیتورینگ وجود متریک‌های حیاتی**:
   - بررسی کنید که آیا متریک‌های مهم مانند `up` یا متریک‌های سفارشی شما وجود دارند یا خیر.

2. **تشخیص حذف یا غیرفعال شدن اکسپورترها**:
   - وقتی یک اکسپورتر از کار می‌افتد یا حذف می‌شود.

3. **بررسی پیکربندی اشتباه**:
   - وقتی متریک‌ها به دلیل پیکربندی نادرست جمع‌آوری نمی‌شوند.

## مثال‌های کاربردی:

### مثال ۱: بررسی وجود متریک `up`
```promql
absent(up)
```
- اگر هیچ نمونه‌ای از `up` وجود نداشته باشد، خروجی یک سری زمانی با مقدار ۱ خواهد بود.
- اگر `up` وجود داشته باشد، نتیجه خالی است.

### مثال ۲: بررسی وجود متریک برای یک job خاص
```promql
absent(up{job="node-exporter"})
```
- این پرس‌وجو بررسی می‌کند که آیا متریک `up` برای job با نام `node-exporter` وجود دارد یا خیر.

### مثال ۳: ترکیب با سایر توابع
```promql
absent(sum by(job) (up))
```
- این پرس‌وجو بررسی می‌کند که آیا هر jobای وجود دارد که متریک `up` نداشته باشد.

## نکات مهم:

1. تابع `absent()` فقط برای متریک‌های instant vector کار می‌کند.
2. این تابع برای ایجاد آلارم‌ها زمانی که متریک‌ها ناپدید می‌شوند بسیار مفید است.
3. معمولاً در سیستم‌های مانیتورینگ برای اطمینان از اینکه تمام اجزای مورد انتظار در حال گزارش دادن هستند استفاده می‌شود.

## مثال آلارم:
```promql
absent(up{job="node-exporter"}) == 1
```
این عبارت وقتی فعال می‌شود که اکسپورتر node-exporter هیچ داده‌ای ارسال نکرده باشد.


-------

# تابع `absent_over_time()` در Prometheus

 برای تشخیص عدم وجود داده (missing data) در یک بازه زمانی مشخص استفاده می‌شود.

## کاربرد اصلی

این تابع بررسی می‌کند که آیا یک متریک خاص در طول یک بازه زمانی کاملاً فعال است یا خیر.

## نحوه کار

- اگر متریک مورد نظر **در کل بازه زمانی مشخص شده وجود نداشته باشد**، مقدار 1 برمی‌گرداند
- اگر **حداقل یک نمونه از متریک در آن بازه زمانی وجود داشته باشد**، نتیجه خالی (no data) برمی‌گرداند

## فرمت کلی

```promql
absent_over_time(v range-vector)
```

## مثال‌های کاربردی

### مثال ۱: بررسی وجود متریک `up` در 5 دقیقه گذشته

```promql
absent_over_time(up[5m])
```

### مثال ۲: بررسی وجود متریک برای یک نمونه خاص

```promql
absent_over_time(up{instance="server01"}[1h])
```

### مثال ۳: ترکیب با توابع دیگر

```promql
absent_over_time(sum by(job) (up)[30m])
```

## تفاوت با `absent()`

1. `absent()` فقط وضعیت فعلی را بررسی می‌کند (instant vector)
2. `absent_over_time()` وضعیت را در یک بازه زمانی بررسی می‌کند (range vector)

## موارد استفاده معمول

1. **تشخیص اکسپورترهای از کار افتاده**: وقتی یک اکسپورتر برای مدت طولانی داده ارسال نکرده باشد

2. **مانیتورینگ سلامت متریک‌ها**: اطمینان از اینکه متریک‌های حیاتی به طور مداوم گزارش می‌شوند

3. **تشخیص مشکلات شبکه**: وقتی ارتباط با اکسپورترها قطع شده باشد

## مثال برای ایجاد آلارم

```promql
absent_over_time(up{job="node-exporter"}[15m]) == 1
```

این آلارم زمانی فعال می‌شود که متریک `up` برای job مربوط به node-exporter به مدت 15 دقیقه وجود نداشته باشد.

## نکات مهم

- این تابع برای range vectorها کار می‌کند
- بازه زمانی ([5m], [1h] و...) باید مشخص شود
- معمولاً در سیستم‌های مانیتورینگ برای تشخیص مشکلات طولانی مدت استفاده می‌شود
---

# تابع `changes()` در Prometheus
 
  تعداد تغییرات مقدار یک متریک را در یک بازه زمانی مشخص محاسبه میکند.

## کاربرد اصلی

این تابع تعداد دفعاتی که مقدار یک متریک در بازه زمانی داده شده تغییر کرده است را می‌شمارد.

## نحوه عملکرد

- برای هر سری زمانی، تعداد تغییرات مقدار را در بازه مشخص شده می‌شمارد
- هر بار که مقدار متریک نسبت به نمونه قبلی تغییر کند، یک عدد به شمارنده اضافه می‌شود
- تغییرات بین `NaN` (داده وجود ندارد) و یک مقدار معتبر نیز به عنوان تغییر محسوب می‌شود

## فرمت کلی

```promql
changes(v range-vector)
```

## مثال‌های کاربردی

### مثال ۱: شمارش تغییرات یک متریک در ۵ دقیقه گذشته

```promql
changes(process_resident_memory_bytes[5m])
```

### مثال ۲: بررسی تغییرات وضعیت یک سرویس

```promql
changes(up{job="api-server"}[1h])
```

### مثال ۳: ترکیب با توابع دیگر

```promql
sum by(instance) (changes(process_cpu_seconds_total[5m]))
```

## موارد استفاده معمول

1. **تشخیص نوسانات**: برای شناسایی متریک‌هایی که مقدارشان به طور غیرعادی در حال تغییر است
2. **مانیتورینگ وضعیت**: برای بررسی تعداد دفعات تغییر وضعیت یک سرویس
3. **تحلیل رفتار**: برای فهمیدن الگوهای تغییر در متریک‌ها

## مثال برای ایجاد آلارم

```promql
changes(up{job="mysql"}[15m]) > 3
```

این آلارم زمانی فعال می‌شود که سرویس MySQL بیش از ۳ بار در ۱۵ دقیقه تغییر وضعیت داده باشد.

## نکات مهم

- این تابع برای range vectorها کار می‌کند
- تغییرات بین `NaN` و یک مقدار معتبر نیز شمارش می‌شود
- برای متریک‌های counter، معمولاً از `rate()` یا `irate()` مناسب‌تر است
- مقدار بازگشتی همیشه یک عدد صحیح است

## تفاوت با `deriv()`

- `changes()` فقط تعداد تغییرات را می‌شمارد
- `deriv()` نرخ تغییر را در واحد زمان محاسبه می‌کند (مشتق)


---------

# تابع `clamp()` در Prometheus

رای محدود کردن مقادیر یک متریک در یک بازه مشخص استفاده میشود.

## کاربرد اصلی

این تابع مقادیر یک متریک را به محدوده تعریف شده شما محدود میکند:
- مقادیر کمتر از حداقل را به حداقل تنظیم میکند
- مقادیر بیشتر از حداکثر را به حداکثر تنظیم میکند
- مقادیر درون محدوده را بدون تغییر باقی میگذارد

## انواع توابع clamp

Prometheus دو نوع تابع clamp ارائه میدهد:

1. `clamp_min(v instant-vector, min scalar)`
   - فقط یک حداقل تعیین میکند
   - مثال: `clamp_min(temperature, 10)`

2. `clamp_max(v instant-vector, max scalar)`
   - فقط یک حداکثر تعیین میکند
   - مثال: `clamp_max(cpu_usage, 90)`

3. ترکیب هر دو برای ایجاد محدوده کامل

## فرمت کلی

```promql
clamp(v instant-vector, min scalar, max scalar)
```

## مثال‌های کاربردی

### مثال ۱: محدود کردن دما بین 10 تا 30 درجه

```promql
clamp(temperature_celsius, 10, 30)
```

### مثال ۲: جلوگیری از مقادیر منفی

```promql
clamp_min(memory_usage_bytes, 0)
```

### مثال ۳: محدود کردن درصد CPU

```promql
clamp(cpu_usage_percent, 0, 100)
```

## موارد استفاده معمول

1. **پاکسازی داده‌ها**: حذف مقادیر غیرمنطقی یا ناممکن
2. **تهیه نمودارها**: محدود کردن مقادیر برای نمایش بهتر
3. **محاسبات امن**: اطمینان از اینکه مقادیر در محدوده معتبر باقی میمانند

## نکات مهم

- تابع `clamp()` برچسب‌های متریک را حفظ میکند
- برای range vectorها باید ابتدا از توابعی مثل `rate()` استفاده کنید
- مقادیر NaN را تغییر نمیدهد
- حداقل و حداکثر میتوانند اعداد منفی باشند

## مثال پیشرفته

```promql
clamp(
  rate(http_requests_total[5m]),
  0,  # حداقل
  1000 # حداکثر
)
```

این مثال نرخ درخواست‌های HTTP را بین 0 تا 1000 درخواست بر ثانیه محدود میکند.

-----

# توابع `day_of_*` در Prometheus

در Prometheus چندین تابع مربوط به تاریخ و زمان ارائه می‌دهد که به شما امکان می‌دهد بخش‌های مختلف تاریخ را از تایم‌استمپ‌ها استخراج کنید. در اینجا به توابعی که با `day_of_` شروع می‌شوند می‌پردازیم:

## 1. `day_of_month()`

**کاربرد**: استخراج روز ماه از یک تایم‌استمپ (عدد بین 1 تا 31)

**سینتکس**:
```promql
day_of_month(v instant-vector)
```

**مثال**:
```promql
day_of_month(timestamp(up))
```
این پرس‌وجو روز جاری ماه را برمی‌گرداند (مثلاً 15 برای پانزدهم ماه).

## 2. `day_of_week()`

**کاربرد**: استخراج روز هفته (یکشنبه=0 تا شنبه=6)

**سینتکس**:
```promql
day_of_week(v instant-vector)
```

**مثال**:
```promql
day_of_week(timestamp(process_start_time_seconds))
```
مقدار 0 برای یکشنبه، 1 برای دوشنبه و الی آخر.

## 3. `day_of_year()`

**کاربرد**: استخراج روز سال (عدد بین 1 تا 365 یا 366 در سال کبیسه)

**سینتکس**:
```promql
day_of_year(v instant-vector)
```

**مثال**:
```promql
day_of_year(timestamp(up))
```
مثلاً مقدار 1 برای اول فروردین و 365 برای آخر اسفند.

## کاربردهای عملی:

1. **فیلتر کردن داده‌ها بر اساس روز**:
   ```promql
   up{job="api"} and day_of_week(timestamp(up)) < 5
   ```
   (فقط روزهای کاری هفته)

2. **تجزیه و تحلیل الگوهای هفتگی**:
   ```promql
   avg by (day_of_week) (rate(http_requests_total[1d]))
   ```

3. **گزارش‌دهی ماهانه**:
   ```promql
   sum by (day_of_month) (sales_events_total)
   ```

## نکات مهم:

- تمام این توابع روی instant vectorها کار می‌کنند
- ورودی باید تایم‌استمپ باشد (معمولاً با تابع `timestamp()` می‌گیریم)
- مقادیر برگشتی همیشه اعداد صحیح هستند
- برای range vectorها باید از توابع aggregation استفاده کنید

## مثال ترکیبی:

```promql
# تعداد درخواست‌ها در آخر هفته (شنبه و یکشنبه)
sum(rate(http_requests_total[1h])) by (service)
  * on() group_left()
(day_of_week(timestamp(up)) >= 5)
```

این پرس‌وجو فقط داده‌های مربوط به روزهای آخر هفته را محاسبه می‌کند.

-----------


# تابع `delta()` در Prometheus

برای محاسبه تغییرات مقدار یک متریک در یک بازه زمانی مشخص استفاده می‌شود.

## کاربرد اصلی

این تابع تفاوت بین اولین و آخرین مقدار یک متریک در بازه زمانی داده شده را محاسبه می‌کند:

```
delta = مقدار آخر - مقدار اول
```

## ویژگی‌های کلیدی:

1. **مخصوص متریک‌های نوع Counter**: برای متریک‌هایی که فقط افزایش می‌یابند (مانند تعداد درخواست‌ها) مناسب است
2. **مقابله با Reset**: اگر Counter ریست شود، محاسبه را به درستی انجام می‌دهد
3. **بازه زمانی**: حتماً نیاز به تعیین بازه زمانی دارد (مثل [5m]، [1h])

## فرمت کلی:

```promql
delta(v range-vector)
```

## مثال‌های کاربردی:

### مثال ۱: محاسبه افزایش تعداد درخواست‌ها در ۵ دقیقه

```promql
delta(http_requests_total[5m])
```

### مثال ۲: محاسبه افزایش با گروه‌بندی

```promql
delta(http_requests_total{job="api"}[1h])
```

### مثال ۳: ترکیب با توابع دیگر

```promql
sum by (instance) (delta(process_cpu_seconds_total[1m]))
```

## تفاوت با `increase()`:

- ء`delta()` مقدار مطلق تغییر را برمی‌گرداند (ممکن است منفی باشد)
- ء`increase()` همیشه مقدار غیرمنفی برمی‌گرداند و برای Counterها مناسب‌تر است

## نکات مهم:

1. فقط برای range vectorها کار می‌کند
2. برای متریک‌های Gauge (که می‌توانند کاهش یابند) نیز کاربرد دارد
3. ممکن است مقادیر منفی برگرداند (در صورت کاهش مقدار متریک)
4. در صورت ریست شدن Counter، محاسبات را تصحیح می‌کند

## مثال پیشرفته:

```promql
delta(
  node_network_receive_bytes_total{device="eth0"}[1h]
) / 1024 / 1024
```
(محاسبه مگابایت دریافت شده در یک ساعت)


-----

# تابع `deriv()` در Prometheus

 برای محاسبه **نرخ تغییرات** یک متریک در یک بازه زمانی استفاده میشود.

## کاربرد اصلی

این تابع **مشتق** (نرخ تغییر) یک متریک Gauge را در بازه زمانی مشخص محاسبه میکند و نشان میدهد که مقدار متریک با چه سرعتی در حال تغییر است.

## فرمت کلی:
```promql
deriv(v range-vector)
```

## ویژگی‌های کلیدی:
1. مناسب برای متریک‌های نوع **Gauge** (مقادیر متغیر)
2. محاسبه **نرخ تغییر بر ثانیه**
3. استفاده از رگرسیون خطی برای محاسبه دقیقتر
4. نیاز به تعیین بازه زمانی (مثلاً [5m], [1h])

## مثال‌های کاربردی:

### مثال ۱: محاسبه نرخ تغییر دمای CPU
```promql
deriv(node_cpu_temp_celsius[10m])
```
> نتیجه: میزان تغییر دما بر حسب درجه سانتیگراد بر ثانیه

### مثال ۲: روند تغییرات استفاده از حافظه
```promql
deriv(process_resident_memory_bytes[1h])
```

### مثال ۳: ترکیب با توابع دیگر
```promql
avg(deriv(disk_usage_percent[30m]))
```

## تفاوت با `delta()` و `rate()`:
| تابع      | مناسب برای    | خروجی                          | روش محاسبه     |
| --------- | ------------- | ------------------------------ | -------------- |
| `deriv()` | Gauge         | نرخ تغییر (ممکن است منفی باشد) | رگرسیون خطی    |
| `delta()` | Gauge/Counter | تغییر مطلق                     | تفاوت ساده     |
| `rate()`  | Counter       | نرخ متوسط تغییر                | بر اساس افزایش |

## نکات مهم:
1. برای متریک‌های Counter از `rate()` یا `irate()` استفاده کنید
2. مقادیر منفی نشان دهنده کاهش متریک است
3. دقت محاسبه به طول بازه زمانی بستگی دارد
4. برای نمایش روندهای بلندمدت مفید است

## مثال پیشرفته:
```promql
# پیش‌بینی زمان رسیدن به حد مجاز حافظه
predict_linear(
  deriv(process_resident_memory_bytes[1h])[10m:],
  3600
)
```

این تابع برای تحلیل روندها و پیش‌بینی مشکلات احتمالی بسیار مفید است.

