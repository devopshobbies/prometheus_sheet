
***



ุฏุฑ Prometheusุ **Recording Rules** ฺฉ ุงุฒ ูฺฺฏโูุง ฺฉูุฏ ุจุฑุง **ุจูููโุณุงุฒ ฺฉูุฆุฑโูุง ู ุฐุฎุฑู ููุงุฏุฑ ูุญุงุณุจูโุดุฏู** ุงุณุช. ุจุงุฏ ูุฏูโุจูโูุฏู ุชูุถุญ ุฏูู:

---

## ๐งฉ ุชุนุฑู

โ**Recording Rule** ฺฉ ูุงุนุฏู ุฏุฑ Prometheus ุงุณุช ฺฉู ุจู ุดูุง ุงุฌุงุฒู ูโุฏูุฏ:

* **ฺฉ ุนุจุงุฑุช PromQL** (query) ุฑุง ูุญุงุณุจู ฺฉูุฏุ
* **ูุชุฌู ุขู ุฑุง ุจู ุตูุฑุช ฺฉ ูุชุฑฺฉ ุฌุฏุฏ** ุฐุฎุฑู ฺฉูุฏุ
* ู ุจุนุฏูุง ูุงููุฏ ฺฉ metric ูุนููู ุงุฒ ุขู ุงุณุชูุงุฏู ฺฉูุฏ.

---

## ๐ฏ ูุฏู

1. **ุตุฑููโุฌู ุฏุฑ ุฒูุงู ู ููุงุจุน**

   * ุงฺฏุฑ ฺฉูุฆุฑ ูพฺุฏู ุฏุงุฑุฏ ู ูุฑุชุจุงู ุงุฒ ุขู ุงุณุชูุงุฏู ูโฺฉูุฏุ ูโุชูุงูุฏ ูุชุฌู ุฑุง ุฐุฎุฑู ฺฉูุฏ ุชุง ุฏูุจุงุฑู ูุญุงุณุจู ูุดูุฏ.
2. **ุณุงุฏฺฏ ุฏุฑ dashboard ู alerting**

   * ูุชุฑฺฉ ุฐุฎุฑูโุดุฏู ูุซู ฺฉ metric ูุนููู ูุงุจู ุงุณุชูุงุฏู ุงุณุช.
3. **ุงุดุชุฑุงฺฉ ุจู ฺฉุงุฑุจุฑุงู ุง ุณุณุชูโูุง**

   * ููุงุฏุฑ ูุญุงุณุจูโุดุฏู ุฑุง ุจู ุฑุงุญุช ูโุชูุงู ุจุฑุง Grafana ุง Alertmanager ุงุณุชูุงุฏู ฺฉุฑุฏ.

---

## โ๏ธ ุณุงุฎุชุงุฑ Recording Rule

ุฏุฑ ูุงู **Prometheus rules** (ูุซูุงู `rules.yml`) ุชุนุฑู ูโุดูุฏ:

```yaml
groups:
  - name: example_rules
    interval: 30s        # ูุงุตูู ุฒูุงู ูุญุงุณุจู
    rules:
      - record: job:http_inprogress_requests:sum
        expr: sum(http_inprogress_requests) by (job)
```

### ุชูุถุญ ููุฏูุง

| ููุฏ       | ุชูุถุญ                                    |
| ---------- | ---------------------------------------- |
| `groups`   | ฺฏุฑูู ุงุฒ rules ุจุง ฺฉ ูุงู ู interval ูุดุฎุต |
| `interval` | ูุฑ ฺูุฏ ุซุงูู rule ุงุฌุฑุง ุดูุฏ               |
| `record`   | ูุงู metric ุฌุฏุฏ ฺฉู ูุชุฌู ุฐุฎุฑู ูโุดูุฏ    |
| `expr`     | ุนุจุงุฑุช PromQL ฺฉู ูุญุงุณุจู ูโุดูุฏ            |

---

## ๐ง ูุซุงู ุนูู

ูุฑุถ ฺฉู metric ุฏุงุฑู:

```
http_requests_total{job="web"}
```

ู ูโุฎูุงูู **ุชุนุฏุงุฏ ฺฉู ุฏุฑุฎูุงุณุชโูุง ุจุฑุง ูุฑ job** ุฑุง ุฐุฎุฑู ฺฉูู:

```yaml
groups:
- name: example
  interval: 1m
  rules:
  - record: job:http_requests_total:sum
    expr: sum(http_requests_total) by (job)
```

* ุจุนุฏ ุงุฒ ุงูฺฉู Prometheus ุงู rule ุฑุง ุงุฌุฑุง ฺฉุฑุฏุ metric ุฌุฏุฏ ุจู ูุงู `job:http_requests_total:sum` ุงุฌุงุฏ ูโุดูุฏ.
* ุญุงูุง ูโุชูุงูู ุฏุฑ Grafana ุง Alert:

```promql
job:http_requests_total:sum{job="web"} > 1000
```

ุฑุง ุงุณุชูุงุฏู ฺฉูู ุจุฏูู ุงูฺฉู ูุฑ ุจุงุฑ ฺฉู sum ูุญุงุณุจู ุดูุฏ.

---

## โก ูุฒุงุง

1. ฺฉุงูุด ุจุงุฑ ูุญุงุณุจุงุช Prometheus ุจุฑุง ฺฉูุฆุฑโูุง ูพฺุฏู
2. ุณุงุฏูโุณุงุฒ dashboard ู alert rules
3. ุงูฺฉุงู ุงุณุชูุงุฏู ูุฏุงูู ุงุฒ ูุญุงุณุจุงุช ูพุฑูุตุฑู ุจุฏูู ุชฺฉุฑุงุฑ

---

## โ๏ธ ูฺฉุงุช ููู

* **ูุงู ูุชุฑฺฉ ุฌุฏุฏ ูุจุงุฏ ุจุง metric ุงุตู ุชุฏุงุฎู ุฏุงุดุชู ุจุงุดุฏ.**
* โInterval rule ุจุงุฏ ูุชูุงุณุจ ุจุง ุฏุงุฏูโูุง ู ูุงุฒ dashboard ุจุงุดุฏ (ูุซูุงู 30s ุชุง 1m).
* โRecording rules ููุท **ููุงุฏุฑ ูุญุงุณุจูโุดุฏู ุฑุง ุฐุฎุฑู ูโฺฉููุฏ**ุ ุชุบุฑ ุงุตู metric ุงุชูุงู ููโุงูุชุฏ.

---

## ๐งพ ุฎูุงุตู

| ูฺฺฏ  | ุชูุถุญ                                            |
| ------ | ------------------------------------------------ |
| ูุงู    | Recording Rule                                   |
| ูุฏู    | ุฐุฎุฑู ูุชุงุฌ ูุญุงุณุจู PromQL ุจู ุนููุงู metric ุฌุฏุฏ   |
| ูุฑูุฏ  | ุนุจุงุฑุช PromQL                                     |
| ุฎุฑูุฌ  | metric ุฌุฏุฏ ูุงุจู ุงุณุชูุงุฏู ูุงููุฏ ูุฑ metric ุฏฺฏุฑ    |
| ฺฉุงุฑุจุฑุฏ | ุจูููโุณุงุฒ ฺฉูุฆุฑโูุงุ ุณุงุฏูโุณุงุฒ alert ู dashboard |

---

---

#####  ุงุฒ ุทุฑู HTTP API

ุฏุณุชุฑุณ ุจู PromQL ุชููุง ุงุฒ ุทุฑู HTTP API ุงูฺฉุงูโูพุฐุฑ ูุณุช. ุดูุง ููฺูู ูโุชูุงูุฏ ุงุฒ recording rules ุงุณุชูุงุฏู ฺฉูุฏ ุชุง ูพุฑููุชุฆูุณ ุนุจุงุฑุงุช PromQL ุฑุง ุจูโุทูุฑ ููุธู ุงุฑุฒุงุจ ฺฉุฑุฏู ู ูุชุงุฌ ุขูโูุง ุฑุง ุฏุฑุงูุช (ingest) ููุงุฏ. ุงู ฺฉุงุฑ ุจุฑุง ุณุฑุนุช ุจุฎุดุฏู ุจู ุฏุงุดุจูุฑุฏูุง ุดูุงุ ุงุฑุงุฆู ูุชุงุฌ ุชุฌูุนโุดุฏู ุจุฑุง ุงุณุชูุงุฏู ุฏุฑ ุฌุงูุง ุฏฺฏุฑุ ู ุชุฑฺฉุจ range vector functions ููุฏ ุงุณุช. ุณุงุฑ ุณุณุชูโูุง ูุงูุชูุฑูฺฏ ููฺฉู ุงุณุช ูุงุจูุช ูุนุงุฏู ุฎูุฏ ุฑุง ยซฺฉูุฆุฑโูุง ุงุณุชุงยป (standing queries) ุง ยซฺฉูุฆุฑโูุง ูพูุณุชูยป (continuous queries) ุจูุงููุฏ. ยซููุงูู ูุดุฏุงุฑุฏูยป (Alerting rules) ูุฒ ููุน ุงุฒ recording rules ูุณุชูุฏ. 

## ุงุณุชูุงุฏู ุงุฒ recording rules

โrecording rules ุฏุฑ ูุงูโูุง ุฌุฏุง ุงุฒ `prometheus.yml` ุดูุง ูุฑุงุฑ ูโฺฏุฑูุฏ ฺฉู ุจู ุนููุงู ยซูุงูโูุง ููุงููยป (rule files) ุดูุงุฎุชู ูโุดููุฏ. ููุงููุฏ `prometheus.yml`ุ ูุงูโูุง ููุงูู ูุฒ ุงุฒ ูุฑูุช YAML ุงุณุชูุงุฏู ูโฺฉููุฏ. ุดูุง ูโุชูุงูุฏ ูุญู ูุฑุงุฑฺฏุฑ ูุงูโูุง ููุงูู ุฎูุฏ ุฑุง ุจุง ุงุณุชูุงุฏู ุงุฒ ููุฏ ุณุทุญ ุจุงูุง `rule_files` ุฏุฑ `prometheus.yml` ุฎูุฏ ูุดุฎุต ฺฉูุฏ. ุจู ุนููุงู ูุซุงูุ ูุซุงู ฑ ฺฉ ูุงู ูุงููู ุจู ูุงู `rules.yml` ุฑุง ุจุงุฑฺฏุฐุงุฑ ูโฺฉูุฏุ ุนูุงูู ุจุฑ ุงูฺฉู ุฏู ูุฏู (target) ุฑุง ูุฒ ุฌูุนโุขูุฑ (scrape) ูโฺฉูุฏ.

ูุซุงู ฑ. `prometheus.yml` ฺฉู ุฏู ูุฏู ุฑุง ุฌูุนโุขูุฑ ู ฺฉ ูุงู ูุงููู ุฑุง ุจุงุฑฺฏุฐุงุฑ ูโฺฉูุฏ.
```yaml
global:
  scrape_interval: 10s
  evaluation_interval: 10s
rule_files:
  - rules.yml
scrape_configs:
  - job_name: prometheus
    static_configs:
      - targets:
          - localhost:9090
  - job_name: node
    static_configs:
      - targets:
          - localhost:9100
```

ูุดุงุจู ููุฏ `files` ุฏุฑ `file_sd_configs`ุ `rule_files` ูุณุช ุงุฒ ูุณุฑูุง ุฑุง ูโูพุฐุฑุฏ ู ุดูุง ูโุชูุงูุฏ ุงุฒ ุงูฺฏููุง ุนุงู (globs) ุฏุฑ ูุงู ูุงู ุงุณุชูุงุฏู ฺฉูุฏ. ุจุฑุฎูุงู file service discovery  ฺฏุฒูู`rule_files` ุงุฒ inotify ุงุณุชูุงุฏู ููโฺฉูุฏ ู ุชุบุฑุงุช ุฑุง ฺฉู ุฏุฑ ูุงูโูุง ููุงูู ุงุฌุงุฏ ูโฺฉูุฏุ ุจูโุทูุฑ ุฎูุฏฺฉุงุฑ ุชุดุฎุต ููโุฏูุฏ. ุฏุฑ ุนูุถุ ุจุงุฏ ูพุฑููุชุฆูุณ ุฑุง ูุฌุฏุฏุงู ุฑุงูโุงูุฏุงุฒ (restart) ฺฉุฑุฏู ุง ูพฺฉุฑุจูุฏ ุขู ุฑุง ูุฌุฏุฏุงู ุจุงุฑฺฏุฐุงุฑ (reload) ฺฉูุฏ. ุจุฑุง ุงูฺฉู ุงุฒ ูพุฑููุชุฆูุณ ุจุฎูุงูุฏ ูพฺฉุฑุจูุฏ ุฎูุฏ ุฑุง ูุฌุฏุฏุงู ุจุงุฑฺฏุฐุงุฑ ฺฉูุฏุ ูโุชูุงูุฏ ุณฺฏูุงู SIGHUP ุฑุง ุจุง ุงุณุชูุงุฏู ุงุฒ ุฏุณุชูุฑ ูุงููุฏ ุฒุฑ ุจุฑุง ุขู ุงุฑุณุงู ฺฉูุฏ:

`kill -HUP <pid>`

ฺฉู ุฏุฑ ุขู `pid` ุดูุงุณู ูุฑุขูุฏ (process ID) ูพุฑููุชุฆูุณ ุงุณุช. ููฺูู ูโุชูุงูุฏ ฺฉ ุฏุฑุฎูุงุณุช HTTP POST ุจู ููุทู ูพุงุงู (endpoint) `/-/reload` ูพุฑููุชุฆูุณ ุงุฑุณุงู ฺฉูุฏุ ุงูุง ุจู ุฏูุงู ุงููุชุ ุงู ฺฉุงุฑ ูุณุชูุฒู ูุดุฎุต ุดุฏู ููฺฏ `--web.enable-lifecycle` ุงุณุช. ุงฺฏุฑ ุจุงุฑฺฏุฐุงุฑ ูุฌุฏุฏ ูุงูููู ุจุงุดุฏุ ูพุฑููุชุฆูุณ ุงู ููุถูุน ุฑุง ูุงฺฏ ูโฺฉูุฏ ู ุดูุง ูุดุงูุฏู ุฎูุงูุฏ ฺฉุฑุฏ ฺฉู ูุชุฑฺฉ `prometheus_config_last_reload_successful` ุจู 0 ุชุบุฑ ูโฺฉูุฏ. ุจุฑุง ุชุดุฎุต ูุงูโูุง ูพฺฉุฑุจูุฏ ุง ููุงูู ูุงูุนุชุจุฑ ุงุฒ ูุจูุ ูโุชูุงูุฏ ุงุฒ ุฏุณุชูุฑ `promtool check config` ุจุฑุง ุจุฑุฑุณ `prometheus.yml` ุฎูุฏ ุงุณุชูุงุฏู ฺฉูุฏ. ุงู ุฏุณุชูุฑ ููฺูู ุชูุงู ูุงูโูุง ููุงูู ุงุฑุฌุงุน ุฏุงุฏู ุดุฏู ุชูุณุท `prometheus.yml` ุฑุง ุจุฑุฑุณ ูโฺฉูุฏ. ููฺฉู ุงุณุช ุงู ุฑุง ุจู ุนููุงู ฺฉ ยซุจุฑุฑุณ ูพุด ุงุฒ ุงุฑุณุงูยป (pre-submit check) ุง ยซุชุณุช ูุงุญุฏยป (unit test) ุฏุงุดุชู ุจุงุดุฏ ฺฉู ูุจู ุงุฒ ุงุนูุงู ูุงู ูพฺฉุฑุจูุฏ ุงุฌุฑุง ูโุดูุฏ. ุงฺฏุฑ ูโุฎูุงูุฏ ูุญู (syntax) ูุงูโูุง ููุงูู ูููุฑุฏ ุฑุง ุจุฑุฑุณ ฺฉูุฏุ ูโุชูุงูุฏ ุงุฒ `promtool check rules` ุงุณุชูุงุฏู ฺฉูุฏ. ุฎูุฏู ูุงูโูุง ููุงูู ุดุงูู ุตูุฑยน ุง ฺูุฏ ยซฺฏุฑูู ุงุฒ ููุงููยป (groups of rules) ูุณุชูุฏ. ูุซุงู ฒ ฺฉ ูุงู ูุงููู ุฑุง ูุดุงู ูโุฏูุฏ.

ูุซุงู ฒ. `rules.yml` ุจุง ฺฉ ฺฏุฑูู ุดุงูู ุฏู ูุงููู
```yaml
groups:
  - name: example
    rules:
      - record: job:process_cpu_seconds:rate5m
        expr: sum without(instance)(rate(process_cpu_seconds_total[5m]))
      - record: job:process_open_fds:max
        expr: max without(instance)(process_open_fds)
```

ูุชูุฌู ุฎูุงูุฏ ุดุฏ ฺฉู ฺฏุฑูู ฺฉ ูุงู ุฏุงุฑุฏ. ุงู ูุงู ุจุงุฏ ุฏุฑ ฺฉ ูุงู ูุงููู ููุญุตุฑ ุจู ูุฑุฏ ุจุงุดุฏ ู ุฏุฑ ุฑุงุจุท ฺฉุงุฑุจุฑ (UI) ูพุฑููุชุฆูุณ ู ูุชุฑฺฉโูุง ุงุณุชูุงุฏู ูโุดูุฏ. `expr` ุนุจุงุฑุช PromQL ุงุณุช ฺฉู ุจุงุฏ ุงุฑุฒุงุจ ุดุฏู ู ุฎุฑูุฌ ุขู ุฏุฑ ูุงู ูุชุฑฺฉ ฺฉู ุชูุณุท `record` ูุดุฎุต ุดุฏูุ ูุฑุงุฑ ฺฏุฑุฏ.

ุงูฺฉุงู ูุดุฎุต ฺฉุฑุฏู `evaluation_interval` ุจุฑุง ฺฉ ฺฏุฑูู ูุฌูุฏ ุฏุงุฑุฏุ ุงูุง ููุงููุฏ `scrape_interval`ุ ุจุฑุง ุญูุธ ุณูุงูุช ู ุณุงุฏฺฏุ ุจุงุฏ ุชููุง ฺฉ ุจุงุฒู ุฒูุงู (interval) ุฏุฑ ฺฉ ูพุฑููุชุฆูุณ ุฏุงุดุชู ุจุงุดุฏ. ููฺูู ูโุชูุงูุฏ ูุฌููุนูโุง ุงุฒ ุจุฑฺุณุจโูุง (labels) ุฑุง ุฏุฑ ููุฏ `labels` ุจุฑุง ุงุถุงูู ุดุฏู ุจู ุฎุฑูุฌ ูุดุฎุต ฺฉูุฏุ ุงูุง ุงู ฺฉุงุฑ ุจู ูุฏุฑุช ุจุฑุง recording rules ููุงุณุจ ุงุณุช.ยฒ ูุฑ ูุงููู ุฏุฑ ฺฉ ฺฏุฑูู ุจู ููุจุช ุงุฑุฒุงุจ ูโุดูุฏ ู ุฎุฑูุฌ ูุงููู ุงูู ุดูุง ูุจู ุงุฒ ุงุฌุฑุง ูุงููู ุฏูู ุดูุง ุฏุฑ ูพุงฺฏุงู ุฏุงุฏู ุณุฑ ุฒูุงู (time series database) ุฏุฑุงูุช (ingest) ูโุดูุฏ. ุฏุฑ ุญุงู ฺฉู ููุงูู ุฏุฑูู ฺฉ ฺฏุฑูู ุจู ุตูุฑุช ูุชูุงู ุงุฌุฑุง ูโุดููุฏุ ฺฏุฑููโูุง ูุฎุชูู ุฏุฑ ุฒูุงูโูุง ูุชูุงูุช ุงุฌุฑุง ุฎูุงููุฏ ุดุฏุ ููุงูุทูุฑ ฺฉู ุงูุฏุงู ูุฎุชูู ุฏุฑ ุฒูุงูโูุง ูุชูุงูุช ุฌูุนโุขูุฑ (scrape) ูโุดููุฏ. ุงู ฺฉุงุฑ ุจุฑุง ูพุฎุด ฺฉุฑุฏู ุจุงุฑ ฺฉุงุฑ (load) ุฑู ูพุฑููุชุฆูุณ ุดูุง ุงูุฌุงู ูโุดูุฏ. ููฺฏุงู ฺฉู ููุงูู ุดูุง ุจุงุฑฺฏุฐุงุฑ ู ุงุฌุฑุง ุดุฏูุฏุ ูโุชูุงูุฏ ุขูโูุง ุฑุง ุฏุฑ ุตูุญู ูุถุนุช ููุงูู (Rules status page) ุฏุฑ ุขุฏุฑุณ `http://localhost:9090/rules` ูุดุงูุฏู ฺฉูุฏุ ููุงูุทูุฑ ฺฉู ุฏุฑ ุดฺฉู ฑ ูุดุงู ุฏุงุฏู ุดุฏู ุงุณุช.

![[rule1.png]]

ุดฺฉู ฑ. ุตูุญู ูุถุนุช ููุงูู ูพุฑููุชุฆูุณ

ุนูุงูู ุจุฑ ูุณุช ฺฉุฑุฏู ููุงูู ุดูุงุ ูุฏุช ุฒูุงู ฺฉู ฺฉู ฺฏุฑูู ุจุฑุง ุขุฎุฑู ุงุฑุฒุงุจ ุตุฑู ฺฉุฑุฏู ู ูุฏุช ุฒูุงู ฺฉู ูุฑ ูุงููู ุจุฑุง ุงุฌุฑุง ุตุฑู ฺฉุฑุฏู ูุฒ ููุงุด ุฏุงุฏู ูโุดูุฏ. ูโุชูุงูุฏ ุงุฒ ุงู ุงุทูุงุนุงุช ุจุฑุง ุงูุชู ููุงูู ูพุฑูุฒูู ฺฉู ููฺฉู ุงุณุช ูุงุฒ ุจู ุชูุธู ุง ุจุงุฒูฺฏุฑ ุฏุงุดุชู ุจุงุดูุฏุ ุงุณุชูุงุฏู ฺฉูุฏ. ูุชุฑฺฉ `prometheus_rule_group_last_duration_seconds` ูุฒ ุจู ุดูุง ูโฺฏูุฏ ฺฉู ุขุฎุฑู ุงุฑุฒุงุจ ูุฑ ฺฏุฑูู ฺูุฏุฑ ุทูู ฺฉุดุฏู ุงุณุชุ ฺฉู ูโุชูุงูุฏ ุงุฒ ุขู ุจุฑุง ุชุนู ุงูฺฉู ุขุง ุงุฎุฑุงู ุชุบุฑุงุช ุฏุฑ ูุฒูู ููุงูู ุดูุง ุฑุฎ ุฏุงุฏู ุงุณุช ุง ุฎุฑุ ุงุณุชูุงุฏู ฺฉูุฏ. ูฺ ูุชุฑฺฉ ุจุฑุง ูุฏุช ุฒูุงู ููุงูู ูููุฑุฏ ูุฌูุฏ ูุฏุงุฑุฏุ ุฒุฑุง ุงู ุงูุฑ ูโุชูุงูุฏ ุจุงุนุซ ูุดฺฉูุงุช ฺฉุงุฑุฏูุงูุช (cardinality issues) ุดูุฏ. ุฏุฑ ุงู ููุฑุฏุ ููุงูู ฺฉูุชุฑ ุงุฒ ฺฉ ููโุซุงูู ุฒูุงู ูโุจุฑูุฏุ ฺฉู ุจุณุงุฑ ฺฉูุชุฑ ุงุฒ ุจุงุฒู ุงุฑุฒุงุจ ุงุณุชุ ุจูุงุจุฑุงู ุฌุง ูฺฏุฑุงู ูุณุช.

ูฺ API ุจุฑุง ุจุงุฑฺฏุฐุงุฑ ุง ุชุบุฑ ููุงูู ูุฌูุฏ ูุฏุงุฑุฏ. ููุงููุฏ ูพฺฉุฑุจูุฏ ูพุฑููุชุฆูุณ ุจูโุทูุฑ ฺฉูุ ูุงูโูุง ุจู ุนููุงู ูพุงูโุง ุฏุฑ ูุธุฑ ฺฏุฑูุชู ุดุฏูโุงูุฏ ฺฉู ุฏุฑ ุตูุฑุช ุชูุงู ูโุชูุงูุฏ ฺูู ุณุณุชู ุฑุง ุจุฑ ุฑู ุขู ุจูุง ฺฉูุฏ.

### ฺู ุฒูุงู ุงุฒ recording rules ุงุณุชูุงุฏู ฺฉูู

ููุงุฑุฏ ูุชุนุฏุฏ ูุฌูุฏ ุฏุงุฑุฏ ฺฉู ููฺฉู ุงุณุช ุจุฎูุงูุฏ ุงุฒ recording rules ุงุณุชูุงุฏู ฺฉูุฏ. recording rules ุนูุฏุชุงู ุจุฑุง ุชุฌูุน (aggregate) ูุชุฑฺฉโูุง ุจู ููุธูุฑ ฺฉุงุฑุขูุฏุชุฑ ฺฉุฑุฏู ฺฉูุฆุฑโูุง ุดูุง ุงุณุชูุงุฏู ูโุดููุฏ. ุงู ุงูุฑ ุจุฑุง ุฏุงุดุจูุฑุฏูุงุ ูุฏุฑุงุณูู (federation)ุ ู ูุจู ุงุฒ ุฐุฎุฑู ูุชุฑฺฉโูุง ุฏุฑ ุฐุฎุฑูโุณุงุฒ ุจููุฏูุฏุช (long-term storage) ุฑุงุฌ ุงุณุช. ููฺูู ููฺฉู ุงุณุช ุงุฒ recording rules ุจุฑุง ุชุฑฺฉุจ ุชูุงุจุน Range Vectorุ ู ฺฏุงู ุงููุงุช ุจุฑุง ุงุฑุงุฆู APIูุง ุงุฒ ูุชุฑฺฉโูุง ุจู ุชูโูุง ุฏฺฏุฑ ุงุณุชูุงุฏู ฺฉูุฏ.


-------

### ุงุฏุขูุฑ Cardinality

**ฺฉุงุฑุฏูุงูุช ุฏุฑ Prometheus ุจู ุชุนุฏุงุฏ ูุฌููุนูโูุง ุณุฑโูุง ุฒูุงู (Time Series) ููุญุตุฑ ุจู ูุฑุฏ ุฏุฑ ูพุงฺฏุงู ุฏุงุฏู ุขู ุงุดุงุฑู ุฏุงุฑุฏ.**

ูุฑ ฺู ฺฉุงุฑุฏูุงูุช ุจุงูุงุชุฑ ุจุงุดุฏุ Prometheus ุจุงุฏ ุณุฑโูุง ุฒูุงู ุจุดุชุฑ ุฑุง ุฐุฎุฑูุ ุงูุฏฺฉุณ ู ูพุฑุฏุงุฒุด ฺฉูุฏ.

---

##### ุชุดุฑุญ ุงุฌุฒุง ุชุดฺฉูโุฏููุฏู ฺฉุงุฑุฏูุงูุช

ุจุฑุง ุฏุฑฺฉ ฺฉุงููุ ุจุงุฏ ุจุจูู ฺฉ ุณุฑ ุฒูุงู ฺฺฏููู ุณุงุฎุชู ูโุดูุฏ. ูุฑ ุณุฑ ุฒูุงู ุจุง ุชุฑฺฉุจ **ูุงู ูุชุฑฺฉ (Metric Name)** ู **ุจุฑฺุณุจโูุง (Labels)** ุขู ุจู ุตูุฑุช ฺฉุชุง ุดูุงุณุง ูโุดูุฏ.

**ูุซุงู:**

ูุฑุถ ฺฉูุฏ ูุชุฑฺฉ ุจู ูุงู `http_requests_total` ุฏุงุฑู ฺฉู ุจุง ุจุฑฺุณุจโูุง `method` (ูุชุฏ HTTP) ู `endpoint` (ุขุฏุฑุณ ุฏุฑุฎูุงุณุช) ููุฑุงู ุงุณุช.

```prometheus
http_requests_total{method="GET", endpoint="/api/users"}
http_requests_total{method="GET", endpoint="/api/products"}
http_requests_total{method="POST", endpoint="/api/users"}
http_requests_total{method="POST", endpoint="/api/products"}
```

ุฏุฑ ุงู ูุซุงูุ ูุง ด ุณุฑ ุฒูุงู ูุชูุงูุช ุฏุงุฑู. ุญุงูุง ุชุตูุฑ ฺฉูุฏ:

*   ุงฺฏุฑ `endpoint`ูุง ุดูุง ุฒุงุฏ ุจุงุดุฏ (ูุซูุงู ุดุงูู `id` ฺฉุงุฑุจุฑ ุดูุฏ: `/api/users/123`, `/api/users/456` ู...).
*   ุง ุงฺฏุฑ ุจุฑฺุณุจ ุฏฺฏุฑ ูุซู `user_id` ุฑุง ูุณุชููุงู ุจู ูุชุฑฺฉ ุงุถุงูู ฺฉูุฏ.

ุฏุฑ ุงู ุตูุฑุชุ ุชุนุฏุงุฏ ุชุฑฺฉุจโูุง ููฺฉู ุจู ุณุฑุนุช ุงูุฒุงุด ุงูุชู ู **ฺฉุงุฑุฏูุงูุช ูููุฌุฑ ูโุดูุฏ**.

---

##### ฺุฑุง ฺฉุงุฑุฏูุงูุช ููู ุงุณุชุ (ุงุซุฑุงุช ฺฉุงุฑุฏูุงูุช ุจุงูุง)

ฺฉุงุฑุฏูุงูุช ุจุงูุง ูุณุชููุงู ุจุฑ ุนููฺฉุฑุฏ ู ุณูุงูุช Prometheus ุชุงุซุฑ ูโฺฏุฐุงุฑุฏ:

1.  **ูุตุฑู ุญุงูุธู (RAM) ุจุณุงุฑ ุจุงูุง:** Prometheus ุจุฑุง ูุฑ ุณุฑ ุฒูุงูุ ฺฉ ุงูุฏฺฉุณ ุฏุฑ ุญุงูุธู ุงุฌุงุฏ ูโฺฉูุฏ. ฺฉุงุฑุฏูุงูุช ุจุงูุง ุจุงุนุซ ูโุดูุฏ ุญุงูุธู RAM ุจู ุณุฑุนุช ูพุฑ ุดุฏู ู Prometheus ุจุง ุฎุทุง `Out Of Memory (OOM)` ฺฉุฑุด ฺฉูุฏ.
2.  **ุงูุช ุนููฺฉุฑุฏ (Performance):** ฺฉูุฆุฑโูุง (ูุฎุตูุตุงู ุขููุง ฺฉู ุงุฒ ุชูุงุจุน ูุซู `regex` ุฑู ุจุฑฺุณุจโูุง ุงุณุชูุงุฏู ูโฺฉููุฏ) ุฑู ุฏุงุฏูโูุง ุจุง ฺฉุงุฑุฏูุงูุช ุจุงูุง ุจุณุงุฑ ฺฉูุฏ ุงุฌุฑุง ูโุดููุฏ.
3.  **ูุตุฑู ุฏุณฺฉ ุจุงูุง:** ูุฑ ุณุฑ ุฒูุงู ุฏุงุฏู ุฐุฎุฑู ูโฺฉูุฏุ ุจูุงุจุฑุงู ฺฉุงุฑุฏูุงูุช ุจุงูุง ูุณุชูุฒู ูุถุง ุฐุฎุฑูโุณุงุฒ ุจุดุชุฑ ุงุณุช.

ฺฉ ฺฉุงุฑุฏูุงูุช ฺฉูุชุฑูโูุดุฏู ูโุชูุงูุฏ ุฏุฑ ุนุฑุถ ฺูุฏ ุฏููู ฺฉู ุณุฑูุฑ Prometheus ุฑุง ุงุฒ ฺฉุงุฑ ุจูุฏุงุฒุฏ.

---

##### ุนูุงูู ุฑุงุฌ ุงุฌุงุฏ ฺฉุงุฑุฏูุงูุช ุจุงูุง (Anti-patterns)

*   **ุงุณุชูุงุฏู ุงุฒ ุจุฑฺุณุจโูุง ฺฉู ููุงุฏุฑ ููุญุตุฑุจูโูุฑุฏ ุฒุงุฏ ุฏุงุฑูุฏ:**
    *   `user_id`
    *   `session_id`
    *   `ip_address` (ุฏุฑ ุตูุฑุช ฺฉู ุชุนุฏุงุฏ ุขูพโูุง ุจุณุงุฑ ุฒุงุฏ ุจุงุดุฏ)
    *   `request_id` ุง `trace_id`
    *   `error_message` (ุงฺฏุฑ ูุชู ุฎุทุง ฺฉุงูู ู ููุญุตุฑุจูโูุฑุฏ ุจุงุดุฏ)
*   **ุงุฌุงุฏ ูุชุฑฺฉโูุง ุฌุฏุฏ ุฏุฑ ุฏุงุฎู ุจุฑูุงูู:** ูุซูุงู ูุงู ูุชุฑฺฉ ุฑุง ุจุง ฺฉ `id` ุชุบุฑ ุฏูุฏ.
*   **ุงูุฒูุฏู ุจุฑฺุณุจ ุงุฒ ููุน ุชุงุฑุฎ/ุฒูุงู:** ูุซูุงู `date="2023-10-25"`. ุงู ุจุฑฺุณุจ ูุฑ ุฑูุฒ ุฌุฏุฏ ูโุดูุฏ ู ุณุฑโูุง ุฒูุงู ูุฏู ูุฑฺฏุฒ ุงุณุชูุงุฏู ููโุดููุฏ ุงูุง ุฏุฑ ุญุงูุธู ุจุงู ูโูุงููุฏ.

---

##### ฺฺฏููู ฺฉุงุฑุฏูุงูุช ุฑุง ูุฏุฑุช ู ฺฉูุชุฑู ฺฉููุ

1.  **ุทุฑุงุญ ุตุญุญ ูุชุฑฺฉโูุง ู ุจุฑฺุณุจโูุง (ูููุชุฑู ุฑุงูฺฉุงุฑ):**
    *   ุงุฒ ุจุฑฺุณุจโูุง ุจุฑุง ุงุจุนุงุฏ (dimensions) ุงุณุชูุงุฏู ฺฉูุฏ ฺฉู ููุงุฏุฑ ูุญุฏูุฏ ู ูุงุจู ุดูุงุฑุด ุฏุงุฑูุฏ (ูุงููุฏ `method=GET|POST|PUT|DELETE`ุ `status=200|404|500`ุ `endpoint=/api/users|/api/products`).
    *   ุงุฒ ุงุณุชูุงุฏู ุงุฒ ุจุฑฺุณุจ ุจุฑุง ููุงุฏุฑ ุจุง ฺฉุงุฑุฏูุงูุช ุจุงูุง (ูุงููุฏ `user_id`) ุจู ุดุฏุช **ุฎูุฏุฏุงุฑ ฺฉูุฏ**. ุจู ุฌุง ุขูุ ุงุฒ ุชูุงุจุน aggregate ูุงููุฏ `sum()`, `avg()`, `count()` ุงุณุชูุงุฏู ฺฉูุฏ. ูุซูุงู ุจู ุฌุง ุฑุฏุงุจ ุฏุฑุฎูุงุณุช ุจุฑุง ูุฑ ฺฉุงุฑุจุฑุ ุชุนุฏุงุฏ ฺฉู ุฏุฑุฎูุงุณุชโูุง ุง ูุงูฺฏู ูุชูุณ ุฑุง ูุญุงุณุจู ฺฉูุฏ.

2.  **ุงุณุชูุงุฏู ุงุฒ `rate()` ู `increase()`:** ููฺฏุงู ฺฉุงุฑ ุจุง ูุชุฑฺฉโูุง Counter (ูุงููุฏ ุชุนุฏุงุฏ ุฏุฑุฎูุงุณุชโูุง) ุชูุฑุจุงู ููุดู ุจุงุฏ ุงุฒ ุชุงุจุน `rate()` ุง `increase()` ุฏุฑ ฺฉูุฆุฑโูุง ุงุณุชูุงุฏู ฺฉูุฏ. ุงู ุชูุงุจุน ุฎูุฏ ุจู ูุฏุฑุช ฺฉุงุฑุฏูุงูุช ฺฉูฺฉ ูโฺฉููุฏ.

3.  **ููุชุฑ ฺฉุฑุฏู ูุชุฑฺฉโูุง ุฏุฑ ุณูุช ุงุฑุณุงู (Scrape):** ุจุง ุงุณุชูุงุฏู ุงุฒ `relabel_configs` ู ูุงููู `drop` ูโุชูุงูุฏ ูุชุฑฺฉโูุง ุง ุจุฑฺุณุจโูุง ุฎุงุต ุฑุง ฺฉู ฺฉุงุฑุฏูุงูุช ุงุฌุงุฏ ูโฺฉููุฏุ ุญุฐู ฺฉูุฏ.

4.  **ูุธุงุฑุช ุจุฑ ฺฉุงุฑุฏูุงูุช ุฎูุฏ Prometheus:** ูโุชูุงูุฏ ุงุฒ ฺฉูุฆุฑ ุฒุฑ ุจุฑุง ุฏุฏู ฑฐ ูุชุฑฺฉ ฺฉู ุจุดุชุฑู ฺฉุงุฑุฏูุงูุช ุฑุง ุงุฌุงุฏ ูโฺฉููุฏ ุงุณุชูุงุฏู ฺฉูุฏ:
    ```prometheus
    topk(10, count by (__name__)({__name__=~".+"}))
    ```
    ููฺูู ูุชุฑฺฉ `prometheus_tsdb_head_series` ุชุนุฏุงุฏ ฺฉู ุณุฑโูุง ุฒูุงู ุฑุง ูุดุงู ูโุฏูุฏ.

### ุฎูุงุตู

| ููููู | ุชูุถุญ |
| :--- | :--- |
| **ฺฉุงุฑุฏูุงูุช ูพุงู** | ุชุนุฏุงุฏ ฺฉู ุณุฑ ุฒูุงู ููุญุตุฑุจูโูุฑุฏ. ุนููฺฉุฑุฏ ุนุงู ู ูุตุฑู ููุงุจุน ฺฉู. |
| **ฺฉุงุฑุฏูุงูุช ุจุงูุง** | ุชุนุฏุงุฏ ุจุณุงุฑ ุฒุงุฏ ุณุฑ ุฒูุงู ููุญุตุฑุจูโูุฑุฏ. ููุฌุฑ ุจู ูุตุฑู RAM ุดุฏุฏุ ฺฉูุฏ ู ฺฉุฑุด ูโุดูุฏ. |
| **ุนูุช ุงุตู** | ุงุณุชูุงุฏู ุงุฒ ุจุฑฺุณุจโูุง ุจุง ููุงุฏุฑ ููุญุตุฑุจูโูุฑุฏ ุฒุงุฏ (ูุงููุฏ `id`ูุง). |
| **ุฑุงูฺฉุงุฑ ุงุตู** | ุทุฑุงุญ ููุดููุฏุงูู ูุชุฑฺฉโูุง ู ุงุณุชูุงุฏู ุงุฒ ุจุฑฺุณุจโูุง ุจุง ููุงุฏุฑ ูุญุฏูุฏ ู ูุงุจู ุดูุงุฑุด. |

ุฏุฑ ูุชุฌูุ ูุฏุฑุช ฺฉุงุฑุฏูุงูุช ฺฉ **ููุงุฑุช ุญุงุช** ุจุฑุง ูุฑ ุงุฏูู Prometheus ุงุณุช ู ููููุช ุดูุง ุฏุฑ ูุงูุชูุฑูฺฏ ุจู ุฏุฑฺฉ ู ฺฉูุชุฑู ุขู ุจุณุชฺฏ ุฏุงุฑุฏ.


### ฺฉุงูุด ฺฉุงุฑุฏูุงูุช (Reducing Cardinality)

ุงฺฏุฑ ุนุจุงุฑุช ูุงููุฏ ุฒุฑ ุฏุฑ ฺฉ ุฏุงุดุจูุฑุฏ ุฏุงุดุชู ุจุงุดุฏ:

`sum without(instance)(rate(process_cpu_seconds_total{job="node"}[5m]))`

ุฏุฑ ุตูุฑุช ฺฉู ุชุนุฏุงุฏ ฺฉู ูุฏู (target) ุฏุงุดุชู ุจุงุดุฏุ ูพุงุณุฎ ุณุฑุน ุงุฒ ูพุฑููุชุฆูุณ ุฏุฑุงูุช ุฎูุงูุฏ ฺฉุฑุฏ. ุจุง ุงูุฒุงุด ุชุนุฏุงุฏ ุงูุฏุงู ุจู ุตุฏูุง ู ูุฒุงุฑุงูุ ูุชูุฌู ุฎูุงูุฏ ุดุฏ ฺฉู ุฒูุงู ูพุงุณุฎ ุจุฑุง ฺฉ `query_range` ุฏฺฏุฑ ุจู ุขู ุณุฑุนุช ูุณุช. ุจู ุฌุง ุงูฺฉู ุงุฒ PromQL ุจุฎูุงูุฏ ุจู ูุฒุงุฑุงู ุณุฑ ุฒูุงู ุจุฑุง ฺฉู ุจุงุฒู ูุฑ ูููุฏุงุฑ ุฏุฑ ุฏุงุดุจูุฑุฏ ุดูุง ุฏุณุชุฑุณ ูพุฏุง ฺฉุฑุฏู ู ุขูโูุง ุฑุง ูพุฑุฏุงุฒุด ฺฉูุฏุ ูโุชูุงูุฏ ุงู ููุฏุงุฑ ุฑุง ุจุง ุงุณุชูุงุฏู ุงุฒ ฺฉ ฺฏุฑูู ูุงูููุ ูุงููุฏ ุฒุฑุ ุงุฒ ูพุด ูุญุงุณุจู ฺฉูุฏ:

```yaml
groups:
  - name: node
    rules:
      - record: job:process_cpu_seconds:rate5m
        expr: >
          sum without(instance)(
            rate(process_cpu_seconds_total{job="node"}[5m])
          )
```

ฺฉู ุฎุฑูุฌ ุขู ุจู ูุชุฑฺฉ ุจู ูุงู `job:process_cpu_seconds:rate5m` ุฎูุงูุฏ ุจูุฏ. ุงฺฉููู ููุท ฺฉุงู ุงุณุช ุขู ฺฉ ุณุฑ ุฒูุงู ุฑุง ููฺฏุงู ุฑูุฏุฑ ุดุฏู ุฏุงุดุจูุฑุฏ ุฎูุฏ ูุงฺฉุด ฺฉูุฏ. ููู ุงูุฑ ุญุช ุงฺฏุฑ ุจุฑฺุณุจโูุง ุงุจุฒุงุฑ ุฏููโุณุงุฒ (instrumentation labels) ุฏุฑ ฺฉุงุฑ ุจุงุดูุฏ ูุฒ ุตุงุฏู ุงุณุชุ ุฒุฑุง ุดูุง ุชุนุฏุงุฏ ุณุฑโูุง ุฒูุงู ูุงุจู ูพุฑุฏุงุฒุด ุฑุง ุจู ุงูุฏุงุฒู ุชุนุฏุงุฏ ูููููโูุง (instances) ุฎูุฏ ฺฉุงูุด ูโุฏูุฏ. ุฏุฑ ูุงูุนุ ุดูุง ุฏุฑ ุญุงู ูุนุงููู ฺฉ ูุฒูู ููุงุจุน ูุฏุงูู ุฏุฑ ุจุฑุงุจุฑ ุชุฃุฎุฑ (latency) ู ูุฒูู ููุงุจุน ุจุณุงุฑ ฺฉูุชุฑ ุจุฑุง ฺฉูุฆุฑโูุง ุฎูุฏ ูุณุชุฏ. ุจู ุฏูู ุงู ุจุฏูโุจุณุชุงู (trade-off)ุ ูุนูููุงู ุนุงููุงูู ูุณุช ฺฉู ููุงูู ุฏุงุดุชู ุจุงุดุฏ ฺฉู ุงุฒ ุจุงุฒูโูุง ูฺฉุชูุฑ ุทููุงู ุงุณุชูุงุฏู ูโฺฉููุฏุ ุฒุฑุง ฺูู ฺฉูุฆุฑโูุง ูุนูููุงู ูพุฑูุฒูู ูุณุชูุฏ ู ุงุฌุฑุง ููุธู ุขููุง ูโุชูุงูุฏ ุจุงุนุซ ูุดฺฉูุงุช ุนููฺฉุฑุฏ ุดูุฏ. ุจุงุฏ ุณุน ฺฉูุฏ ุชูุงู ููุงูู ูุฑุจูุท ุจู ฺฉ ฺฉุงุฑ (job) ุฑุง ุฏุฑ ฺฉ ฺฏุฑูู ูุฑุงุฑ ุฏูุฏ. ุจู ุงู ุชุฑุชุจุ ุขูโูุง ุฏุงุฑุง timestamp ฺฉุณุงู ุฎูุงููุฏ ุจูุฏ ู ููฺฏุงู ุงูุฌุงู ูุญุงุณุจุงุช ุจุดุชุฑ ุฑู ุขูโูุงุ ุงุฒ ุงุฌุงุฏ ูุตููุนุงุช (artifacts) ุฌููฺฏุฑ ูโุดูุฏ. ุชูุงู recording rules ุฏุฑ ฺฉ ฺฏุฑููุ ุฒูุงู ุงุฑุฒุงุจ ฺฉูุฆุฑ ฺฉุณุงู ุจุฑุง ฺฉ ุงุฌุฑุง ุฏุงุฑูุฏ ู ุชูุงู ูููููโูุง ุฎุฑูุฌ ูุฒ ุขู timestamp ุฑุง ุฎูุงููุฏ ุฏุงุดุช.

ูุชูุฌู ุฎูุงูุฏ ุดุฏ ฺฉู ููุงูู ุชุฌูุน ูุงููุฏ ุงูโูุงุ ูุฑุงุชุฑ ุงุฒ ุณุฑุนโุชุฑ ฺฉุฑุฏู ุฏุงุดุจูุฑุฏูุง ุดูุง ููุฏ ูุณุชูุฏ. ููฺฏุงู ุงุณุชูุงุฏู ุงุฒ ูุฏุฑุงุณููุ ููุดู ูโุฎูุงูุฏ ูุชุฑฺฉโูุง ุชุฌูุนโุดุฏู ุฑุง pull ฺฉูุฏุ ุฒุฑุง ุฏุฑ ุบุฑ ุงู ุตูุฑุชุ ุจุฎุดโูุง ุจุฒุฑฺฏ ุงุฒ ูุชุฑฺฉโูุง ุณุทุญ ููููู (instance-level) ุฑุง ูุงุฑุฏ ูโฺฉูุฏ. ุฏุฑ ุขู ููุทูุ ุงุฒ ุฏุฏฺฏุงู ุนููฺฉุฑุฏุ ุจุฑุง ูพุฑููุชุฆูุณ ฺฉู ุงุฒ ูุฏุฑุงุณูู ุงุณุชูุงุฏู ูโฺฉูุฏ ุจูุชุฑ ุงุณุช ฺฉู ุฎูุฏ ุงูุฏุงู ุฑุง ูุณุชููุงู ุฌูุนโุขูุฑ ฺฉูุฏ. ููุทู ูุดุงุจู ุฏุฑ ุตูุฑุช ฺฉู ุจุฎูุงูุฏ ุจุฑุฎ ูุชุฑฺฉโูุง ุฑุง ุจู ุตูุฑุช ุจููุฏูุฏุช ุฐุฎุฑู ฺฉูุฏ ูุฒ ุงุนูุงู ูโุดูุฏ. ููฺฏุงู ุงูุฌุงู ยซุจุฑูุงููโุฑุฒ ุธุฑูุชยป (capacity planning) ุจุฑ ุฑู ุฏุงุฏูโูุง ูุงูโูุง ุง ุณุงูโูุงุ ุฌุฒุฆุงุช ูููููโูุง ูููุฑุฏ ูุฑุชุจุท ูุณุชูุฏ. ุจุง ูฺฏูุฏุงุฑ ุนูุฏุชุงู ูุชุฑฺฉโูุง ุชุฌูุนโุดุฏู ุจู ุตูุฑุช ุจููุฏูุฏุชุ ูโุชูุงูุฏ ุจุง ุงุฒ ุฏุณุช ุฏุงุฏู ุงูุฏฺฉ ุงุทูุงุนุงุช ููุฏุ ููุงุจุน ุฒุงุฏ ุฑุง ุฐุฎุฑู ฺฉูุฏ.โต

ุงุบูุจ ููุงูู ุชุฌูุน ุจุฑ ุงุณุงุณ ููุงู ูุชุฑฺฉ ุงูุง ุจุง ูุฌููุนูโูุง ูุชูุงูุช ุงุฒ ุจุฑฺุณุจโูุง ุฎูุงูุฏ ุฏุงุดุช. ุจู ุฌุง ูุญุงุณุจู ูุฑ ุชุฌูุน ุจู ุตูุฑุช ุฌุฏุงฺฏุงููุ ูโุชูุงูุฏ ุจุง ุฏุงุดุชู ฺฉ ูุงููู ฺฉู ุงุฒ ุฎุฑูุฌ ูุงููู ุฏฺฏุฑ ุงุณุชูุงุฏู ูโฺฉูุฏุ ฺฉุงุฑุขูุฏ ุนูู ฺฉูุฏ. ูุซูุง:

```yaml
groups:
  - name: node
    rules:
      - record: job_device:node_disk_read_bytes:rate5m
        expr: >
          sum without(instance)(
            rate(node_disk_read_bytes_total{job="node"}[5m])
          )
      - record: job:node_disk_read_bytes:rate5m
        expr: >
          sum without(device)(
            job_device:node_disk_read_bytes:rate5m{job="node"}
          )
```

ุจุฑุง ุงูฺฉู ุงู ุจู ุฏุฑุณุช ฺฉุงุฑ ฺฉูุฏุ ููุงูู ุฏุฑ ฺฉ ุณูุณูู ูุฑุงุชุจ ูุนู ุจุงุฏ ุจู ุชุฑุชุจ ุฏุฑ ฺฉ ฺฏุฑูู ูุงููู ูุงุญุฏ ุจุงุดูุฏ. ุจู ุทูุฑ ฺฉู ุจูุชุฑ ุงุณุช ุจู ุตุฑุงุญุช ฺฉุงุฑ (job) ุฑุง ฺฉู ููุงูู ุดูุง ุจุฑุง ุขู ุงุนูุงู ูโุดููุฏ ุฏุฑ ุงูุชุฎุงุจฺฏุฑูุง (selectors) ุฎูุฏ ูุดุฎุต ฺฉูุฏุ ุชุง ฺฏุฑููโูุง ุดูุง ุฏุฑ ฺฉุงุฑ ฺฉุฏฺฏุฑ ุฏุฎุงูุช ูฺฉููุฏ.

### ุชุฑฺฉุจ  Range Vector Functions

ููโุชูุงูุฏ ุงุฒ ุชูุงุจุน Range Vector ุจุฑ ุฑู ุฎุฑูุฌ ุชูุงุจุน ฺฉู ูฺฉุชูุฑูุง ูุญุธูโุง (instant vectors) ุชููุฏ ูโฺฉููุฏุ ุงุณุชูุงุฏู ฺฉูุฏ. ุจู ุนููุงู ูุซุงูุ
 `max_over_time(sum without(instance)(rate(x_total[5m]))[1h])` 
 ุงูฺฉุงูโูพุฐุฑ ูุณุช ู ฺฉ ุฎุทุง ุชุฌุฒู (parse error) ุงุฌุงุฏ ูโฺฉูุฏ. ุฏุฑ ุญุงู ฺฉู PromQL ุฏุงุฑุง ยซุฒุฑฺฉูุฆุฑโูุงยป (subqueries) ุงุณุชุ ูโุชูุงูุฏ ุงุฒ recording rules ุจุฑุง ุฑุณุฏู ุจู ููู ูุชุฌู ุงุณุชูุงุฏู ฺฉูุฏ:

```yaml
groups:
  - name: j_job_rules
    rules:
      - record: job:x:rate5m
        expr: >
          sum without(instance)(
            rate(x_total{job="j"}[5m])
          )
      - record: job:x:max_over_time1h_rate5m
        expr: max_over_time(job:x:rate5m{job="j"}[1h])
```

ุงู ุฑูฺฉุฑุฏ ุฑุง ูโุชูุงู ุจุง ูุฑ ุชุงุจุน Range Vector ุงุณุชูุงุฏู ฺฉุฑุฏุ ุงุฒ ุฌููู ูู ุชููุง ุชูุงุจุน `_over_time` ุจูฺฉู `predict_linear`ุ `deriv` ู `holt_winters`. ุจุง ุงู ุญุงูุ ุงู ุชฺฉูฺฉ ูุจุงุฏ ุจุง `rate`ุ `irate` ุง `increase` ุงุณุชูุงุฏู ุดูุฏุ ุฒุฑุง ฺฉ ุนุจุงุฑุช ูุคุซุฑ ุงุฒ `rate(sum(x_total)[5m])` ูุฑ ุจุงุฑ ฺฉู ฺฉ ุงุฒ ุดูุงุฑูุฏูโูุง ุชุดฺฉูโุฏููุฏู ุขู ุจุงุฒูุดุงู (reset) ุง ูุงูพุฏุฏ ุดูุฏุ ุฌูุดโูุง ุนุธู ุฎูุงูุฏ ุฏุงุดุช.

**ููุดู ุงุจุชุฏุง `rate` ู ุณูพุณ `sum` ฺฉูุฏุ ูุฑฺฏุฒ ุงุจุชุฏุง `sum` ู ุณูพุณ `rate` ูฺฉูุฏ.**

ูุงุฒู ูุณุช ุชุงุจุน ุจุฑูู ุฑุง ุฏุฑ ฺฉ recording rule  ุฏุงุดุชู ุจุงุดุฏ. ุฏุฑ ูุซุงู ูุจูุ ููฺฉู ุงุณุช ููุทูโุชุฑ ุจุงุดุฏ ฺฉู `max_over_time` ุฑุง ุฒูุงู ฺฉู ุจู ุขู ูุงุฒ ุฏุงุฑุฏุ ุงูุฌุงู ุฏูุฏ. ุจู ุนููุงู ูุซุงูุ ฺฉุงุฑุจุฑุฏ ุงุตู ุงู ูุซุงู ุฎุงุตุ ุจุฑูุงููโุฑุฒ ุธุฑูุช ุฎูุงูุฏ ุจูุฏุ ุฒุฑุง ุดูุง ุจุงุฏ ุจุฑุง ุชุฑุงูฺฉ ุงูุฌ (peak) ุจู ุฌุง ูุงูฺฏู ุจุฑูุงููโุฑุฒ ฺฉูุฏ. ุงุฒ ุขูุฌุง ฺฉู ุจุฑูุงููโุฑุฒ ุธุฑูุช ุงุบูุจ ฺฉ ุจุงุฑ ุฏุฑ ูุงู ุง ฺฉ ุจุงุฑ ุฏุฑ ูุตู ุงูุฌุงู ูโุดูุฏุ ุงุฑุฒุงุจ `max_over_time` ุญุฏุงูู ฺฉ ุจุงุฑ ุฏุฑ ุฏูููุ ุจู ุฌุง ุงุฌุฑุง ฺฉูุฆุฑ ููุท ุฒูุงู ฺฉู ุจู ุขู ูุงุฒ ุฏุงุฑุฏุ ฺูุฏุงู ููุทู ูุณุช. ุชูุงุจุน ุฑู ุจุงุฒูโูุง ุฒูุงู ุทููุงูโุชุฑ ูุฒ ุจู ุฏูู ููุฏุงุฑ ุฏุงุฏูโุง ฺฉู ุจุงุฏ ูพุฑุฏุงุฒุด ฺฉููุฏุ ูโุชูุงููุฏ ูพุฑูุฒูู ุดููุฏ. ูุฑุงูุจ ุจุงุฒูโูุง ุจุด ุงุฒ ฺฉ ุณุงุนุช ู ุจูโูฺู ุฏุฑ ุชุนุฏุงุฏ ุฒุงุฏ ุณุฑ ุฒูุงู ุจุงุดุฏ.

### ููุงูู ุจุฑุง APIูุง (Rules for APIs)

ูุนูููุงู ุณุฑูุฑูุง ูพุฑููุชุฆูุณ ฺฉู ุดูุง ุงุฌุฑุง ูโฺฉูุฏุ ฺฉุงููุงู ุชูุณุท ุดูุง ู ุชูุชุงู ุงุณุชูุงุฏู ุฎูุงููุฏ ุดุฏ. ุงูุง ููฺฉู ุงุณุช ุจุง ูููุนุชโูุง ููุงุฌู ุดูุฏ ฺฉู ุชูโูุง ุฏฺฏุฑ ูุงู ุจู ุฏุฑุงูุช ูุชุฑฺฉโูุง ุงุฒ ูพุฑููุชุฆูุณ ุดูุง ุจุงุดูุฏ. ุงฺฏุฑ ุงุณุชูุงุฏู ุขูโูุง ุตุฑูุงู ุงุทูุงุนุงุช ุจุงุดุฏ ุง ุจู ูุชุฑฺฉโูุง ุจุณุชฺฏ ุฏุงุดุชู ุจุงุดุฏ ฺฉู ุจุนุฏ ุงุณุช ุชุบุฑ ฺฉููุฏุ ูุนูููุงู ูุดฺฉู ูุณุชุ ุฒุฑุง ุงฺฏุฑ ฺุฒ ุฑุง ุจุฑุง ุขูโูุง ุฎุฑุงุจ ฺฉูุฏุ ุขุฎุฑ ุฏูุง ูุณุช. ุงูุง ุงฺฏุฑ ูุชุฑฺฉโูุง ุจู ุนููุงู ุจุฎุด ุงุฒ ุณุณุชูโูุง ุง ูุฑุขูุฏูุง ุฎูุฏฺฉุงุฑ ุฎุงุฑุฌ ุงุฒ ฺฉูุชุฑู ุดูุง ุงุณุชูุงุฏู ูโุดููุฏุ ุงุฏู ุฎูุจ ุงุณุช ฺฉู ูุชุฑฺฉโูุง ุฑุง ููุท ุจุฑุง ูุตุฑู ุชูโูุง ุฏฺฏุฑ ุจู ุนููุงู ููุน API ุนููู ุงุฌุงุฏ ฺฉูุฏ. ุณูพุณ ุงฺฏุฑ ูุงุฒ ุจู ุชุบุฑ ุจุฑฺุณุจโูุง ุง ููุงูู ุฏุฑ ุฏุงุฎู ูพุฑููุชุฆูุณ ุฎูุฏ ุฏุงุดุชุฏุ ูโุชูุงูุฏ ุงู ฺฉุงุฑ ุฑุง ุงูุฌุงู ุฏูุฏุ ุฏุฑ ุญุงู ฺฉู ููฺูุงู ุงุทููุงู ุญุงุตู ูโฺฉูุฏ ฺฉู ูุชุฑฺฉโูุง ฺฉู ุชู ุฏฺฏุฑ ุจู ุขูโูุง ูุงุจุณุชู ุงุณุชุ ููุงู ูุนูุงุดูุงุณ (semantics) ุฑุง ุญูุธ ูโฺฉููุฏ. ูุงูโฺฏุฐุงุฑ ฺูู ูุชุฑฺฉโูุง ูุนูููุงู ุงุฒ ูุฑุงุฑุฏุงุฏูุง ูุงูโฺฏุฐุงุฑ ุนุงุฏ ูพุฑู ููโฺฉูุฏ ู ุดูุง ูุนูููุงู ูุงู ุชู ูุตุฑูโฺฉููุฏู ุฑุง ุง ุฏุฑ ูุงู ูุชุฑฺฉ ุง ุฏุฑ ฺฉ ุจุฑฺุณุจ ูุฑุงุฑ ูโุฏูุฏ. ฺูู ุงุณุชูุงุฏูโูุง ุงุฒ ููุงูู ุจุณุงุฑ ูุงุฏุฑ ุงุณุช. ุงฺฏุฑ ุงุณุชูุงุฏู ุชู ุฏฺฏุฑ ุงุฒ ูพุฑููุชุฆูุณ ุดูุง ุจู ูุฑุญููโุง ุจุฑุณุฏ ฺฉู ุจุงุฑ ูฺฏูุฏุงุฑ ุบุฑูุงุจู ุงุบูุงุถ ุฑุง ุจุฑ ุฏูุด ุดูุง ูุฑุงุฑ ุฏูุฏุ ููฺฉู ุงุณุช ุจุฎูุงูุฏ ุงุฒ ุขูโูุง ุจุฎูุงูุฏ ฺฉู ูพุฑููุชุฆูุณ ุฎูุฏ ุฑุง ุจุฑุง ูุชุฑฺฉโูุง ฺฉู ูุงุฒ ุฏุงุฑูุฏุ ุงุฌุฑุง ฺฉููุฏ.

### ฺฺฏููู ุงุฒ ููุงูู ุงุณุชูุงุฏู ูฺฉูู 

ูุง ูุชูุฌู ฺูุฏ ยซุถุฏุงูฺฏูยป (antipattern) ุฑุงุฌ ุฏุฑ ููุฑุฏ recording rules ุดุฏูโุงู ฺฉู ูโุฎูุงูู ุจู ุดูุง ุฏุฑ ุงุฌุชูุงุจ ุงุฒ ุขูโูุง ฺฉูฺฉ ฺฉูู. ุงููู ููุฑุฏุ ููุงูู ุงุณุช ฺฉู ูุฒุงุง ุจุฑฺุณุจโูุง ุฑุง ุงุฒ ุจู ูโุจุฑุฏ. ูุซูุง:

```yaml
- record: job_device:node_disk_read_bytes_sda:rate5m
  expr: >
    sum without(instance)(
      rate(node_disk_read_bytes_total{job="node",device="sda"}[5m])
    )
- record: job_device:node_disk_read_bytes_sdb:rate5m
  expr: >
    sum without(instance)(
      rate(node_disk_read_bytes_total{job="node",device="sdb"}[5m])
    )
```

ุงู ฺฉุงุฑ ูุณุชูุฒู ุขู ุงุณุช ฺฉู ุจู ุงุฒุง ูุฑ ุจุฑฺุณุจ `device` ุจุงููููุ ฺฉ ูุงููู ุฏุงุดุชู ุจุงุดุฏ ู ููโุชูุงูุฏ ุจู ุฑุงุญุช ุงู ูุชุฑฺฉโูุง ุฑุง ุชุฌูุน ฺฉูุฏ. ุงู ุงุณุงุณุงู ฺฉู ูุฏู ุจุฑฺุณุจโูุงุ ฺฉ ุงุฒ ูุฏุฑุชููุฏุชุฑู ูฺฺฏโูุง ูพุฑููุชุฆูุณุ ุฑุง ุงุฒ ุจู ูโุจุฑุฏ. ุจุงุฏ ุงุฒ ุงูุชูุงู ููุงุฏุฑ ุจุฑฺุณุจ ุจู ูุงู ูุชุฑฺฉโูุง ุฎูุฏุฏุงุฑ ฺฉูุฏุ ู ุงฺฏุฑ ูโุฎูุงูุฏ ุจุฑ ุงุณุงุณ ููุฏุงุฑ ฺฉ ุจุฑฺุณุจุ ุณุฑโูุง ุฒูุงู ุจุงุฒฺฏุดุช ุฑุง ูุญุฏูุฏ ฺฉูุฏุ ุงุฒ ฺฉ ยซุชุทุจูโุฏููุฏูยป (matcher) ุฏุฑ ุฒูุงู ฺฉูุฆุฑ ุงุณุชูุงุฏู ฺฉูุฏ. ุจู ุทูุฑ ูุดุงุจูุ ุจุฑฺุณุจ `job` ุฑุง ุจู ูุงู ูุชุฑฺฉ ููุชูู ูฺฉูุฏ.

ฺฉ ุถุฏุงูฺฏู ุฏฺฏุฑุ ูพุดโุชุฌูุน (preaggregating) ุชูุงู ูุชุฑฺฉโูุง ุงุณุช ฺฉู ฺฉ ุจุฑูุงูู ุงุฑุงุฆู ูโุฏูุฏ. ุฏุฑ ุญุงู ฺฉู ุฏุฑุณุช ุงุณุช ฺฉู ุชุฌูุน ุงุฏู ุฎูุจ ุจุฑุง ฺฉุงูุด ฺฉุงุฑุฏูุงูุช ุจู ููุธูุฑ ุจูุจูุฏ ุนููฺฉุฑุฏ ุงุณุชุ ุงูุง ุฒุงุฏูโุฑู ุฏุฑ ุขู ูุชุฌู ูุนฺฉูุณ ุฏุงุฑุฏ. ุฏุฑ ฺฉ ุณุณุชู ูุงูุชูุฑูฺฏ ูุจุชู ุจุฑ ูุชุฑฺฉุ ุบุฑูุนููู ูุณุช ฺฉู ูุฑฺฏุฒ ุจุด ุงุฒ นฐูช ุงุฒ ูุชุฑฺฉโูุง ุฎูุฏ ุฑุง ุงุณุชูุงุฏู ูฺฉูุฏุ ุจูุงุจุฑุงู ุชุฌูุน ููู ฺุฒ ุจู ุทูุฑ ูพุดโูุฑุถุ ุงุชูุงู ููุงุจุน ุงุณุช ู ุจุง ุงุถุงูู ู ุญุฐู ุดุฏู ูุชุฑฺฉโูุง ุฏุฑ ุทูู ุฒูุงูุ ูุงุฒ ุจู ูฺฏูุฏุงุฑ ุบุฑุถุฑูุฑ ุฎูุงูุฏ ุฏุงุดุช. ุฏุฑ ุนูุถุ ุจุงุฏ ุชุฌูุน ุฑุง ุฏุฑ ุตูุฑุช ูุงุฒ ุงุถุงูู ฺฉูุฏ. ุขู นฐูช ุฏฺฏุฑ ุงุฒ ูุชุฑฺฉโูุง ูููุฒ ุจุฑุง ุฒูุงู ฺฉู ุฏุฑ ุญุงู ุงุดฺฉุงูโุฒุฏุง (debugging) ฺฉ ูุดฺฉู ุนุฌุจ ุฏุฑ ุงุนูุงู ุณุณุชู ุฎูุฏ ูุณุชุฏุ ูุงุจู ุฏุณุชุฑุณ ูุณุชูุฏ ู ุชููุง ูุฒูู ุนุฏู ุชุฌูุน ุขูโูุง ุงู ุงุณุช ฺฉู ฺฉูุฆุฑโูุง ุดูุง ุฑู ุขูโูุง ฺฉู ุจุดุชุฑ ุทูู ูโฺฉุดุฏ.

ูุฏู ุงุตู recording rulesุ ฺฉุงูุด ฺฉุงุฑุฏูุงูุช ุงุณุชุ ุจูุงุจุฑุงู ุงุบูุจ ุฏูู ูุฏุงุฑุฏ ููุงูู ุฏุงุดุชู ุจุงุดุฏ ฺฉู ูููุฒ ุจุฑฺุณุจ `instance` ุฑุง ุฏุฑ ุฎุฑูุฌ ุฎูุฏ ุฏุงุฑูุฏ. ฺฉูุฆุฑ ฺฏุฑูุชู ุงุฒ ุฏู ุณุฑ ุฒูุงู ุฏุฑ ุฒูุงู ฺฉูุฆุฑุ ุจู ุทูุฑ ูุงุจู ุชูุฌู ูพุฑูุฒููโุชุฑ ุงุฒ ฺฉูุฆุฑ ฺฏุฑูุชู ุงุฒ ฺฉ ุณุฑ ุฒูุงู ูุณุช. ุงฺฏุฑ ูุชุฑฺฉโูุง ุจุง ฺฉุงุฑุฏูุงูุช ุจุงูุง ุฏุฑ ฺฉ ูุฏู ุฏุงุฑุฏุ recording rules ุจุง ุจุฑฺุณุจ `instance` ูโุชูุงููุฏ ููุทู ุจุงุดูุฏุ ุงฺฏุฑฺู ุจุงุฏ ุฏุฑ ูุธุฑ ุจฺฏุฑุฏ ฺฉู ุขุง ุขู ุจุฑฺุณุจโูุง ุงุจุฒุงุฑ ุฏููโุณุงุฒ (instrumentation labels) ุจุงุฏ ุจู ุฏูุงู ฺฉุงุฑุฏูุงูุช ุญุฐู ุดููุฏ ุง ุฎุฑ.

ุจุง ููุงูู ูุงููุฏ:
```yaml
- record: job:x:max_over_time1h_rate5m
  expr: max_over_time(job:x:rate5m{job="j"}[1h])
```
ุงุฒ ุจุฎุด ูุจูุ ููฺฉู ุงุณุช ูุณูุณู ุดูุฏ ฺฉู `evaluation_interval` ุขููุง ุฑุง ุจู ฺฉ ุณุงุนุช ุชุบุฑ ุฏูุฏ ุชุง ุฏุฑ ููุงุจุน ุตุฑููโุฌู ฺฉูุฏ. ุงู ุงุฏู ุฎูุจ ูุณุช ุจู ุณู ุฏูู. ุงููุ ุงุฒ ุขูุฌุง ฺฉู ูุชุฑฺฉ ูุฑูุฏ ุงุฒ ฺฉ ูุงููู ุถุจุท ุขูุฏู ฺฉู ูุจูุงู ฺฉุงุฑุฏูุงูุช ุฑุง ฺฉุงูุด ุฏุงุฏู ุงุณุชุ ูุฑฺฏููู ุตุฑููโุฌู ุฏุฑ ููุงุจุน ุงุญุชูุงูุงู ุฏุฑ ููุงุณ ุจุฒุฑฺฏ ูุงฺุฒ ุฎูุงูุฏ ุจูุฏ. ุฏููุ ูพุฑููุชุฆูุณ ููุท ุชุถูู ูโฺฉูุฏ ฺฉู ูุงููู ฺฉ ุจุงุฑ ุฏุฑ ุณุงุนุช ุงุฌุฑุง ูโุดูุฏุ ูู ุงูฺฉู ฺู ุฒูุงู ุฏุฑ ุขู ุณุงุนุช ุงุฌุฑุง ุฎูุงูุฏ ุดุฏ. ุงุฒ ุขูุฌุง ฺฉู ุดูุง ุงุญุชูุงูุงู ูุชุงุฌ ุฑุง ุฏุฑ ุญุฏูุฏ ุงุจุชุฏุง ุณุงุนุช ูโุฎูุงูุฏุ ุงูุ ููุฑุงู ุจุง ยซูุฏุฑุช ุฏุงุฏูโูุง ฺฉููู/ูููุถ ุดุฏูยป (staleness handling)ุ ฺฉุงุฑุณุงุฒ ูุฎูุงูุฏ ุจูุฏ. ุณููุ ุจุฑุง ุญูุธ ุณูุงูุช ุฑูุงู ุฎูุฏุ ุจุงุฏ ุชููุง ฺฉ ุจุงุฒู ุฒูุงู (interval) ุฏุฑ ุณุฑูุฑูุง ูพุฑููุชุฆูุณ ุฎูุฏ ุฏุงุดุชู ุจุงุดุฏ.

ุขุฎุฑู ุงูฺฏู ฺฉู ุชูุตู ูโฺฉูู ุงุฒ ุขู ุงุฌุชูุงุจ ฺฉูุฏุ ุงุณุชูุงุฏู ุงุฒ recording rules ุจุฑุง ุงุตูุงุญ ูุงูโูุง ู ุจุฑฺุณุจโูุง ูุงููุงุณุจ ูุชุฑฺฉโูุง ุงุณุช. ุงู ุงูฺฏู ูููุฑูุง ุฒูุงู ุงุตู ุฏุงุฏูโูุง ุฑุง ุงุฒ ุฏุณุช ูโุฏูุฏ ู ุชุดุฎุต ุงูฺฉู ฺฉ ูุชุฑฺฉ ุงุฒ ฺฉุฌุง ุขูุฏู ู ฺู ูุนูุง ุฏุงุฑุฏ ุฑุง ุฏุดูุงุฑุชุฑ ูโฺฉูุฏ. ุงุจุชุฏุงุ ุจุงุฏ ุณุน ฺฉูุฏ ูุชุฑฺฉโูุง ุฑุง ุฏุฑ ูุจุฏุฃ ุฎูุฏ ุจูุจูุฏ ุจุฎุดุฏุ ู ุงฺฏุฑ ุจู ุฏูุงู ูู ุง ุณุงุณ ุงู ุงูฺฉุงูโูพุฐุฑ ูุณุชุ ุฏุฑ ูุธุฑ ุจฺฏุฑุฏ ฺฉู ุขุง ุงุณุชูุงุฏู ุงุฒ `metric_relabel_configs`ุ ููุงูุทูุฑ ฺฉู ุฏุฑ ยซ`metric_relabel_configs`ยป ุฏุฑ ฺฏุฐุดุชู ุชูุถุญ ุฏุงุฏู ุดุฏู ุงุณุชุ ุจุฑุง ุจูุจูุฏ ุขูโูุง ุงุฑุฒุด ูุนุงุจ ูุชูุงูุช ุจูุฏูุดุงู ุงุฒ ุขูฺู ุฏฺฏุฑุงู ุงูุชุธุงุฑ ุฏุงุฑูุฏ ูุงูฺฏุฐุงุฑ ุดููุฏ ุฑุง ุฏุงุฑุฏ ุง ุฎุฑ. ูุชุฃุณูุงููุ ููุดู ููุงุฑุฏ ูุฌูุฏ ุฎูุงูุฏ ุฏุงุดุช ฺฉู ุณุณุชูโูุง ูุชุฑฺฉโูุง ุฑุง ุงุฑุงุฆู ูโุฏููุฏ ฺฉู ุจุด ุงุฒ ุญุฏ ุงุฒ ุฑูุด ุงูุฌุงู ฺฉุงุฑูุง ุฏุฑ ูพุฑููุชุฆูุณ ูุงุตูู ุฏุงุฑูุฏ ู ุดูุง ฺุงุฑูโุง ุฌุฒ ุงุตูุงุญ ุขูโูุง ุจู ูุฑ ุดฺฉู ฺฉู ูโุชูุงูุฏ ูุฏุงุฑุฏ.

### ูุงูโฺฏุฐุงุฑ recording rules 

ุจุง ุงุณุชูุงุฏู ุงุฒ ฺฉ ยซูุฑุงุฑุฏุงุฏยป (convention) ุฎูุจ ุจุฑุง ูุงูโฺฏุฐุงุฑ recording rulesุ ูู ุชููุง ูโุชูุงูุฏ ุจุง ฺฉ ูฺฏุงู ุจูููุฏ ฺฉู ูุงู ฺฉ ูุชุฑฺฉ ูุงููู ุถุจุท ูุนู ฺู ูุนูุง ุฏุงุฑุฏุ ุจูฺฉู ุจู ุฏูู ุฏุงุดุชู ฺฉ ูุงฺฺฏุงู ูุดุชุฑฺฉุ ุงุดุชุฑุงฺฉโฺฏุฐุงุฑ ููุงูู ุฎูุฏ ุจุง ุฏฺฏุฑุงู ูุฒ ุขุณุงูโุชุฑ ุฎูุงูุฏ ุจูุฏ. ููุงูุทูุฑ ฺฉู ุฏุฑ ยซฺู ูุงู ุจุฑุง ูุชุฑฺฉโูุงู ุงูุชุฎุงุจ ฺฉููุยป ุฏุฑ ฺฏุฐุดุชู ุฐฺฉุฑ ุดุฏุ ฺฉุงุฑุงฺฉุชุฑูุง ุฏู ููุทู (:) ุฏุฑ ูุงู ูุชุฑฺฉโูุง ูุนุชุจุฑ ูุณุชูุฏ ุงูุง ุจุงุฏ ุฏุฑ ยซุงุจุฒุงุฑ ุฏููโุณุงุฒยป (instrumentation) ุงุฒ ุขูโูุง ุงุฌุชูุงุจ ุดูุฏ. ุฏูู ุงู ุงูุฑ ุขู ุงุณุช ฺฉู ฺฉุงุฑุจุฑ ุจุชูุงูุฏ ุงุฒ ุขูโูุง ุจุฑุง ุงูุฒูุฏู ุณุงุฎุชุงุฑ ุฎูุฏ ุฏุฑ recording rules ุงุณุชูุงุฏู ฺฉูุฏ. ูุฑุงุฑุฏุงุฏ ฺฉู ูุง ุฏุฑ ุงูุฌุง ุงุณุชูุงุฏู ูโฺฉููุ ุชุนุงุฏู ุจู ุฏูุช ู ุงุฌุงุฒ (succinctness) ุจุฑูุฑุงุฑ ูโฺฉูุฏ ู ุญุงุตู ุณุงูโูุง ุชุฌุฑุจู ุงุณุช.

ุฑูุด ฺฉุงุฑ ุงู ูุฑุงุฑุฏุงุฏ ุจู ุงู ุตูุฑุช ุงุณุช ฺฉู ูุงู ูุชุฑฺฉโูุง ุดูุง ุดุงูู ุจุฑฺุณุจโูุง ุงุณุช ฺฉู ุฏุฑฺฏุฑ ูุณุชูุฏุ ุณูพุณ ูุงู ูุชุฑฺฉุ ู ุณูพุณ ุนููุงุช ฺฉู ุจุฑ ุฑู ูุชุฑฺฉ ุงูุฌุงู ุดุฏู ุงุณุช. ุงู ุณู ุจุฎุด ุจุง ุฏู ููุทู ุงุฒ ูู ุฌุฏุง ูโุดููุฏุ ุจูุงุจุฑุงู ุดูุง ููุดู ุง ุตูุฑ ุง ุฏู ุฏู ููุทู ุฏุฑ ูุงู ฺฉ ูุชุฑฺฉ ุฎูุงูุฏ ุฏุงุดุช. ุจู ุนููุงู ูุซุงูุ ุจุง ุชูุฌู ุจู ูุงู ูุชุฑฺฉ:

`job_device:node_disk_read_bytes:rate5m`

ูโุชูุงูู ุจฺฏูู ฺฉู ุฏุงุฑุง ุจุฑฺุณุจโูุง `job` ู `device` ุงุณุชุ ูุชุฑฺฉ ฺฉู ุจุฑ ุงุณุงุณ ุขู ุณุงุฎุชู ุดุฏู `node_disk_read_bytes` ุงุณุชุ ู ฺฉ ุดูุงุฑูุฏู (counter) ุงุณุช ฺฉู `rate(node_disk_read_bytes_total[5m])` ุฑู ุขู ุงุนูุงู ุดุฏู ุงุณุช. ุงู ุจุฎุดโูุง ุนุจุงุฑุชูุฏ ุงุฒ: ุณุทุญ (level)ุ ูุชุฑฺฉ (metric) ู ุนููุงุช (operations):

*   **ุณุทุญ (level)**
    ุณุทุญุ ูุฒุงู ุชุฌูุน ูุชุฑฺฉ ุฑุง ุจุฑ ุงุณุงุณ ุจุฑฺุณุจโูุง ฺฉู ุฏุงุฑุฏุ ูุดุงู ูโุฏูุฏ. ุงู ููุดู ุดุงูู ุจุฑฺุณุจโูุง ุงุจุฒุงุฑ ุฏููโุณุงุฒ (ุงฺฏุฑ ูููุฒ ุชุฌูุน ูุดุฏู ุจุงุดูุฏ)ุ ุจุฑฺุณุจ `job` ฺฉู ุจุงุฏ ูุฌูุฏ ุฏุงุดุชู ุจุงุดุฏุ ู ูุฑ ุจุฑฺุณุจ ูุฏู (target label) ุฏฺฏุฑ ฺฉู ูุฑุชุจุท ุงุณุชุ ุฎูุงูุฏ ุจูุฏ. ุงูฺฉู ฺฉุฏุงู ุจุฑฺุณุจโูุง ูุฏู ุฑุง ุดุงูู ุดูุฏุ ุจู ุฒููู ุจุณุชฺฏ ุฏุงุฑุฏ. ุงฺฏุฑ ฺฉ ุจุฑฺุณุจ `env` ุฏุฑ ุชูุงู ุงูุฏุงู ุฎูุฏ ุฏุงุฑุฏ ฺฉู ุจุฑ ููุงูู ุดูุง ุชุฃุซุฑ ููโฺฏุฐุงุฑุฏุ ูุงุฒ ุจู ุญุฌู ฺฉุฑุฏู ูุงู ูุชุฑฺฉโูุง ุฎูุฏ ุจุง ุขู ูุณุช. ุงูุง ุงฺฏุฑ ฺฉ ฺฉุงุฑ (job) ุจุง ฺฉ ุจุฑฺุณุจ `shard` ุชูุณู ุดุฏู ุจุงุดุฏุ ุงุญุชูุงูุงู ุจุงุฏ ุขู ุฑุง ุดุงูู ฺฉูุฏ.

*   **ูุชุฑฺฉ (metric)**
    ูุชุฑฺฉ ููุงู ูุงู ูุชุฑฺฉ ุง ุณุฑ ุฒูุงู ุงุณุช. ูุนูููุงู ุจุฑุง ุงุฌุงุฒ ุจุดุชุฑุ `_total` ุงุฒ ุดูุงุฑูุฏูโูุง ุญุฐู ูโุดูุฏุ ุงูุง ุฏุฑ ุบุฑ ุงู ุตูุฑุช ุงู ุจุงุฏ ุฏููุงู ูุงู ูุชุฑฺฉ ุจุงุดุฏ. ูุฒุช ุญูุธ ูุงู ูุชุฑฺฉ ุงู ุงุณุช ฺฉู ุฌุณุชุฌู ฺฉุฏุจุณ ุฎูุฏ ุจุฑุง ุขู ูุงู ูุชุฑฺฉ ุขุณุงู ูโุดูุฏุ ู ุจุฑุนฺฉุณ ุงฺฏุฑ ุฏุฑ ุญุงู ุจุฑุฑุณ ฺฉุฏ ุจุฑุง ุงูุชู ุงูฺฉู ุขุง ูุชุฑฺฉ ุชุฌูุน ุดุฏู ุงุณุช ุง ุฎุฑุ ูุฒ ููุฏ ุงุณุช. ุจุฑุง ูุณุจุชโูุง ุงุฒ `foo_per_bar` ุงุณุชูุงุฏู ูโฺฉูุฏุ ุงูุง ฺฉ ูุงููู ุฎุงุต ุจุฑุง ุจุฑุฎูุฑุฏ ุจุง ูุณุจุชโูุง `_sum` ู `_count` ูุฌูุฏ ุฏุงุฑุฏ.

*   **ุนููุงุช (operations)**
    ุนููุงุชุ ูุณุช ุงุฒ ุชูุงุจุน ู ุชุฌูุนโฺฉููุฏูโูุง (aggregators) ูุณุชูุฏ ฺฉู ุจุฑ ุฑู ูุชุฑฺฉ ุงุนูุงู ุดุฏูโุงูุฏุ ฺฉู ุขุฎุฑู ููุฑุฏ ุงูู ูโุขุฏ. ุงฺฏุฑ ุฏู ุนููุงุช `sum` ุง `max` ุฏุงุฑุฏุ ููุท ุจุงุฏ ฺฉ ุฑุง ูุณุช ฺฉูุฏุ ุฒุฑุง ุฌูุน ฺฉ ุฌูุน ูููุฒ ูู ฺฉ ุฌูุน ุงุณุช. ุงุฒ ุขูุฌุง ฺฉู `sum` ุชุฌูุน ูพุดโูุฑุถ ุงุณุชุ ูุนูููุงู ูุงุฒ ุจู ุฐฺฉุฑ ุขู ูุณุช. ุงูุง ุงฺฏุฑ ุนููุงุช ุฏฺฏุฑ ุจุฑุง ุงุณุชูุงุฏู ูุฏุงุฑุฏุ ุง ูููุฒ ูฺ ุนููุงุช ุงุนูุงู ูฺฉุฑุฏูโุงุฏุ `sum` ฺฉ ูพุดโูุฑุถ ุฎูุจ ุงุณุช. ุจุณุชู ุจู ุงูฺฉู ฺู ุนููุงุช ุฑุง ุฏุฑ ุณุทูุญ ุฏฺฏุฑ ุงุนูุงู ูโฺฉูุฏุ `min` ู `max` ูโุชูุงููุฏ ุจุฑุง ูุงู ูุชุฑฺฉ ูพุงู ููุทู ุจุงุดูุฏ. ุนููุงุช ฺฉู ุจุงุฏ ุจุฑุง ุชูุณู ุงุณุชูุงุฏู ฺฉูุฏ `ratio` ุงุณุช.

ุจุฑุง ูุซุงูุ ุงฺฏุฑ ฺฉ ุดูุงุฑูุฏู `foo_total` ุจุง ุจุฑฺุณุจ ุงุจุฒุงุฑ ุฏููโุณุงุฒ `bar` ุฏุงุดุชุฏุ ุชุฌูุน ุจุฑฺุณุจ `instance` ุจู ุงู ุดฺฉู ุฎูุงูุฏ ุจูุฏ:
```yaml
- record: job_bar:foo:rate5m
  expr: sum without(instance)(rate(foo_total{job="j"}[5m]))
```

ุงุฒ ุขูุฌุงุ ุจุฑุง ุชุฌูุน ุจุฑฺุณุจ `bar` ุจู ุงู ุดฺฉู ุฎูุงูุฏ ุจูุฏ:
```yaml
- record: job:foo:rate5m
  expr: sum without(bar)(job_bar:foo:rate5m{job="j"})
```

ูโุชูุงูุฏ ุจุฑุฎ ุงุฒ ูุฒุงุง ุงู ุฑูฺฉุฑุฏ ุฑุง ูุดุงูุฏู ฺฉูุฏ. ุงุฒ ุจุฑุฑุณ ุธุงูุฑ ูุดุฎุต ุงุณุช ฺฉู ูุฏุฑุช ุจุฑฺุณุจ ุฏุฑ ุงูุฌุง ููุงูุทูุฑ ฺฉู ุงูุชุธุงุฑ ูโุฑูุฏ ุงูุฌุงู ุดุฏู ุงุณุชุ ุฒุฑุง ุณุฑ ุฒูุงู ูุฑูุฏ `job_bar` ุฑุง ุจู ุนููุงู ุณุทุญ ุฏุงุดุชุ `bar` ุจุง ุงุณุชูุงุฏู ุงุฒ ุนุจุงุฑุช `without` ุญุฐู ุดุฏ ู ุฎุฑูุฌ `job` ุฑุง ุจู ุนููุงู ุณุทุญ ุฏุงุดุช. ุฏุฑ ููุงูู ู ุณูุณูู ูุฑุงุชุจ ูพฺุฏูโุชุฑุ ุงู ูโุชูุงูุฏ ุจุฑุง ุชุดุฎุต ุงุดุชุจุงูุงุช ููุฏ ุจุงุดุฏ. ุจู ุนููุงู ูุซุงูุ ูุงููู:

```yaml
- record: job:foo_per_bar:ratio_rate5m
  expr: >
    (
      job:foo:rate5m{job="j"}
      /
      job:bar:rate10m{job="j"}
    )
```
ุจู ูุธุฑ ูโุฑุณุฏ ุงุฒ ุทุฑุญ ูุงูโฺฏุฐุงุฑ ุจุฑุง ูุณุจุชโูุง ูพุฑู ูโฺฉูุฏุ ุงูุง ุจู `rate5m` ู `rate10m` ุนุฏู ุชุทุงุจู ูุฌูุฏ ุฏุงุฑุฏุ ฺฉู ุจุงุฏ ูุชูุฌู ุขู ุดูุฏ ู ุจูููุฏ ฺฉู ุงู ุนุจุงุฑุช ู ูุงููู ุถุจุท ุญุงุตู ุงุฒ ุขู ููุทู ูุณุช. ฺฉ ูุณุจุช ุตุญุญ ููฺฉู ุงุณุช ุจู ุงู ุดฺฉู ุจุงุดุฏ:

```yaml
- record: job_mountpoint:node_filesystem_avail_bytes_per_node_filesystem_size_bytes:ratio
  expr: >
    (
      job_mountpoint:node_filesystem_avail_bytes:sum{job="node"}
      /
      job_mountpoint:node_filesystem_size_bytes:sum{job="node"}
    )
```

ุฏุฑ ุงูุฌุง ูโุชูุงูุฏ ุจุจูุฏ ฺฉู ุตูุฑุช (numerator) ู ูุฎุฑุฌ (denominator) ุฏุงุฑุง ุณุทุญ ู ุนููุงุช ฺฉุณุงู ูุณุชูุฏ ฺฉู ุจู ูุงู ูุชุฑฺฉ ุฎุฑูุฌ ููุชูู ูโุดููุฏ.โธ ุฏุฑ ุงูุฌุง `sum` ุญุฐู ุดุฏู ุงุณุชุ ุฒุฑุง ฺุฒ ุจู ุดูุง ููโฺฏูุฏ. ุงฺฏุฑ ุนููุงุช `rate5m` ุฏุฑ ูุชุฑฺฉโูุง ูุฑูุฏ ูุฌูุฏ ุฏุงุดุชุ ุงูุทูุฑ ูุจูุฏ.

ุงุณุชูุงุฏู ุงุฒ ููุงุฏฺฏุฐุงุฑ ูุจู ุจุฑุง ูุงูฺฏู ุงูุฏุงุฒู ุฑูุฏุงุฏูุง ฺฉู ูพุฑุญุฑู ุฎูุงูุฏ ุจูุฏุ ุจูุงุจุฑุงู ุจู ุฌุง ุขู ูุงู ูุชุฑฺฉ ุญูุธ ุดุฏู ู `mean5m` ุจู ุนููุงู ุนููุงุช ุฎุฑูุฌ ุงุณุชูุงุฏู ูโุดูุฏ ุฒุฑุง ุจุฑ ุงุณุงุณ `rate5m` ุงุณุช ู ุจูุงุจุฑุงู ูุงูฺฏู ุฏุฑ ุทูู ต ุฏููู ุงุณุช:

```yaml
- record: job_instance:go_gc_duration_seconds:mean5m
  expr: >
    (
      job_instance:go_gc_duration_seconds_sum:rate5m{job="prometheus"}
      /
      job_instance:go_gc_duration_seconds_count:rate5m{job="prometheus"}
    )
```

ุงฺฏุฑ ุจุนุฏุงู ูุงููู ุฒุฑ ุฑุง ูุดุงูุฏู ฺฉุฑุฏุฏ:
```yaml
- record: job:go_gc_duration_seconds:mean5m
  expr:
    avg without(instance)(
      job_instance:go_gc_duration_seconds:mean5m{job="prometheus"}
    )
```
ุจูุงูุงุตูู ูุดุฎุต ุฎูุงูุฏ ุดุฏ ฺฉู ุงู ุฏุฑ ุชูุงุด ุงุณุช ุชุง ูุงูฺฏู ุงุฒ ฺฉ ูุงูฺฏู ุจฺฏุฑุฏุ ฺฉู ููุทู ูุณุช. ุชุฌูุน ุตุญุญ ุจู ุงู ุตูุฑุช ุฎูุงูุฏ ุจูุฏ:

```yaml
- record: job:go_gc_duration_seconds:mean5m
  expr: >
    (
      sum without(instance)(
        job_instance:go_gc_duration_seconds_sum:rate5m{job="prometheus"}
      )
      /
      sum without(instance)(
        job_instance:go_gc_duration_seconds_count:rate5m{job="prometheus"}
      )
    )
```
ุจุงุฏ ุจุฑุง ุชุฌูุน `sum` ฺฉูุฏ ู ุชูุณู ุจุฑุง ูุงูฺฏูโฺฏุฑ ุฑุง ุชููุง ุฏุฑ ุขุฎุฑู ูุฑุญูู ูุญุงุณุจู ุฎูุฏ ุงูุฌุงู ุฏูุฏ.

ุฏุฑ ุญุงู ฺฉู ููุงุฑุฏ ูุจู ุณุงุฏู ูุณุชูุฏุ ูุงููุฏ ูุงูโฺฏุฐุงุฑ ูุชุฑฺฉ ุจูโุทูุฑ ฺฉูุ ููฺฏุงู ฺฉู ุงุฒ ูุณุฑ ูุนููู ู ุดูุงุฎุชูโุดุฏู ุฎุงุฑุฌ ูโุดูุฏุ ูุงูโฺฏุฐุงุฑ recording rules ูโุชูุงูุฏ ุจุดุชุฑ ููุฑ ุจุงุดุฏ ุชุง ุนูู. ุจุงุฏ ุชูุงุด ฺฉูุฏ ุชุง ุงุทููุงู ุญุงุตู ฺฉูุฏ ฺฉู ูุงูโูุง recording rules ุดูุง ุงุฒ ูุธุฑ ูุนูุงุดูุงุณ ู ุจุฑฺุณุจโูุง ูุงุถุญ ูุณุชูุฏุ ุฏุฑ ุญุงู ฺฉู ููุฒูุงู ุณุน ูโฺฉูุฏ ุงุฑุชุจุงุท ูุงูโูุง recording rules ุจุง ฺฉุฏ ฺฉู ูุชุฑฺฉโูุง ุงุตู ุฑุง ุชููุฏ ฺฉุฑุฏู ุงุณุชุ ุขุณุงู ุจุงุดุฏ.

ุจู ุฌุฒ ููุงุฑุฏ ุจุณุงุฑ ูุงุฏุฑ (ุจู ยซููุงูู ุจุฑุง APIูุงยป )ุ ูุงูโูุง ูุชุฑฺฉ ุจุงุฏ ููุช ฺฉ ูุงู ูุชุฑฺฉ ุฑุง ูุดุงู ุฏููุฏ ุชุง ุจุชูุงูุฏ ุจุฏุงูุฏ ฺุณุช. ูุงูโูุง ูุชุฑฺฉ ูุจุงุฏ ุจู ุนููุงู ุฑุงู ุจุฑุง ุฐุฎุฑู ุญุงุดูโููุณโูุง (annotations) ุจุฑุง ุฎุทโูุด (policy) ุงุณุชูุงุฏู ุดููุฏ. ุจู ุนููุงู ูุซุงูุ ูุจุงุฏ ูุณูุณู ุดูุฏ ฺฉู `:federate` ุง `:longterm` ุง ููุงุฑุฏ ูุดุงุจู ุฑุง ุจู ูุงู ูุชุฑฺฉโูุง ุงุถุงูู ฺฉูุฏ ุชุง ูุดุงู ุฏูุฏ ฺฉู ูโุฎูุงูุฏ ููุงู ูุชุฑฺฉ ุจู ุณุณุชู ุฏฺฏุฑ ููุชูู ุดูุฏ. ุงู ฺฉุงุฑ ุจุงุนุซ ุญุฌู ุดุฏู ูุงู ูุชุฑฺฉโูุง ูโุดูุฏ ู ููฺฏุงู ฺฉู ุฎุทโูุด ุดูุง ุชุบุฑ ฺฉูุฏุ ูุดฺฉูุงุช ุงุฌุงุฏ ุฎูุงูุฏ ฺฉุฑุฏ. ุฏุฑ ุนูุถุ ุฎุทโูุด ุฎูุฏ ุฑุง ุงุฒ ุทุฑู ุชุทุจูโุฏููุฏูโูุง (matchers) ููฺฏุงู ุงุณุชุฎุฑุงุฌ ุฏุงุฏูโูุง ุชุนุฑู ู ูพุงุฏูโุณุงุฒ ฺฉูุฏุ ูุซูุงูุ ุชูุงู ูุงูโูุง ูุชุฑฺฉ ุฑุง ฺฉู ุจุง `job:.*` ูุทุงุจูุช ุฏุงุฑูุฏุ ูุงฺฉุด ฺฉูุฏุ ุจู ุฌุง ุงูฺฉู ุณุน ฺฉูุฏ ุฑู ุงูฺฉู ุฏููุงู ฺฉุฏุงู ูุชุฑฺฉโูุง ูุงฺฉุด ุดููุฏ ุง ูุดููุฏุ ุจูููโุณุงุฒ ุฌุฒุฆ (micro-optimize) ุงูุฌุงู ุฏูุฏ. ุชุง ุฒูุงู ฺฉู ฺฉ ูุชุฑฺฉ ุงุฒ ฺฉ ูุงููู ุถุจุท ุนุจูุฑ ฺฉุฑุฏู ุจุงุดุฏุ ุงุญุชูุงูุงู ุจู ุงูุฏุงุฒู ฺฉุงู ุชุฌูุน ุดุฏู ุงุณุช ฺฉู ฺฉุงุฑุฏูุงูุช ุขู ูุงฺุฒ ุจุงุดุฏุ ู ุจูุงุจุฑุงู ุงุญุชูุงูุงู ุงุฑุฒุด ููุช ุดูุง ุฑุง ูุฏุงุฑุฏ ฺฉู ูฺฏุฑุงู ูุฒููโูุง ููุงุจุน ุฏุฑ ูุฑุงุญู ุจุนุฏ ุจุงุดุฏ.

ุงฺฉููู ฺฉู ูโุฏุงูุฏ ฺฺฏููู ุงุฒ recording rules ุงุณุชูุงุฏู ฺฉูุฏุ ูุตู ุจุนุฏ ุจู ููุงูู ูุดุฏุงุฑุฏู ุฎูุงูุฏ ูพุฑุฏุงุฎุช. ููุงูู ูุดุฏุงุฑุฏู ูุฒ ุฏุฑ ฺฏุฑููโูุง ููุงูู ูุฑุงุฑ ูโฺฏุฑูุฏ ู ูุญู ูุดุงุจู ุฏุงุฑูุฏ.

---
ยน ุฏุฑ ูุชู ุงุตู "zero1" ุขูุฏู ฺฉู ุงุญุชูุงูุงู ุจู ฺฉ ูพุงูุฑู ุง ุงุฏุฏุงุดุช ุงุดุงุฑู ุฏุงุฑุฏ. ุฏุฑ ุชุฑุฌููุ "ุตูุฑ ุง ฺูุฏ" ููููู ุฑุง ูโุฑุณุงูุฏ.
ยฒ ุฏุฑ ูุชู ุงุตู "rules.2" ุขูุฏู ฺฉู ุงุญุชูุงูุงู ุจู ฺฉ ูพุงูุฑู ุง ุงุฏุฏุงุดุช ุงุดุงุฑู ุฏุงุฑุฏ.
ยณ ุงุนุฏุงุฏ ุตูุญุงุช ูุงููุฏ ฑดฒุ ณถฐุ ฑถดุ ถฐุ ณฐฒ ุจู ุตูุญุงุช ฺฉุชุงุจ ุงุตู ุงุดุงุฑู ุฏุงุฑูุฏ ู ุฏุฑ ุชุฑุฌูู ุญูุธ ุดุฏูโุงูุฏ.
