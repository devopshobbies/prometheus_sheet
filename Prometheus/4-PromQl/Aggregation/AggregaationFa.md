

ุดูุง ูุจูุงู ุฏุฑ ุจุฎุด ยซูุจุงู ุชุฌูุนยป (Aggregation Basics) ุจุง ููููู ุชุฌูุน ุขุดูุง ุดุฏุฏุ ุจุง ุงู ุญุงูุ ุงู ุชููุง ุจุฎุด ฺฉูฺฺฉ ุงุฒ ุงูฺฉุงูุงุช ููุฌูุฏ ุงุณุช. ุชุฌูุน ุงููุช ุฒุงุฏ ุฏุงุฑุฏ. ุฏุฑ ุจุฑูุงููโูุง ุจุง ูุฒุงุฑุงู ุง ุญุช ููุท ุฏูโูุง ููููู (instance)ุ ุจุฑุฑุณ ุฌุฏุงฺฏุงูู ูุชุฑฺฉโูุง ูุฑ ููููู ุนูู ูุณุช. ุชุฌูุน ุจู ุดูุง ุงูฺฉุงู ูโุฏูุฏ ูุชุฑฺฉโูุง ุฑุง ูู ุชููุง ุฏุฑ ฺฉ ุจุฑูุงููุ ุจูฺฉู ุฏุฑ ฺูุฏู ุจุฑูุงูู ูุฒ ุฎูุงุตู ฺฉูุฏ. ุฏุฑ PromQL ุฏูุงุฒุฏู ุนููฺฏุฑ ุชุฌูุน ูุฌูุฏ ุฏุงุฑุฏุ ุจู ููุฑุงู ุฏู ุจูุฏ (clause) ุงุฎุชุงุฑ: `without` ู `by`. ุฏุฑ ุงู ูุตู ุจุง ุฑูุดโูุง ูุฎุชูู ุงุณุชูุงุฏู ุงุฒ ุชุฌูุน ุขุดูุง ุฎูุงูุฏ ุดุฏ.

### ฺฏุฑููโุจูุฏ (Grouping)

ูพุด ุงุฒ ุตุญุจุช ุฏุฑ ููุฑุฏ ุฎูุฏู ุนููฺฏุฑูุง ุชุฌูุนุ ูุงุฒู ุงุณุช ุจุง ูุญูู ฺฏุฑููโุจูุฏ ุณุฑโูุง ุฒูุงู (time series) ุขุดูุง ุดูุฏ. ุนููฺฏุฑูุง ุชุฌูุน ููุท ุฑู ุจุฑุฏุงุฑูุง ูุญุธูโุง (instant vectors) ุนูู ูโฺฉููุฏ ู ุฎุฑูุฌ ุขูโูุง ูุฒ ุจุฑุฏุงุฑูุง ูุญุธูโุง ุงุณุช.
ุฏุฑ Prometheus ููููู **Grouping**ยุจู ูุนู ุฏุณุชูโุจูุฏ ุง ฺฏุฑููโุจูุฏ ุฏุงุฏูโูุง ูุชุฑฺฉ ุจุฑ ุงุณุงุณ ุจุฑฺุณุจโูุง (Labels) ุงุณุช. ุงู ููููู ูุนูููุงู ุฏุฑ ุฏู ุฒููู ุงุตู ุงุณุชูุงุฏู ูโุดูุฏ:
 ฑ.ย**Grouping ุฏุฑ ุฌูุนโุขูุฑ ุฏุงุฏูโูุง (Aggregation)**
 ฒ. **Grouping ุฏุฑ ุนููุงุช Join (ุฒูุงู ุงุฏุบุงู ูุชุฑฺฉโูุง)**
 
ูุฑุถ ฺฉูุฏ ุณุฑโูุง ุฒูุงู ุฒุฑ ุฑุง ุฏุฑ ูพุฑููุชุฆูุณ (Prometheus) ุฏุงุฑุฏ:

```json
node_filesystem_size_bytes{device="/dev/sda1",fstype="vfat",
instance="localhost:9100",job="node",mountpoint="/boot/efi"} 100663296
node_filesystem_size_bytes{device="/dev/sda5",fstype="ext4",
instance="localhost:9100",job="node",mountpoint="/"} 90131324928
node_filesystem_size_bytes{device="tmpfs",fstype="tmpfs",
instance="localhost:9100",job="node",mountpoint="/run"} 826961920
node_filesystem_size_bytes{device="tmpfs",fstype="tmpfs",
instance="localhost:9100",job="node",mountpoint="/run/lock"} 5242880
node_filesystem_size_bytes{device="tmpfs",fstype="tmpfs",
instance="localhost:9100",job="node",mountpoint="/run/user/1000"} 826961920
node_filesystem_size_bytes{device="tmpfs",fstype="tmpfs",
instance="localhost:9100",job="node",mountpoint="/run/user/119"} 826961920
```

ุณู ุจุฑฺุณุจ ุงุจุฒุงุฑุฏูู (instrumentation labels) ูุฌูุฏ ุฏุงุฑุฏ: `device`ุ `fstype` ู `mountpoint`. ููฺูู ุฏู ุจุฑฺุณุจ ูุฏู (target labels) ููุฌูุฏ ุงุณุช: `job` ู `instance`. ุจุฑฺุณุจโูุง ูุฏู ู ุงุจุฒุงุฑุฏูู ููููู ุงุณุช ฺฉู ูุง ู ุดูุง ุงุฒ ุขู ุขฺฏุงููุ ุงูุง PromQL ฺุฒ ุฏุฑุจุงุฑู ุขู ููโุฏุงูุฏ. ุงุฒ ุฏุฏ PromQLุ ุชูุงู ุจุฑฺุณุจโูุง ฺฉุณุงู ูุณุชูุฏุ ุตุฑูโูุธุฑ ุงุฒ ุงูฺฉู ุงุฒ ฺฉุฌุง ูุดุฃุช ฺฏุฑูุชูโุงูุฏ.


### ฑ. **Grouping ุฏุฑ ุฌูุนโุขูุฑ ุฏุงุฏูโูุง (Aggregation)**
   - ููุช ุงุฒ ุนููฺฏุฑูุง ุชุฌูุน ูุงููุฏ `sum()`ุ `avg()`ุ `min()`ุ `max()` ู ุบุฑู ุงุณุชูุงุฏู ูโฺฉูุฏุ ูโุชูุงูุฏ ุฏุงุฏูโูุง ุฑุง ุจุฑ ุงุณุงุณ ุจุฑฺุณุจโูุง ุฎุงุต **ฺฏุฑููโุจูุฏ (Group by)** ฺฉูุฏ.
   - ูุซุงู:
     ```promql
     sum(rate(http_requests_total[5m])) by (service, endpoint)
     ```
     ุงู ูพุฑุณุดุ ูุฒุงู ุฏุฑุฎูุงุณุชโูุง HTTP ุฑุง ุจุฑ ุงุณุงุณ `service` ู `endpoint` ฺฏุฑููโุจูุฏ ู ุฌูุน ูโุฒูุฏ.


### ฒ. **Grouping ุฏุฑ ุนููุงุช Join (ุฒูุงู ุงุฏุบุงู ูุชุฑฺฉโูุง)**
   - ููฺฏุงู ุงุณุชูุงุฏู ุงุฒ ุนููฺฏุฑูุง ุจุงูุฑ ูุงููุฏ `+`ุ `-`ุ `*`ุ `/` ู ุบุฑูุ Prometheus ุณุน ูโฺฉูุฏ ูุชุฑฺฉโูุง ูุชูุงุธุฑ ุฑุง ุจุฑ ุงุณุงุณ ุจุฑฺุณุจโูุงุดุงู ุชุทุจู ุฏูุฏ.
   - ุงฺฏุฑ ุจุฎูุงูุฏ ุจุฑุฎ ุจุฑฺุณุจโูุง ุฑุง ุฏุฑ ุชุทุจู ูุงุฏุฏู ุจฺฏุฑุฏุ ุงุฒ `ignoring()` ุงุณุชูุงุฏู ูโฺฉูุฏ:
     ```promql
     metric1{env="prod"} + ignoring(instance) metric2{env="prod"}
     ```
   - ุงฺฏุฑ ุจุฎูุงูุฏ ููุท ุจุฑฺุณุจโูุง ุฎุงุต ุฑุง ุฏุฑ ุชุทุจู ุฏุฑ ูุธุฑ ุจฺฏุฑุฏุ ุงุฒ `on()` ุงุณุชูุงุฏู ูโฺฉูุฏ:
     ```promql
     metric1{env="prod"} * on(service, endpoint) metric2{env="prod"}
     ```

## `without`

ูุนูููุงู ุดูุง ููุดู ุจุฑฺุณุจโูุง ุงุจุฒุงุฑุฏูู ุฑุง ูโุดูุงุณุฏุ ุฒุฑุง ุจูโูุฏุฑุช ุชุบุฑ ูโฺฉููุฏ. ุงูุง ููุดู ุงุฒ ุจุฑฺุณุจโูุง ูุฏูู ุฏุฑฺฏุฑ ุงุทูุงุน ูุฏุงุฑุฏุ ุฒุฑุง ุนุจุงุฑุช (expression) ฺฉู ูโููุณุฏ ููฺฉู ุงุณุช ุชูุณุท ุดุฎุต ุฏฺฏุฑ ุฑู ูุชุฑฺฉโูุง ุจุง ูพฺฉุฑุจูุฏโูุง scrape ูุชูุงูุช ุงุณุชูุงุฏู ุดูุฏุ ุง ุณุฑูุฑูุง ูพุฑููุชุฆูุณ ููฺฉู ุงุณุช ุจุฑฺุณุจโูุง ูุฏู ุฏฺฏุฑ ุฑุง ุฏุฑ ุณุทุญ ฺฉ `job` ุงุถุงูู ฺฉุฑุฏู ุจุงุดูุฏุ ูุงููุฏ ุจุฑฺุณุจ `env` ุง `cluster`. ุญุช ููฺฉู ุงุณุช ุฎูุฏุชุงู ุฏุฑ ููุทุน ฺูู ุจุฑฺุณุจโูุง ูุฏู ุงุถุงูู ฺฉูุฏ ู ุจูุชุฑ ุงุณุช ูุฌุจูุฑ ุจู ุจูโุฑูุฒุฑุณุงู ุชูุงู ุนุจุงุฑุงุช ุฎูุฏ ูุดูุฏ. ููฺฏุงู ุชุฌูุน ูุชุฑฺฉโูุงุ ูุนูููุงู ุจุงุฏ ุณุน ฺฉูุฏ ฺูู ุจุฑฺุณุจโูุง ูุฏู ุฑุง ุญูุธ ฺฉูุฏ ู ุจูุงุจุฑุงูุ ููฺฏุงู ุชุฌูุน ุจุงุฏ ุงุฒ ุจูุฏ `without` ุจุฑุง ูุดุฎุต ฺฉุฑุฏู ุจุฑฺุณุจโูุง ฺฉู ูโุฎูุงูุฏ ุญุฐู ุดููุฏุ ุงุณุชูุงุฏู ฺฉูุฏ. ุจุฑุง ูุซุงูุ ฺฉูุฆุฑ (query) ุฒุฑ:

`sum without(fstype, mountpoint)(node_filesystem_size_bytes)`

ุณุฑโูุง ุฒูุงู ุฑุง ุจุง ูุงุฏุฏู ฺฏุฑูุชู ุจุฑฺุณุจโูุง `fstype` ู `mountpoint`ุ ุจู ุณู ฺฏุฑูู ุฏุณุชูโุจูุฏ ูโฺฉูุฏ:

`node_filesystem_size_bytes`

```json
# Group {device="/dev/sda1",instance="localhost:9100",job="node"}
node_filesystem_size_bytes{device="/dev/sda1",fstype="vfat",
instance="localhost:9100",job="node",mountpoint="/boot/efi"} 100663296
# Group {device="/dev/sda5",instance="localhost:9100",job="node"}
node_filesystem_size_bytes{device="/dev/sda5",fstype="ext4",
instance="localhost:9100",job="node",mountpoint="/"} 90131324928
# Group {device="tmpfs",instance="localhost:9100",job="node"}
node_filesystem_size_bytes{device="tmpfs",fstype="tmpfs",
instance="localhost:9100",job="node",mountpoint="/run"} 826961920
node_filesystem_size_bytes{device="tmpfs",fstype="tmpfs",
instance="localhost:9100",job="node",mountpoint="/run/lock"} 5242880
node_filesystem_size_bytes{device="tmpfs",fstype="tmpfs",
instance="localhost:9100",job="node",mountpoint="/run/user/1000"} 826961920
node_filesystem_size_bytes{device="tmpfs",fstype="tmpfs",
instance="localhost:9100",job="node",mountpoint="/run/user/119"} 826961920
```

ู ุนููฺฏุฑ ุชุฌูุน `sum` ุฏุฑ ูุฑ ฺฉ ุงุฒ ุงู ฺฏุฑููโูุง ุงุนูุงู ูโุดูุฏุ ููุงุฏุฑ ุณุฑโูุง ุฒูุงู ุฑุง ุฌูุน ฺฉุฑุฏู ู ฺฉ ููููู ุจู ุงุฒุง ูุฑ ฺฏุฑูู ุจุฑูโฺฏุฑุฏุงูุฏ:

```sh
{device="/dev/sda1",instance="localhost:9100",job="node"} 100663296
{device="/dev/sda5",instance="localhost:9100",job="node"} 90131324928
{device="tmpfs",instance="localhost:9100",job="node"} 2486128640
```

ุชูุฌู ุฏุงุดุชู ุจุงุดุฏ ฺฉู ุจุฑฺุณุจโูุง `instance` ู `job` ุญูุธ ูโุดููุฏุ ููุงูุทูุฑ ฺฉู ูุฑ ุจุฑฺุณุจ ุฏฺฏุฑ ฺฉู ูุฌูุฏ ุฏุงุดุชุ ุญูุธ ูโุดุฏ. ุงู ููุฏ ุงุณุช ุฒุฑุง ูุฑ ูุดุฏุงุฑ ฺฉู ุงุฌุงุฏ ฺฉุฑุฏูโุงุฏ ู ุจู ููุน ุดุงูู ุงู ุนุจุงุฑุช ุจูุฏูุ ุจุฑฺุณุจโูุง ูุฏู ุงุถุงู ูุงููุฏ `env` ุง `cluster` ุฑุง ุญูุธ ูโฺฉูุฏ. ุงู ุจู ูุดุฏุงุฑูุง ุดูุง ุฒููู (context) ูโุฏูุฏ ู ุขููุง ุฑุง ููุฏุชุฑ ูโฺฉูุฏ (ููฺูู ุจุฑุง ุฑุณู ูููุฏุงุฑ ูุฒ ููุฏ ุงุณุช). ูุงู ูุชุฑฺฉ ูุฒ ุญุฐู ุดุฏู ุงุณุชุ ุฒุฑุง ุงู ุชุฌูุน ุงุฒ ูุชุฑฺฉ `node_filesystem_size_bytes` ุงุณุช ู ูู ุฎูุฏ ูุชุฑฺฉ ุงุตู. ููุช ฺฉ ุนููฺฏุฑ ุง ุชุงุจุน PromQL ูโุชูุงูุฏ ููุฏุงุฑ ุง ูุนูุง ฺฉ ุณุฑ ุฒูุงู ุฑุง ุชุบุฑ ุฏูุฏุ ูุงู ูุชุฑฺฉ ุญุฐู ูโุดูุฏ.

ุงุฑุงุฆู ูฺฉุฑุฏู ูฺ ุจุฑฺุณุจ ุจู `without` ูุนุชุจุฑ ุงุณุช. ุจุฑุง ูุซุงู:
`sum without()(node_filesystem_size_bytes)`
ููุงู ูุชุฌูโุง ุฑุง ุจู ุดูุง ูโุฏูุฏ ฺฉู:
`node_filesystem_size_bytes`
ุจุง ุงู ุชูุงูุช ฺฉู ูุงู ูุชุฑฺฉ ุญุฐู ุดุฏู ุงุณุช.

## `by`

ุนูุงูู ุจุฑ `without`ุ ุจูุฏ `by` ูุฒ ูุฌูุฏ ุฏุงุฑุฏ. ุฏุฑุญุงูโฺฉู `without` ุจุฑฺุณุจโูุง ูุงุจู ุญุฐู ุฑุง ูุดุฎุต ูโฺฉูุฏุ `by` ุจุฑฺุณุจโูุง ุฑุง ฺฉู ุจุงุฏ ุญูุธ ุดููุฏุ ูุดุฎุต ูโฺฉูุฏ. ุจูุงุจุฑุงูุ ููฺฏุงู ุงุณุชูุงุฏู ุงุฒ `by` ุจุงุฏ ุฏูุช ฺฉุฑุฏ ุชุง ุจุฑฺุณุจโูุง ูุฏู ุฑุง ฺฉู ูุงูุฏ ุฏุฑ ูุดุฏุงุฑูุง ููุชุดุฑ ุดููุฏ ุง ุฏุฑ ุฏุงุดุจูุฑุฏูุงุชุงู ุงุณุชูุงุฏู ฺฉูุฏุ ุญุฐู ูฺฉูุฏ. ููโุชูุงูุฏ ููุฒูุงู ุงุฒ `by` ู `without` ุฏุฑ ฺฉ ุชุฌูุน ุงุณุชูุงุฏู ฺฉูุฏ.

ฺฉูุฆุฑ ุฒุฑ:

`sum by(job, instance, device)(node_filesystem_size_bytes)`

ููุงู ูุชุฌูโุง ุฑุง ุชููุฏ ูโฺฉูุฏ ฺฉู ฺฉูุฆุฑ ุจุฎุด ูุจู ุจุง ุงุณุชูุงุฏู ุงุฒ `without` ุชููุฏ ฺฉุฑุฏ:

```json
{device="/dev/sda1",instance="localhost:9100",job="node"} 100663296
{device="/dev/sda5",instance="localhost:9100",job="node"} 90131324928
{device="tmpfs",instance="localhost:9100",job="node"} 2486128640
```

ุจุง ุงู ุญุงูุ ุงฺฏุฑ `instance` ุง `job` ูุดุฎุต ูุดุฏู ุจูุฏูุฏุ ฺฏุฑูู ุฑุง ุชุนุฑู ููโฺฉุฑุฏูุฏ ู ุฏุฑ ุฎุฑูุฌ ูุฒ ูุฌูุฏ ูุฏุงุดุชูุฏ. ุจู ููู ุฏููุ ุนูููุงู ุจุงุฏ ุงุณุชูุงุฏู ุงุฒ `without` ุฑุง ุจู `by` ุชุฑุฌุญ ุฏูุฏ.

ุฏู ุญุงูุช ูุฌูุฏ ุฏุงุฑุฏ ฺฉู ููฺฉู ุงุณุช `by` ุฑุง ููุฏุชุฑ ุจุงุจุฏ. ุงููู ููุฑุฏ ุงู ุงุณุช ฺฉู ุจุฑุฎูุงู `without`ุงุณุชูุงุฏู ุงุฒ `by` ุฏุฑ ุตูุฑุช ูุดุฎุต ุดุฏู ุตุฑุญุ ุจุฑฺุณุจ `__name__` ุฑุง ุญูุธ ูโฺฉูุฏ. ุงู ุจู ุดูุง ุงูฺฉุงู ูโุฏูุฏ ุงุฒ ุนุจุงุฑุงุช ูุงููุฏ ุฒุฑ ุจุฑุง ุจุฑุฑุณ ุงูฺฉู ฺู ุชุนุฏุงุฏ ุณุฑ ุฒูุงู ูุงูโูุง ูุชุฑฺฉ ฺฉุณุงู ุฏุงุฑูุฏุ ุงุณุชูุงุฏู ฺฉูุฏ:

`sort_desc(count by(__name__)({__name__=~".+"}))`

ุฏููู ููุฑุฏุ ุญุงูุงุช ุงุณุช ฺฉู ูโุฎูุงูุฏ ูุฑ ุจุฑฺุณุจ ุฑุง ฺฉู ููโุดูุงุณุฏ ุญุฐู ฺฉูุฏ. ุจุฑุง ูุซุงูุ ูุชุฑฺฉโูุง ุงุทูุงุนุงุช (info metrics)ุ ุงูุชุธุงุฑ ูโุฑูุฏ ุจุง ฺฏุฐุดุช ุฒูุงู ุจุฑฺุณุจโูุง ุจุดุชุฑ ุจู ุขูโูุง ุงุถุงูู ุดูุฏ. ุจุฑุง ุดูุงุฑุด ุชุนุฏุงุฏ ูุงุดูโูุง ฺฉู ูุฑ ูุณุฎู ฺฉุฑูู ุฑุง ุงุฌุฑุง ูโฺฉุฑุฏูุฏุ ูโุชูุงูุฏ ุงุฒ ุงู ุฏุณุชูุฑ ุงุณุชูุงุฏู ฺฉูุฏ:

`count by(release)(node_uname_info)`

ฺฉู ุฏุฑ ุชูุธูุงุช ุชุณุช ุชฺฉ ูุงุดู ูุงุ ูุชุฌู ุฒุฑ ุฑุง ุจุฑูโฺฏุฑุฏุงูุฏ:

`sum by()(node_filesystem_size_bytes)`

ู:

`sum(node_filesystem_size_bytes)`

ุฏููุงู ูุนุงุฏู ูุณุชูุฏ ู ูุชุฌูโุง ูุงููุฏ ุฒุฑ ุฎูุงููุฏ ุฏุงุฏ:

`{} 92718116864`

ุงู ฺฉ ุณุฑ ุฒูุงู ูุงุญุฏ ุงุณุช ู ุขู ุณุฑ ุฒูุงู ูฺ ุจุฑฺุณุจ ูุฏุงุฑุฏ.
ุงฺฏุฑ ุนุจุงุฑุช ุฒุฑ ุฑุง ุงุฌุฑุง ฺฉูุฏ:

`sum(non_existent_metric)`

ูุชุฌู ฺฉ ุจุฑุฏุงุฑ ูุญุธูโุง ุจุฏูู ูฺ ุณุฑ ุฒูุงู ุฎูุงูุฏ ุจูุฏ ฺฉู ุฏุฑ ุชุจ Console ูุฑูุฑฺฏุฑ ุนุจุงุฑุงุช ุจู ุตูุฑุช ยซno dataยป (ุฏุงุฏูโุง ูุฌูุฏ ูุฏุงุฑุฏ) ููุงุด ุฏุงุฏู ูโุดูุฏ.

ุงฺฏุฑ ูุฑูุฏ ฺฉ ุนููฺฏุฑ ุชุฌูุนุ ฺฉ ุจุฑุฏุงุฑ ูุญุธูโุง ุฎุงู ุจุงุดุฏุ ุฎุฑูุฌ ุขู ูุฒ ฺฉ ุจุฑุฏุงุฑ ูุญุธูโุง ุฎุงู ุฎูุงูุฏ ุจูุฏ. ุจูุงุจุฑุงูุ `count by(foo)(non_existent_metric)` ุจู ุฌุง 0 ุฎุงู ุฎูุงูุฏ ุจูุฏุ ุฒุฑุง `count` ู ุณุงุฑ ุชุฌูุนโฺฉููุฏูโูุง ูฺ ุจุฑฺุณุจ ุจุฑุง ฺฉุงุฑ ุจุง ุขู ูุฏุงุฑูุฏ. `count(non_existent_metric)` ุจุง ุงู ููุถูุน ุณุงุฒฺฏุงุฑ ุงุณุช ู ููฺูู ฺฉ ุจุฑุฏุงุฑ ูุญุธูโุง ุฎุงู ุจุฑูโฺฏุฑุฏุงูุฏ.

## ุนููฺฏุฑูุง (Operators)

ุชูุงู ฑฑ ุนููฺฏุฑ ุชุฌูุน ุงุฒ ููุทู ฺฏุฑููโุจูุฏ ฺฉุณุงู ุงุณุชูุงุฏู ูโฺฉููุฏ. ุดูุง ูโุชูุงูุฏ ุงู ุฑุง ุจุง ฺฉ ุงุฒ ุจูุฏูุง `without` ุง `by` ฺฉูุชุฑู ฺฉูุฏ. ุชูุงูุช ุจู ุนููฺฏุฑูุง ุชุฌูุน ุฏุฑ ฺฉุงุฑ ุงุณุช ฺฉู ุจุง ุฏุงุฏูโูุง ฺฏุฑููโุจูุฏ ุดุฏู ุงูุฌุงู ูโุฏููุฏ.

### `sum`

ููุฑุฏ `sum` ุฑุงุฌโุชุฑู ุนููฺฏุฑ ุชุฌูุน ุงุณุชุ ุงู ุนููฺฏุฑ ุชูุงู ููุงุฏุฑ ููุฌูุฏ ุฏุฑ ฺฉ ฺฏุฑูู ุฑุง ุฌูุน ฺฉุฑุฏู ู ุขู ุฑุง ุจู ุนููุงู ููุฏุงุฑ ฺฏุฑูู ุจุฑูโฺฏุฑุฏุงูุฏ. ุจุฑุง ูุซุงู:

`sum without(fstype, mountpoint, device)(node_filesystem_size_bytes)`

ุงูุฏุงุฒู ฺฉู ูุงูโุณุณุชูโูุง ูุฑ ฺฉ ุงุฒ ูุงุดูโูุง ุดูุง ุฑุง ุจุฑูโฺฏุฑุฏุงูุฏ. ููฺฏุงู ฺฉุงุฑ ุจุง ุดูุงุฑูุฏูโูุง (counters)ุ  ููู ุงุณุช ฺฉู ูุจู ุงุฒ ุชุฌูุน ุจุง `sum`ุ ูุฑุฎ (rate) ุฑุง ูุญุงุณุจู ฺฉูุฏ:

`sum without(device)(rate(node_disk_read_bytes_total[5m]))`

ุงฺฏุฑ ูุณุชููุงู ุฑู ุดูุงุฑูุฏูโูุง ุงุฒ `sum` ุงุณุชูุงุฏู ฺฉูุฏุ ูุชุฌู ุจโูุนู ุฎูุงูุฏ ุจูุฏุ ุฒุฑุง ุดูุงุฑูุฏูโูุง ูุฎุชูู ููฺฉู ุงุณุช ุจุณุชู ุจู ุฒูุงู ุดุฑูุน ุง ุฑุงูโุงูุฏุงุฒ ูุฌุฏุฏ ุงฺฉุณูพูุฑุชุฑุ ุง ุงููู ุจุงุฑ ฺฉู ูุฑ ฺฉ ุงุฒ ูุฑุฒูุฏุงู (children) ุฎุงุต ุงุณุชูุงุฏู ุดุฏูโุงูุฏุ ุฏุฑ ุฒูุงูโูุง ูุชูุงูุช ููุฏุงุฑุฏู ุงููู ุดุฏู ุจุงุดูุฏ.

### `count`

ุนููฺฏุฑ `count` ุชุนุฏุงุฏ ุณุฑโูุง ุฒูุงู ุฏุฑ ฺฉ ฺฏุฑูู ุฑุง ุดูุงุฑุด ฺฉุฑุฏู ู ุขู ุฑุง ุจู ุนููุงู ููุฏุงุฑ ฺฏุฑูู ุจุฑูโฺฏุฑุฏุงูุฏ. ุจุฑุง ูุซุงู:

`count without(device)(node_disk_read_bytes_total)`

ุชุนุฏุงุฏ ุฏุณุชฺฏุงูโูุง ุฏุณฺฉ ฺฉ ูุงุดู ุฑุง ุจุฑูโฺฏุฑุฏุงูุฏ. ูุงุดู ูุง ููุท ฺฉ ุฏุณฺฉ ุฏุงุฑุฏุ ุจูุงุจุฑุงู ูุชุฌู ูโฺฏุฑู:

`{instance="localhost:9100",job="node"} 1`

ุฏุฑ ุงูุฌุง ูุดฺฉู ูุณุช ฺฉู ุงุฒ `rate` ุจุง ฺฉ ุดูุงุฑูุฏู ุงุณุชูุงุฏู ูฺฉูุฏุ ุฒุฑุง ุดูุง ุจู ูุฌูุฏ ุณุฑ ุฒูุงู ุงููุช ูโุฏูุฏ ูู ููุฏุงุฑ ุขู.

### ููุงุฏุฑ ููุญุตุฑุจูโูุฑุฏ ุจุฑฺุณุจ (Unique label values)

ููฺูู ูโุชูุงูุฏ ุงุฒ `count` ุจุฑุง ุดูุงุฑุด ุชุนุฏุงุฏ ููุงุฏุฑ ููุญุตุฑุจูโูุฑุฏ ฺฉ ุจุฑฺุณุจ ุงุณุชูุงุฏู ฺฉูุฏ. ุจุฑุง ูุซุงูุ ุจุฑุง ุดูุงุฑุด ุชุนุฏุงุฏ CPUูุง ุฏุฑ ูุฑ ฺฉ ุงุฒ ูุงุดูโูุงุชุงูุ ูโุชูุงูุฏ ุงุฒ ุฏุณุชูุฑ ุฒุฑ ุงุณุชูุงุฏู ฺฉูุฏ:

`count without(cpu)(count without (mode)(node_cpu_seconds_total))`

ุงู `count` ุฏุงุฎูุ ุจุฑฺุณุจ ุงุจุฒุงุฑุฏูู ุฏฺฏุฑ ุนู `mode` ุฑุง ุญุฐู ูโฺฉูุฏ ู ุจู ุงุฒุง ูุฑ CPU ุฏุฑ ูุฑ ูููููุ ฺฉ ุณุฑ ุฒูุงู ุจุฑูโฺฏุฑุฏุงูุฏ:

```json
{cpu="0",instance="localhost:9100",job="node"} 8
{cpu="1",instance="localhost:9100",job="node"} 8
{cpu="2",instance="localhost:9100",job="node"} 8
{cpu="3",instance="localhost:9100",job="node"} 8
```

ุณูพุณ `count` ุจุฑูู ุชุนุฏุงุฏ CPUูุง ูุฑ ููููู ุฑุง ุจุฑูโฺฏุฑุฏุงูุฏ:

`{instance="localhost:9100",job="node"} 4`

ุงฺฏุฑ ุจู ุชูฺฉฺฉ ูุฑ ูุงุดู ูุงุฒ ูุฏุงุดุชุฏุ ูุซูุงู ุงฺฏุฑ ุฏุฑ ุญุงู ุจุฑุฑุณ ุงู ุจูุฏุฏ ฺฉู ุขุง ุจุฑฺุณุจโูุง ุฎุงุต ุฏุงุฑุง ฺฉุงุฑุฏูุงูุช (cardinality) ุจุงูุง ูุณุชูุฏ ุง ุฎุฑุ ูโุชูุงูุณุชุฏ ุงุฒ ุงุตูุงุญโฺฏุฑ (modifier) `by` ุจุฑุง ุจุฑุฑุณ ุชููุง ฺฉ ุจุฑฺุณุจ ุงุณุชูุงุฏู ฺฉูุฏ:

`count(count by(cpu)(node_cpu_seconds_total))`

ฺฉู ฺฉ ููููู ูุงุญุฏ ุจุฏูู ุจุฑฺุณุจ ุชููุฏ ูโฺฉูุฏุ ูุงููุฏ:

`{} 4`

## `avg`

ุนููฺฏุฑ `avg` ูุงูฺฏู ููุงุฏุฑ ุณุฑโูุง ุฒูุงู ุฏุฑ ฺฏุฑูู ุฑุง ุจู ุนููุงู ููุฏุงุฑ ฺฏุฑูู ุจุฑูโฺฏุฑุฏุงูุฏ. ุจุฑุง ูุซุงู:
`avg without(cpu)(rate(node_cpu_seconds_total[5m]))`

ูุงูฺฏู ุงุณุชูุงุฏู ุงุฒ ูุฑ ุญุงูุช CPU ุฑุง ุจุฑุง ูุฑ ููููู Node Exporter ุจุง ูุชุฌูโุง ูุงููุฏ ุฒุฑ ุจู ุดูุง ูโุฏูุฏ:

```json
{instance="localhost:9100",job="node",mode="idle"} 0.9095948275861836
{instance="localhost:9100",job="node",mode="iowait"} 0.005543103448275879
{instance="localhost:9100",job="node",mode="irq"} 0
{instance="localhost:9100",job="node",mode="nice"} 0.0013620689655172522
{instance="localhost:9100",job="node",mode="softirq"} 0.0001465517241379329
{instance="localhost:9100",job="node",mode="steal"} 0
{instance="localhost:9100",job="node",mode="system"} 0.015836206896552414
{instance="localhost:9100",job="node",mode="user"} 0.06054310344827549
```

ุงู ุฏููุงู ููุงู ูุชุฌูโุง ุฑุง ุจู ุดูุง ูโุฏูุฏ ฺฉู:

```json
sum without(cpu)(rate(node_cpu_seconds_total[5m]))
/
count without(cpu)(rate(node_cpu_seconds_total[5m]))
```

ุงูุง ุงุณุชูุงุฏู ุงุฒ `avg` ูู ูุฎุชุตุฑุชุฑ ู ูู ฺฉุงุฑุขูุฏุชุฑ ุงุณุช. ููฺฏุงู ุงุณุชูุงุฏู ุงุฒ `avg`ุ ฺฏุงู ุงููุงุช ููฺฉู ุงุณุช ูุชูุฌู ุดูุฏ ฺฉู ฺฉ `NaN` ุฏุฑ ูุฑูุฏ ุจุงุนุซ ูโุดูุฏ ฺฉู ูุชุฌู `NaN` ุดูุฏ. ุงู ุจู ุงู ุฏูู ุงุณุช ฺฉู ูุฑฺฏููู ุนููุงุช ูุญุงุณุจุงุช ููุฒ ุดูุงูุฑ (floating-point) ฺฉู ุดุงูู `NaN` ุจุงุดุฏุ ูุชุฌูโุงุด `NaN` ุฎูุงูุฏ ุจูุฏ. ุดุงุฏ ุงุฒ ุฎูุฏ ุจูพุฑุณุฏ ฺฺฏููู ุงู `NaN`ูุง ุฑุง ุฏุฑ ูุฑูุฏ ููุชุฑ ฺฉูุฏุ ุงูุง ุงู ุณูุงู ุงุดุชุจุงู ุงุณุช. ูุนูููุงู ุงู ุจู ุฏูู ุชูุงุด ุจุฑุง ูุงูฺฏูโฺฏุฑ ุงุฒ ูุงูฺฏูโูุง ุงุณุช ู ฺฉ ุงุฒ ูุฎุฑุฌโูุง ูุงูฺฏูโูุง ุงููู 0 ุจูุฏู ุงุณุช. ูุงูฺฏูโฺฏุฑ ุงุฒ ูุงูฺฏูโูุง ุงุฒ ูุธุฑ ุขูุงุฑ ูุนุชุจุฑ ูุณุชุ ุจูุงุจุฑุงู ฺฉุงุฑ ฺฉู ุจุงุฏ ุงูุฌุงู ุฏูุฏ ุงู ุงุณุช ฺฉู ุจุง ุงุณุชูุงุฏู ุงุฒ `sum` ุชุฌูุน ฺฉุฑุฏู ู ุณูพุณ ุฏุฑ ููุงุช ุชูุณู ฺฉูุฏุ ููุงูุทูุฑ ฺฉู ุฏุฑ ุจุฎุด ยซุฎูุงุตูยป (Summary)  ูุดุงู ุฏุงุฏู ุดุฏู ุงุณุช.

- ุงุฒ ูุธุฑ ูู ุจู ุขู ูุงูฺฏู ุญุณุงุจ (arithmetic mean) ูโฺฏููุฏ. ุฏุฑ ููุงุฑุฏ ูุงุฏุฑ ฺฉู ุจู ูุงูฺฏู ููุฏุณ (geometric mean) ูุงุฒ ุฏุงุฑุฏุ ูโุชูุงู ุงุฒ ุชูุงุจุน `ln` ู `exp` ุฏุฑ ุชุฑฺฉุจ ุจุง ุนููฺฏุฑ `avg` ุจุฑุง ูุญุงุณุจู ุขู ุงุณุชูุงุฏู ฺฉุฑุฏ.
- ุงู ุจู ุงู ุฏูู ุงุณุช ฺฉู 1 / 0 = `NaN`.

### `group`

ุนููฺฏุฑ `group` ุจุฑุง ูุฑ ฺฉ ุงุฒ ุณุฑโูุง ุฒูุงู ุฏุฑ ฺฏุฑููุ ููุฏุงุฑ 1 ุฑุง ุจู ุนููุงู ููุฏุงุฑ ฺฏุฑูู ุจุฑูโฺฏุฑุฏุงูุฏ. ุจุฑุง ูุซุงู:

`count by (instance)( group by (fstype,instance) (node_filesystem_files) )`

ุงู ฺฉูุฆุฑ ุชุนุฏุงุฏ ุงููุงุน ูุฎุชูู ูุงูโุณุณุชู ุฑุง ุจุฑุง ูุฑ ููููู ุจุฑูโฺฏุฑุฏุงูุฏ. ุฏุฑ ุงู ุญุงูุชุ ูุฑ ุนููฺฏุฑ ุชุฌูุน (`sum`ุ `count`) ูโุชูุงูุณุช ุจู ุฌุง `group` ฺฉุงุฑ ฺฉูุฏ. ุจุง ุงู ุญุงูุ ุงุณุชูุงุฏู ุงุฒ `group` ุจุฑุง ูุฑ ฺฉุณ ฺฉู ฺฉูุฆุฑ ุฑุง ูโุฎูุงูุฏุ ุฑูุดู ูโฺฉูุฏ ฺฉู ูุง ุจู ุฎูุฏู ฺฏุฑููโุจูุฏ ู ุจุฑฺุณุจโูุง ุญุงุตู ุงุฒ ุขู ุนูุงููโููุฏูุ ูู ุจู ููุฏุงุฑ ฺฉู ุชูุณุท ุนููฺฏุฑ ุชุฌูุน ุฏุงุฎู ุชููุฏ ูโุดูุฏ.

### `stddev` ู `stdvar`

ุงูุญุฑุงู ูุนุงุฑ (standard deviation) ฺฉ ูุนุงุฑ ุขูุงุฑ ุจุฑุง ูุดุงู ุฏุงุฏู ูุฒุงู ูพุฑุงฺฉูุฏฺฏ ูุฌููุนูโุง ุงุฒ ุงุนุฏุงุฏ ุงุณุช. ุจุฑุง ูุซุงูุ ุงฺฏุฑ ุงุนุฏุงุฏ [ฒุดุถ] ุฑุง ุฏุงุดุชู ุจุงุดุฏุ ุงูุญุฑุงู ูุนุงุฑ ฑ.ถณณ ุฎูุงูุฏ ุจูุฏ.โถ ุงุนุฏุงุฏ [ณุดุต] ูุงูฺฏู ฺฉุณุงู ด ุฏุงุฑูุฏุ ุงูุง ุงูุญุฑุงู ูุนุงุฑ ุขูโูุง ฐ.ธฑถ ุงุณุช. ฺฉุงุฑุจุฑุฏ ุงุตู ุงูุญุฑุงู ูุนุงุฑ ุฏุฑ ูุงูุชูุฑูฺฏุ ุชุดุฎุต ุฏุงุฏูโูุง ูพุฑุช (outliers) ุงุณุช. ุฏุฑ ุฏุงุฏูโูุง ุจุง ุชูุฒุน ูุฑูุงูุ ุงูุชุธุงุฑ ูโุฑูุฏ ุญุฏูุฏ ถธูช ุงุฒ ูููููโูุง ุฏุฑ ูุงุตูู ฺฉ ุงูุญุฑุงู ูุนุงุฑ ุงุฒ ูุงูฺฏู ู นตูช ุฏุฑ ูุงุตูู ุฏู ุงูุญุฑุงู ูุนุงุฑ ูุฑุงุฑ ฺฏุฑูุฏ.โท ุงฺฏุฑ ฺฉ ููููู ุฏุฑ ฺฉ `job`ุ ูุชุฑฺฉ ุฏุงุดุชู ุจุงุดุฏ ฺฉู ฺูุฏู ุงูุญุฑุงู ูุนุงุฑ ุงุฒ ูุงูฺฏู ูุงุตูู ุฏุงุฑุฏุ ุงู ูุดุงูู ุฎูุจ ุงุณุช ฺฉู ูุดฺฉู ุฏุฑ ุขู ูุฌูุฏ ุฏุงุฑุฏ. ุจุฑุง ูุซุงูุ ูโุชูุงูุฏ ุชูุงู ูููููโูุง ุฑุง ฺฉู ุญุฏุงูู ุฏู ุงูุญุฑุงู ูุนุงุฑ ุจุงูุงุชุฑ ุงุฒ ูุงูฺฏู ูุณุชูุฏุ ุจุง ุงุณุชูุงุฏู ุงุฒ ุนุจุงุฑุช ูุงููุฏ ุฒุฑ ูพุฏุง ฺฉูุฏ:

```
some_gauge
> ignoring (instance) group_left()
(
avg without(instance)(some_gauge)
+
2 * stddev without(instance)(some_gauge)
)
```

ุงู ุงุฒ ุชุทุงุจู ุจุฑุฏุงุฑ ฺฉ ุจู ฺูุฏ (one-to-many vector matching) ุงุณุชูุงุฏู ูโฺฉูุฏ ฺฉู ุฏุฑ ุจุฎุด ยซุชุทุงุจู ฺูุฏ ุจู ฺฉ ู group_leftยป (Many-to-One and group_left) ุฏุฑ ุงุฏุงูู ููุฑุฏ ุจุญุซ ูุฑุงุฑ ุฎูุงูุฏ ฺฏุฑูุช. ุงฺฏุฑ ููุงุฏุฑ ุดูุง ููฺฏ ุจู ูู ูุฒุฏฺฉ ุจุงุดูุฏ (tightly bunched)ุ ููฺฉู ุงุณุช ุงู ุฏุณุชูุฑ ุจุฑุฎ ุณุฑโูุง ุฒูุงู ุฑุง ุจุฑฺฏุฑุฏุงูุฏ ฺฉู ุจุด ุงุฒ ุฏู ุงูุญุฑุงู ูุนุงุฑ ูุงุตูู ุฏุงุฑูุฏุ ุงูุง ููฺูุงู ุจู ุทูุฑ ุนุงุฏ ฺฉุงุฑ ูโฺฉููุฏ ู ุจู ูุงูฺฏู ูุฒุฏฺฉ ูุณุชูุฏ. ูโุชูุงูุฏ ฺฉ ููุชุฑ ุงุถุงู ุงุถุงูู ฺฉูุฏ ฺฉู ููุฏุงุฑ ุจุงุฏ ุญุฏุงููุ ูุซูุงูุ ฒฐูช ุจุดุชุฑ ุงุฒ ูุงูฺฏู ุจุงุดุฏ ุชุง ุงุฒ ุงู ุญุงูุช ุฌููฺฏุฑ ุดูุฏ. ุงู ููฺูู ฺฉ ููุฑุฏ ูุงุฏุฑ ุงุณุช ฺฉู ูุงูฺฏูโฺฏุฑ ุงุฒ ฺฉ ูุงูฺฏู ูุดฺฉู ูุฏุงุฑุฏุ ูุซูุงู ุงฺฏุฑ ุงู ุฑุง ุจุฑุง ูุงูฺฏู ุชุฃุฎุฑ (latency) ุงุนูุงู ฺฉูุฏ. ูุงุฑุงูุณ ูุนุงุฑ (standard variance)ุ ูุฌุฐูุฑ ุงูุญุฑุงู ูุนุงุฑ ุงุณุช ู ฺฉุงุฑุจุฑุฏูุง ุขูุงุฑ ุฏุงุฑุฏ.

- ูพุฑููุชุฆูุณ ุงุฒ ุงูุญุฑุงู ูุนุงุฑ ุชุฌูุน ุจู ุฌุง ุงูุญุฑุงู ูุนุงุฑ ููููู ุงุณุชูุงุฏู ูโฺฉูุฏุ ุฒุฑุง ูุนูููุงู ุดูุง ุจู ุชูุงู ููุงุฏุฑ ฺฉู ุจู ุขูโูุง ุนูุงููโููุฏุฏ ูฺฏุงู ูโฺฉูุฏุ ูู ฺฉ ุฒุฑูุฌููุนู ุชุตุงุฏู.
- ุจุฑุง ุฏุงุฏูโูุง ุจุง ุชูุฒุน ุบุฑูุฑูุงูุ ูุงุจุฑุงุจุฑ ฺุจุดู (Chebyshevโs inequality) ฺฉุฑุงู ุถุนูโุชุฑ ุงุฑุงุฆู ูโุฏูุฏ.


---

## ๐ ุชุนุฑู ูพุงู

ูุฑุถ ฺฉู ูุฌููุนูโุง ุงุฒ ุฏุงุฏูโูุง ุฏุงุฑู:

```
xโ, xโ, xโ, ..., xโ
```

ฺฉู ุงู ุฏุงุฏูโูุง ุงุฒ ฺฉ **range vector** ุฏุฑ Prometheus ุจูโุฏุณุช ุงููุฏูุ ูุซู:

```promql
http_requests_total[5m]
```

ุฏุฑ ุงู ุตูุฑุช Prometheus ุฑู ุงู ุฏุงุฏูโูุง ุชูุงุจุน ุขูุงุฑ ูุซู `avg`, `stddev`, `stdvar` ุฑู ุงุฌุฑุง ูโฺฉูู.

---

## โ ูุงูฺฏู (Average / Mean)

ูุจู ุงุฒ ูุญุงุณุจู ูุงุฑุงูุณ ุง ุงูุญุฑุงู ูุนุงุฑุ ุจุงุฏ ูุงูฺฏู ุฑู ูุญุงุณุจู ฺฉูู:

$$
\mu = \frac{1}{n} \sum_{i=1}^{n} x_i
$$

---

## โ ูุงุฑุงูุณ (Variance) โ `stdvar_over_time`

ูุงุฑุงูุณุ ูุชูุณุท ูุฑุจุน ูุงุตููโ ููุงุฏุฑ ุงุฒ ูุงูฺฏูู:

$$
\text{Var}(X) = \frac{1}{n} \sum_{i=1}^{n} (x_i - \mu)^2
$$

ุฏุฑ Prometheusุ ุงู ุฑู ุจุง `stdvar_over_time()` ุจูโุฏุณุช ูุงุฑู.

---

## โ ุงูุญุฑุงู ูุนุงุฑ (Standard Deviation) โ `stddev_over_time`

ุงูุญุฑุงู ูุนุงุฑุ ุฑุดู ุฏูู ูุงุฑุงูุณู:

$$
\text{StdDev}(X) = \sqrt{\text{Var}(X)} = \sqrt{ \frac{1}{n} \sum_{i=1}^{n} (x_i - \mu)^2 }
$$

ุฏุฑ Prometheusุ ุงู ุฑู ุจุง `stddev_over_time()` ูุญุงุณุจู ูโฺฉูู.

---

## ๐งช ูุซุงู ูุงูุน ุงุฒ Prometheus

ูุฑุถ ฺฉู ู ูุชุฑฺฉ ูุซู `temperature_celsius` ุฏุงุฑู ฺฉู ุฏูุง ฺฉ ุณุฑูุฑ ุฑู ุฏุฑ ต ุฏููู ุงุฎุฑ ูุดูู ูโุฏู:

```promql
stddev_over_time(temperature_celsius[5m])
```

ูุฑุถ ฺฉู ุฏุงุฏูโูุง ุงู ุจุงุดู:

```
xโ = 25.0
xโ = 26.0
xโ = 27.5
xโ = 25.5
xโ = 26.5
```

* ูุงูฺฏู:

$$
\mu = \frac{25.0 + 26.0 + 27.5 + 25.5 + 26.5}{5} = \frac{130.5}{5} = 26.1
$$

* ูุงุฑุงูุณ:

$$
\text{Var} = \frac{(25 - 26.1)^2 + (26 - 26.1)^2 + (27.5 - 26.1)^2 + (25.5 - 26.1)^2 + (26.5 - 26.1)^2}{5}
$$

$$
= \frac{1.21 + 0.01 + 1.96 + 0.36 + 0.16}{5} = \frac{3.7}{5} = 0.74
$$

* ุงูุญุฑุงู ูุนุงุฑ:

$$
\text{StdDev} = \sqrt{0.74} \approx 0.86
$$

---

## ๐ ุชูุงูุช ูุงุญุฏ

| ุชุงุจุน                 | ููุฏุงุฑ | ูุงุญุฏ  |
| -------------------- | ----- | ----- |
| `avg_over_time()`    | 26.1  | ยฐC    |
| `stdvar_over_time()` | 0.74  | (ยฐC)ยฒ |
| `stddev_over_time()` | 0.86  | ยฐC    |

---

## โฑ ูฺฉุชู ุฏุฑุจุงุฑู Range Vector

ุฏุฑ Prometheusุ ุงู ุชูุงุจุน ููุท ุฑู ุฏุงุฏูโูุง ฺฉู ุฏุฑ ุจุงุฒู ุฒูุงู ูุดุฎุต ุฌูุนโุขูุฑ ุดุฏู (`[5m]`ุ `[1h]`ุ ...) ูุงุจู ุงุณุชูุงุฏู ูุณุชู.

---


### `min` ู `max`

ุนููฺฏุฑูุง `min` ู `max` ุจู ุชุฑุชุจ ุญุฏุงูู ุง ุญุฏุงฺฉุซุฑ ููุฏุงุฑ ุฏุฑูู ฺฉ ฺฏุฑูู ุฑุง ุจู ุนููุงู ููุฏุงุฑ ฺฏุฑูู ุจุฑูโฺฏุฑุฏุงููุฏ. ููุงูู ฺฏุฑููโุจูุฏ ูุดุงุจู ุณุงุฑ ููุงุฑุฏ ุงุนูุงู ูโุดูุฏุ ุจูุงุจุฑุงู ุณุฑ ุฒูุงู ุฎุฑูุฌุ ุจุฑฺุณุจโูุง ฺฏุฑูู ุฑุง ุฎูุงูุฏ ุฏุงุดุช.โน ุจุฑุง ูุซุงู:
`max without(device, fstype, mountpoint)(node_filesystem_size_bytes)`
ุงูุฏุงุฒู ุจุฒุฑฺฏุชุฑู ูุงูโุณุณุชู ุฑุง ุฏุฑ ูุฑ ููููู ุจุฑูโฺฏุฑุฏุงูุฏ ฺฉู ุจุฑุง ูุง ูุชุฌู ุฒุฑ ุฑุง ุฏุงุฑุฏ:
`{instance="localhost:9100",job="node"} 90131324928`
ุนููฺฏุฑูุง `max` ู `min` ุชููุง ุฏุฑ ุตูุฑุช `NaN` ุจุฑูโฺฏุฑุฏุงููุฏ ฺฉู ุชูุงู ููุงุฏุฑ ุฏุฑ ฺฉ ฺฏุฑูู `NaN` ุจุงุดูุฏ.



---

## โ ุชุนุฑู  `topk` ู `bottomk`

ุฏุฑ PromQLุ ููุช ู **ุจุฑุฏุงุฑ ููููู (instant vector)** ุฏุงุฑู (ุนู ฺูุฏ ุณุฑ ุฒูุงู ฺฉู ูุฑฺฉุฏูู ฺฉ ููุฏุงุฑ ูุนู ุฏุงุฑูุฏ)ุ ููฺฉู ุงุณุช ุจุฎูุงูู ููุท **n ุชุง ุงุฒ ุงููโูุง** ุฑู ุจุจูู ฺฉู **ุจุดุชุฑู ุง ฺฉูุชุฑู ููุฏุงุฑ ุฑุง ุฏุงุฑูุฏ**.

### `topk(k, vector)`

* ุฎุฑูุฌ: **k ุชุง ุงุฒ ุณุฑโูุง ุฒูุงู ฺฉู ุจุงูุงุชุฑู ููุฏุงุฑ ุฑุง ุฏุงุฑูุฏ.**

### `bottomk(k, vector)`

* ุฎุฑูุฌ: **k ุชุง ุงุฒ ุณุฑโูุง ุฒูุงู ฺฉู ูพุงูโุชุฑู ููุฏุงุฑ ุฑุง ุฏุงุฑูุฏ.**

---

## ๐ ฺฉุงุฑุจุฑุฏูุง ุฑุงุฌ

| ฺฉุงุฑุจุฑุฏ                                           | ุชุงุจุน      |
| ------------------------------------------------ | --------- |
| ูพุฏุง ฺฉุฑุฏู ุณุฑูุณโูุง ฺฉู ุจุดุชุฑู CPU ูุตุฑู ูโฺฉูู  | `topk`    |
| ูพุฏุง ฺฉุฑุฏู ูพุงุฏูุง ฺฉู ุญุงูุธูโ ฺฉูุชุฑ ูุตุฑู ูโฺฉูู   | `bottomk` |
| ุงูุชู ููุงุจุน ฺฉู ุจุดุชุฑู ุฎุทุง ุฑู ุฏุงุฑู              | `topk`    |
| ูุงูุชูุฑ ฺฉุฑุฏู ููุงุจุน ฺฉู ุชูุฑุจุงู ุจุฏูู ุงุณุชูุงุฏู ูุณุชู | `bottomk` |

---

## ๐ ฺูุฏ ูุซุงู ูุงูุน

### ฑ. ุจุดุชุฑู ูุตุฑู CPU ุชูุณุท ููุฏูุง

```promql
topk(3, rate(node_cpu_seconds_total{mode="user"}[1m]))
```

> ุณู ููุฏ ฺฉู ุฏุฑ ุญุงูุช "user" ุจุดุชุฑู ูุตุฑู CPU ุฑู ุฏุฑ ฺฉ ุฏููู ุงุฎุฑ ุฏุงุดุชู.

---

### ฒ. ฺฉูุชุฑู ูุตุฑู ุญุงูุธู ุชูุณุท ูพุงุฏูุง

```promql
bottomk(5, container_memory_usage_bytes{job="kubelet", image!=""})
```

> ต ุชุง ุงุฒ ูพุงุฏูุง ฺฉู ฺฉูุชุฑู ูุฒุงู ุญุงูุธู ุฑู ูุตุฑู ูโฺฉูู (ู image ุฎุงู ูุฏุงุฑู).

---

### ณ. ุจุดุชุฑู ุฎุทุง HTTP ุฏุฑ ุณุฑูุณโูุง

```promql
topk(5, rate(http_requests_total{status=~"5.."}[5m]))
```

> ต ุชุง ุงุฒ ุณุฑูุณโูุง ฺฉู ุจุดุชุฑู ูุฑุฎ ุฎุทุง ตxx ุฑู ุฏุฑ ต ุฏููู ฺฏุฐุดุชู ุฏุงุดุชู.

---

### ด. ูพุงุฏูุง ุจุง ฺฉูุชุฑู ูุฑูุฏ ุดุจฺฉู

```promql
bottomk(10, rate(container_network_receive_bytes_total[1m]))
```

> ฑฐ ูพุงุฏ ุจุง ฺฉูุชุฑู ูุฑุฎ ุฏุฑุงูุช ุฏุงุฏู ุงุฒ ุดุจฺฉู ุฏุฑ ฺฉ ุฏููู ุงุฎุฑ.

---

## โ๏ธ ูฺฉุงุช ููู

ฑ. โ`topk` ู `bottomk` ููุท ุฑู **ููุงุฏุฑ instance vector** ฺฉุงุฑ ูโฺฉููุ ูู ุฑู range vector (ูุซู `[5m]`). ูพุณ ุงูู ุจุงุฏ ุชูุงุจุน ูุซู `rate()`ุ `avg_over_time()`ุ ุง `sum()` ุงุณุชูุงุฏู ุจุดู ุชุง ููุฏุงุฑ ูุนู ุงุฒ ุฏุงุฏูโูุง ุชุงุฑุฎ ุณุงุฎุชู ุจุดู.

ฒ. โ`k` ุจุงุฏ **ุนุฏุฏ ุซุงุจุช ู ุตุญุญ** ุจุงุดูุ ูุซู `5` ุง `10`.

ณ. ุงฺฏู ุณุฑโูุง ุฒูุงู ููโููุฏุงุฑ ุจุงุดูุ ููฺฉูู Prometheus ุงูุชุฎุงุจโูุง ูุฎุชูู ุจุฑฺฏุฑุฏูููุ ฺูู ุงู ุชุงุจุนโูุง ุชุถูู ููโฺฉูู ฺฉู ฺฉุฏูู ุณุฑ ุจุฑฺฏุฑุฏู ุฏุฑ ุตูุฑุช ุชุณุงู.

---

## ๐ ุชุฑฺฉุจ ุจุง `sum`, `by()`, `rate()`

ูุซูุงู ุงฺฏู ุจุฎูุงูู ูพุงุฏูุง ุฑู ูพุฏุง ฺฉูู ฺฉู ุจุดุชุฑู ูุตุฑู CPU ุฑู ุฏุงุฑูุฏุ ุจุงุฏ ุงูู ูุฌููุน ูุตุฑู CPU ุฑู ุจุฑุง ูุฑ ูพุงุฏ ูุญุงุณุจู ฺฉูู:

```promql
topk(5, sum(rate(container_cpu_usage_seconds_total[1m])) by (pod))
```

> ุงู ุนู: ูุฌููุน ูุฑุฎ ูุตุฑู CPU ุฏุฑ ฑ ุฏููู ฺฏุฐุดุชู ุฑู ุจุฑุง ูุฑ ูพุงุฏ ุญุณุงุจ ฺฉูุ ุจุนุฏ ต ุชุง ุงูู ุฑู ูุดูู ุจุฏู.

---

## ๐ฏ ุฌูุนโุจูุฏ

| ุชุงุจุน                 | ฺฉุงุฑุจุฑุฏ                                              |
| -------------------- | --------------------------------------------------- |
| `topk(k, vector)`    | ูุดูู ุฏุงุฏู k ุชุง ุงุฒ ุณุฑโูุง ุฒูุงู ุจุง ุจุดุชุฑู ููุฏุงุฑ    |
| `bottomk(k, vector)` | ูุดูู ุฏุงุฏู k ุชุง ุจุง ฺฉูุชุฑู ููุฏุงุฑ                      |
| ูุงุจู ุชุฑฺฉุจ ุจุง        | `rate()`, `sum()`, `avg_over_time()`, `by()` ู ุบุฑู |

### ูฺฉุชู:

- โ`k` ุจุงุฏ ฺฉ ุนุฏุฏ ุตุญุญ ูุซุจุช ุจุงุดู.
- ููุฏุงุฑ ูุฑูุฏ ุจุงุฏ **ฺฉ ุจุฑุฏุงุฑ ููุฑ (instant vector)** ุจุงุดู. ูุซูุงู ุฎุฑูุฌ `rate(...)` ุง `avg_over_time(...)` ฺฉู ุฏุฑ ฺฉ ูุญุธู ูุญุงุณุจู ุดุฏู.
### `topk` ู `bottomk`

ุฏู  ููุฑุฏ `topk` ู `bottomk` ุงุฒ ุณู ุฌูุช ุจุง ุณุงุฑ ุนููฺฏุฑูุง ุชุฌูุน ฺฉู ุชุงฺฉููู ุจุญุซ ุดุฏูโุงูุฏุ ูุชูุงูุช ูุณุชูุฏ. ุงููุ ุจุฑฺุณุจโูุง ุณุฑโูุง ุฒูุงู ฺฉู ุจุฑุง ฺฉ ฺฏุฑูู ุจุฑูโฺฏุฑุฏุงููุฏุ ุจุฑฺุณุจโูุง ุขู ฺฏุฑูู ูุณุชูุฏุ ุฏููุ ูโุชูุงููุฏ ุจุด ุงุฒ ฺฉ ุณุฑ ุฒูุงู ุจู ุงุฒุง ูุฑ ฺฏุฑูู ุจุฑฺฏุฑุฏุงููุฏุ ู ุณููุ ฺฉ ูพุงุฑุงูุชุฑ ุงุถุงู ูโฺฏุฑูุฏ. `topk` ุชุนุฏุงุฏ k ุณุฑ ุฒูุงู ุจุง ุจุฒุฑฺฏุชุฑู ููุงุฏุฑ ุฑุง ุจุฑูโฺฏุฑุฏุงูุฏุ ุจูุงุจุฑุงู ุจุฑุง ูุซุงู:

`topk without(device, fstype, mountpoint)(2, node_filesystem_size_bytes)`

ุชุง ุฏู  ุณุฑ ุฒูุงู ุจู ุงุฒุง ูุฑ ฺฏุฑูู ุจุฑูโฺฏุฑุฏุงูุฏุ ูุงููุฏ:

```json
node_filesystem_size_bytes{device="/dev/sda5",fstype="ext4",
instance="localhost:9100",job="node",mountpoint="/"} 90131324928
node_filesystem_size_bytes{device="tmpfs",fstype="tmpfs",
instance="localhost:9100",job="node",mountpoint="/run"} 826961920
```

ููุงูุทูุฑ ฺฉู ูโุจูุฏุ `topk` ุณุฑโูุง ุฒูุงู ูุฑูุฏ ุฑุง ุจุง ุชูุงู ุจุฑฺุณุจโูุงุดุงูุ ุงุฒ ุฌููู ุจุฑฺุณุจ `__name__` ฺฉู ูุงู ูุชุฑฺฉ ุฑุง ุฏุฑ ุฎูุฏ ูฺฏู ูโุฏุงุฑุฏุ ุจุฑูโฺฏุฑุฏุงูุฏ. ูุชุฌู ููฺูู ูุฑุชุจ ุดุฏู ุงุณุช.

-
- ุงฺฏุฑ ูโุฎูุงูุฏ ุณุฑโูุง ุฒูุงู ูุฑูุฏ ุจุฑฺฏุฑุฏุงูุฏู ุดููุฏุ ุงุฒ `topk` ุง `bottomk` ุงุณุชูุงุฏู ฺฉูุฏ.
- ุฏุฑ ูุญุงุณุจุงุช ููุฒ ุดูุงูุฑุ ูุฑฺฏููู ููุงุณู ุจุง `NaN` ููุดู `false` ุจุฑูโฺฏุฑุฏุงูุฏ. ุฌุฏุง ุงุฒ ุงุฌุงุฏ ููุงุฑุฏ ุนุฌุจ ูุงููุฏ `NaN != NaN` ฺฉู `false` ุจุฑูโฺฏุฑุฏุงูุฏุ ฺฉ ูพุงุฏูโุณุงุฒ ุณุงุฏูโุงูฺฏุงุฑุงูู ุงุฒ `min` ู `max` ุงฺฏุฑ `NaN` ุงููู ููุฏุงุฑ ุจุฑุฑุณ ุดุฏู ุจูุฏุ ุฑู ุขู ฺฏุฑ ูโฺฉุฑุฏ (ู ุฒูุงู ุงูุทูุฑ ุจูุฏ).
- ุฏุฑ ุงู ุญุงูุช k ุจุฑุงุจุฑ ฒ ุงุณุช.

โ`bottomk` ูุดุงุจู `topk` ุงุณุชุ ุจุง ุงู ุชูุงูุช ฺฉู k ุณุฑ ุฒูุงู ุจุง ฺฉูฺฺฉุชุฑู ููุงุฏุฑ ุฑุง ุจู ุฌุง k ุณุฑ ุฒูุงู ุจุง ุจุฒุฑฺฏุชุฑู ููุงุฏุฑ ุจุฑูโฺฏุฑุฏุงูุฏ. ูุฑ ุฏู ุนููฺฏุฑุ ุฏุฑ ุตูุฑุช ุงูฺฉุงูุ ุงุฒ ุจุฑฺฏุฑุฏุงูุฏู ุณุฑโูุง ุฒูุงู ุจุง ููุงุฏุฑ `NaN` ุฎูุฏุฏุงุฑ ูโฺฉููุฏ. ฺฉ ูฺฉุชู ูุงุจู ุชูุฌู (gotcha) ููฺฏุงู ุงุณุชูุงุฏู ุงุฒ ุงู ุนููฺฏุฑูุง ุจุง ููุทู ูพุงุงู (endpoint) `query_range` ุฏุฑ API HTTP ูุฌูุฏ ุฏุงุฑุฏ. ููุงูุทูุฑ ฺฉู ุฏุฑ ุจุฎุด ยซquery_rangeยป ุฏุฑ ฺฏุฐุดุชู ุจุญุซ ุดุฏุ ุงุฑุฒุงุจ ูุฑ ูุฑุญูู ูุณุชูู ุงุณุช. ุงฺฏุฑ ุงุฒ `topk` ุงุณุชูุงุฏู ฺฉูุฏุ ููฺฉู ุงุณุช ุณุฑ ุฒูุงู ุจุฑุชุฑ ุงุฒ ูุฑุญููโุง ุจู ูุฑุญูู ุฏฺฏุฑ ุชุบุฑ ฺฉูุฏ. ุจูุงุจุฑุงู ฺฉ `topk(5, some_gauge)` ุจุฑุง ฺฉ `query_range` ุจุง ฑฐฐฐ ูุฑุญูู ูโุชูุงูุฏ ุฏุฑ ุจุฏุชุฑู ุญุงูุช ตฐฐฐ ุณุฑ ุฒูุงู ูุฎุชูู ุจุฑฺฏุฑุฏุงูุฏ. ุฑุงู ุญู ุงู ูุดฺฉู ุงุณุชูุงุฏู ุงุฒ ุงุตูุงุญโฺฏุฑ at (`@`) ุงุณุชุ ููุงูุทูุฑ ฺฉู ุฏุฑ ุจุฎุด ยซุงุตูุงุญโฺฏุฑ Atยป (At Modifier) ุฏุฑ ุตูุญูโูุง ฺฏุฐุดุชู ุจุญุซ ุดุฏ.



# `quantile`ุ `histogram_quantile` ู `quantile_over_time` part 1

---

## ๐ ูุฑูุฑ ุณุฑุน:

| ุชุงุจุน                   | ฺฉุงุฑุจุฑุฏ ุงุตู                                                                            |
| ---------------------- | -------------------------------------------------------------------------------------- |
| `quantile()`           | ูุญุงุณุจู ุตุฏฺฉ ุงุฒ ฺฉ **ุจุฑุฏุงุฑ ููููู** (instant vector)                                      |
| `quantile_over_time()` | ูุญุงุณุจู ุตุฏฺฉ ุงุฒ ฺฉ **range vector** (ูุซูุงู ุฏุงุฏูโูุง ต ุฏููู ุงุฎุฑ)                        |
| `histogram_quantile()` | ูุญุงุณุจู ุตุฏฺฉ ุงุฒ **ููุงุฏุฑ histogram bucket**ูุง (ูุซู ุฏุงุฏูโูุง Prometheus histogram metric) |

---

# โ ฑ. `quantile(scalar q, vector)`

### ุตุฏฺฉ ุงุฒ ุฏุงุฏูโูุง ูุญุธูโุง

* ูุฑูุฏ: ฺฉ ุนุฏุฏ ุตุฏฺฉ `q` (ุจู 0 ู 1) ู ฺฉ instant vector
* ุฎุฑูุฌ: ููุฏุงุฑ ุตุฏฺฉ `q` ุงุฒ ุงูู ุจุฑุฏุงุฑ

### ูุซุงู:

```promql
quantile(0.9, rate(http_request_duration_seconds_sum[1m]) / rate(http_request_duration_seconds_count[1m]))
```

> ุงูุฌุง ุฏุงุฑู `p90` ุฒูุงู ูพุงุณุฎ ุฏุฑุฎูุงุณุชโูุง ุฑู ูุญุงุณุจู ูโฺฉูู ุจุง ุงุณุชูุงุฏู ุงุฒ ูุงูฺฏูโูุง.

ุงูุจุชู ุงู ูุซุงู ุจุฑุง ุฏุงุฏูโูุง histogram ุจูุชุฑ ุจุง `histogram_quantile()` ุฒุฏู ูโุดู (ุฏุฑ ุงุฏุงูู ุชูุถุญ ูโุฏู).

---

# โ ฒ. `quantile_over_time(scalar q, range-vector)`

### ุตุฏฺฉ ุงุฒ ฺฉ ุจุงุฒู ุฒูุงู ุจุฑุง ฺฉ ุณุฑ ุฒูุงู

* ูุฑูุฏ: ฺฉ ุตุฏฺฉ (ูุซู `0.95`) ู ฺฉ range vector (ูุซูุงู `[5m]`)
* ุฎุฑูุฌ: ููุฏุงุฑ ุตุฏฺฉ `q` ุงุฒ ุชูุงู ููุงุฏุฑ ููุฌูุฏ ุฏุฑ ุขู ุจุงุฒู ุฒูุงู

### ูุซุงู:

```promql
quantile_over_time(0.95, http_request_duration_seconds_bucket{le="0.5"}[5m])
```

> ุตุฏฺฉ 95ุงู ุงุฒ bucketูุง ฺฉู ุฏุฑ ต ุฏููู ฺฏุฐุดุชู ุฏุงุฏู ุฌูุนโุขูุฑ ฺฉุฑุฏู.
> ุงูุง ุจุงุฒ ูู `histogram_quantile` ุจุฑุง ุฏุงุฏูโูุง bucket ุจูุชุฑู.

### ูุซุงู ูุงุถุญโุชุฑ ุจุง ุฏุงุฏู ูุนููู:

ูุฑุถ ฺฉูู ู ูุชุฑฺฉ ุฏุงุฑู:

```promql
quantile_over_time(0.75, node_load1[10m])
```

> ุตุฏฺฉ 75ูช ุงุฒ `node_load1` ุฏุฑ ฑฐ ุฏููู ุงุฎุฑ โ ุนู ุจุงุฑ ูพุฑุฏุงุฒุด CPU ุฏุฑ ุจุงุฒู ุฒูุงู ุงุฎุฑ ฺุทูุฑ ุจูุฏู.

---

# โ ณ. `histogram_quantile(q, buckets)`

### ูุญุงุณุจู ุฏูู ุตุฏฺฉ ุงุฒ ุฑู ุฏุงุฏูโูุง histogram

ุงู ุชุงุจุน ุจุฑุง ุฏุงุฏูโูุง ุงุณุชูุงุฏู ูโุดู ฺฉู ุจู ุดฺฉู bucket ูุณุชูุฏุ ูุซู:

* โ`http_request_duration_seconds_bucket{le="..."}` (ุฌูุนโุดูู ูุดูู ูโุฏู ฺูุฏ ุฏุฑุฎูุงุณุช ุฏุฑ ฺฉูุชุฑ ุงุฒ `le` ุซุงูู ุงูุฌุงู ุดุฏู)

๐ง ุจุงุฏ ุฏุงุฏูโูุง ุฑู ุจุง `rate()` ู `sum() by(le)` ฺฏุฑููโุจูุฏ ฺฉู ุชุง `histogram_quantile()` ุจุชููู ุฑูุด ฺฉุงุฑ ฺฉูู.

### ูุซุงู ุฎู ููู:

```promql
histogram_quantile(0.95,
  sum(rate(http_request_duration_seconds_bucket[5m])) by (le)
)
```

> ูุญุงุณุจู ุตุฏฺฉ 95ูช ุงุฒ ูุฏุชโุฒูุงู ูพุงุณุฎ ุฏุฑุฎูุงุณุชโูุง ุฏุฑ ต ุฏููู ุงุฎุฑ.

### ุงฺฏู ุจุฎูุงู ุจุฑุง ูุฑ ูุณุฑ (`handler`) ุฌุฏุง ุญุณุงุจ ฺฉู:

```promql
histogram_quantile(
  0.95,
  sum(rate(http_request_duration_seconds_bucket[5m])) by (le, handler)
)
```

---

## ๐ ุชูุงูุช ฺฉูุฏ ุจู ุงู ุชูุงุจุน

| ุชุงุจุน                   | ููุน ูุฑูุฏ        | ููุน ฺฉุงุฑุจุฑุฏ                   | ุฏููโุชุฑู ุจุฑุง histogram            |
| ---------------------- | ---------------- | ---------------------------- | ----------------------------------- |
| `quantile()`           | ุจุฑุฏุงุฑ ููููู      | ุตุฏฺฉ ุงุฒ ฺูุฏ ุณุฑ ูุฎุชูู         | โ ููุท ุฑู ููุงุฏุฑ ุนุฏุฏ ฺฉุงุฑ ูโฺฉูู    |
| `quantile_over_time()` | range vector     | ุตุฏฺฉ ุฏุฑ ุทูู ุฒูุงู ฺฉ ุณุฑ       | โ ุณุงุฏู ุงูุง ูู ุจุฑุง bucket           |
| `histogram_quantile()` | bucketูุง ุจุง `le` | ุตุฏฺฉ ุฏูู ุงุฒ histogram metric | โ ููุงุณุจ ุจุฑุง ูุชุฑฺฉโูุง ูุซู latency |

---

## ๐งช ููุงุณู ุจุง ูู ุฑู ฺฉ ุณูุงุฑู

ูุฑุถ ฺฉู ู ูุชุฑฺฉ ุฏุงุฑู ุงุฒ ุฒูุงู ูพุงุณุฎ ุฏุฑุฎูุงุณุชโูุง ฺฉู ุจู ุตูุฑุช histogram ุฌูุน ูโุดู.

### `histogram_quantile`:

```promql
histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le))
```

> ุฏููโุชุฑู ุฑุงู ุจุฑุง ูุญุงุณุจู p95 ุงุฒ ุฏุงุฏูโูุง bucket.

### `quantile_over_time`:

```promql
quantile_over_time(0.95, http_request_duration_seconds_sum[5m])
```

> ุตุฏฺฉ 95ูช ุงุฒ ูุฌููุน ุฒูุงู ูพุงุณุฎโูุง ุฏุฑ ต ุฏููู โ ูู ุฏูู ุจุฑุง histogram.

### `quantile`:

```promql
quantile(0.95, rate(http_request_duration_seconds_sum[1m]) / rate(http_request_duration_seconds_count[1m]))
```

> ูุญุงุณุจู ุตุฏฺฉ ุจุฑ ุงุณุงุณ ูุฑุฎ ูุงูฺฏูโูุง โ ฺฏุงู ฺฏูุฑุงูโฺฉููุฏู ูโุดู.

---

## โจ ูุชุฌูโฺฏุฑ

| ูโุฎูุง ฺฺฉุงุฑ ฺฉูุ                             | ุชุงุจุน ููุงุณุจ             |
| --------------------------------------------- | ---------------------- |
| ุตุฏฺฉ ุงุฒ ุฏุงุฏูโ histogram (ูุซู latency ุง size) | `histogram_quantile()` |
| ุตุฏฺฉ ุงุฒ ุฏุงุฏูโ ุณุงุฏู ุฏุฑ ุทูู ุฒูุงู                | `quantile_over_time()` |
| ุตุฏฺฉ ุงุฒ ฺูุฏ ุณุฑ ููโุฒูุงู ุฏุฑ ูุญุธู                | `quantile()`           |

---



### `quantile`

ุนููฺฏุฑ `quantile` ฺุงุฑฺฉ (quantile) ูุดุฎุต ุดุฏู ุงุฒ ููุงุฏุฑ ฺฏุฑูู ุฑุง ุจู ุนููุงู ููุฏุงุฑ ุจุงุฒฺฏุดุช ฺฏุฑูู ุจุฑูโฺฏุฑุฏุงูุฏ. ูุงููุฏ `topk`ุ `quantile` ูุฒ ฺฉ ูพุงุฑุงูุชุฑ ูโฺฏุฑุฏ. ุจูุงุจุฑุงูุ ุจุฑุง ูุซุงูุ ุงฺฏุฑ ูโุฎูุงุณุชู ุจุฏุงูู ุฏุฑ ูุงู CPUูุง ูุฎุชูู ุฏุฑ ูุฑ ฺฉ ุงุฒ ูุงุดูโูุงูุงูุ ุตุฏฺฉ นฐุงู (90th percentile) ุงุณุชูุงุฏู ุงุฒ CPU ุฏุฑ ุญุงูุช `system` ฺูุฏุฑ ุงุณุชุ ูโุชูุงูุณุชู ุงุฒ ุฏุณุชูุฑ ุฒุฑ ุงุณุชูุงุฏู ฺฉูู:

`quantile without(cpu)(0.9, rate(node_cpu_seconds_total{mode="system"}[5m]))`

ฺฉู ูุชุฌูโุง ูุงููุฏ ุฒุฑ ุชููุฏ ูโฺฉูุฏ:

`{instance="localhost:9100",job="node",mode="system"} 0.024558620689654007`

ุงู ุจุฏุงู ูุนูุงุณุช ฺฉู นฐูช ุงุฒ CPUูุง ูุง ุญุฏุงูู ฐ.ฐฒ ุซุงูู ุฏุฑ ูุฑ ุซุงูู ุฑุง ุฏุฑ ุญุงูุช `system` ุตุฑู ูโฺฉููุฏ. ุงู ฺฉูุฆุฑ ุงฺฏุฑ ุฏุฑ ูุงุดู ุฎูุฏ ุฏูโูุง CPU ุฏุงุดุชูุ ุจู ุฌุง ฺูุงุฑ CPU ฺฉู ุฏุฑ ุญุงู ุญุงุถุฑ ุฏุงุฑุฏุ ููุฏุชุฑ ุจูุฏ. ุนูุงูู ุจุฑ ูุงูฺฏูุ ูโุชูุงูุฏ ุงุฒ `quantile` ุจุฑุง ูุดุงู ุฏุงุฏู ูุงูู (median)ุ ุตุฏฺฉ ฒตุงู ู ทตุงู ุฏุฑ ูููุฏุงุฑูุง ุฎูุฏ ุงุณุชูุงุฏู ฺฉูุฏ. ุจุฑุง ูุซุงูุ ุจุฑุง ุงุณุชูุงุฏู CPU ุชูุณุท ูุฑุขูุฏุ ุนุจุงุฑุงุช ุจู ุดุฑุญ ุฒุฑ ุฎูุงููุฏ ุจูุฏ:

```promql
# ูุงูฺฏูุ ูุงูฺฏู ุญุณุงุจ
avg without(instance)(rate(process_cpu_seconds_total[5m]))
# ฺุงุฑฺฉ ฐ.ฒตุ ุตุฏฺฉ ฒตุงูุ ฺุงุฑฺฉ ุงูู ุง ูพุงูโุชุฑ
quantile without(instance)(0.25, rate(process_cpu_seconds_total[5m]))
# ฺุงุฑฺฉ ฐ.ตุ ุตุฏฺฉ ตฐุงูุ ฺุงุฑฺฉ ุฏููุ ูุงูู
quantile without(instance)(0.5, rate(process_cpu_seconds_total[5m]))
# ฺุงุฑฺฉ ฐ.ทตุ ุตุฏฺฉ ทตุงูุ ฺุงุฑฺฉ ุณูู ุง ุจุงูุงุชุฑ
quantile without(instance)(0.75, rate(process_cpu_seconds_total[5m]))
```

ุงู ุจู ุดูุง ุฏุฑฺฉ ุงุฒ ูุญูู ุฑูุชุงุฑ ูููููโูุง ูุฎุชูู ฺฉ `job` ูโุฏูุฏุ ุจุฏูู ุงูฺฉู ูุฌุจูุฑ ุจุงุดุฏ ูุฑ ููููู ุฑุง ุจู ุตูุฑุช ุฌุฏุงฺฏุงูู ุฑุณู ฺฉูุฏ. ุงู ุจู ุดูุง ุงูฺฉุงู ูโุฏูุฏ ุจุง ุงูุฒุงุด ุชุนุฏุงุฏ ูููููโูุง ุฒุฑุจูุงุ ุฏุงุดุจูุฑุฏูุง ุฎูุฏ ุฑุง ุฎูุงูุง ูฺฏู ุฏุงุฑุฏ. ุดุฎุตุงู ูุชูุฌู ุดุฏูโุงู ฺฉู ูููุฏุงุฑูุง ุจู ุชูฺฉฺฉ ูููููุ ุฏุฑ ุญุฏูุฏ ุณู ุชุง ูพูุฌ ููููู ฺฉุงุฑุง ุฎูุฏ ุฑุง ุงุฒ ุฏุณุช ูโุฏููุฏ.

# `quantile`ุ `histogram_quantile` ู `quantile_over_time` part2

ููุงูุทูุฑ ฺฉู ุดุงุฏ ุชุงฺฉููู ูุชูุฌู ุดุฏู ุจุงุดุฏุ ุจุด ุงุฒ ฺฉ ุชุงุจุน ุง ุนููฺฏุฑ PromQL ุจุง ฺฉููู `quantile` ุฏุฑ ูุงู ุฎูุฏ ูุฌูุฏ ุฏุงุฑุฏ. ุนููฺฏุฑ ุชุฌูุน `quantile` ุฑู ฺฉ ุจุฑุฏุงุฑ ูุญุธูโุง ุฏุฑ ฺฉ ฺฏุฑูู ุชุฌูุน ุนูู ูโฺฉูุฏ. ุชุงุจุน `quantile_over_time` ููุฒูุงู ุฑู ฺฉ ุณุฑ ุฒูุงู ูุงุญุฏ ุฏุฑ ฺฉ ุจุฑุฏุงุฑ ุจุงุฒูโุง (range vector) ุนูู ูโฺฉูุฏ. ุชุงุจุน `histogram_quantile` ููุฒูุงู ุฑู ุจุงฺฉุชโูุง (buckets) ฺฉ ูุฑุฒูุฏ ูุชุฑฺฉ ูุณุชูฺฏุฑุงู ุฏุฑ ฺฉ ุจุฑุฏุงุฑ ูุญุธูโุง ุนูู ูโฺฉูุฏ.

### `count_values`

ุขุฎุฑู ุนููฺฏุฑ ุชุฌูุน `count_values` ุงุณุช. ูุงููุฏ `topk`ุ ุงู ุนููฺฏุฑ ฺฉ ูพุงุฑุงูุชุฑ ูโฺฏุฑุฏ ู ูโุชูุงูุฏ ุจุด ุงุฒ ฺฉ ุณุฑ ุฒูุงู ุงุฒ ฺฉ ฺฏุฑูู ุจุฑฺฏุฑุฏุงูุฏ. ฺฉุงุฑ ฺฉู ุงูุฌุงู ูโุฏูุฏ ุงู ุงุณุช ฺฉู ฺฉ ูุณุชูฺฏุฑุงู ูุฑุงูุงู (frequency histogram) ุงุฒ ููุงุฏุฑ ุณุฑโูุง ุฒูุงู ุฏุฑ ฺฏุฑูู ุงุฌุงุฏ ูโฺฉูุฏุ ุจู ุทูุฑ ฺฉู ุชุนุฏุงุฏ ูุฑ ููุฏุงุฑ ุจู ุนููุงู ููุฏุงุฑ ุณุฑ ุฒูุงู ุฎุฑูุฌ ู ููุฏุงุฑ ุงุตู ุจู ุนููุงู ฺฉ ุจุฑฺุณุจ ุฌุฏุฏ ุฏุฑ ูุธุฑ ฺฏุฑูุชู ูโุดูุฏ. ุงู ุนุจุงุฑุช ฺฉู ุทููุงู ู ูพฺุฏู ุงุณุชุ ุจูุงุจุฑุงู ฺฉ ูุซุงู ุจุฑุง ุดูุง ูโุขูุฑู. ูุฑุถ ฺฉูุฏ ฺฉ ุณุฑ ุฒูุงู ุจู ูุงู `software_version` ุจุง ููุงุฏุฑ ุฒุฑ ุฏุงุฑุฏ:

```json
software_version{instance="a",job="j"} 7
software_version{instance="b",job="j"} 4
software_version{instance="c",job="j"} 8
software_version{instance="d",job="j"} 4
software_version{instance="e",job="j"} 7
software_version{instance="f",job="j"} 4
```

ุงฺฏุฑ ฺฉูุฆุฑ ุฒุฑ ุฑุง ุฑู ุงู ุณุฑโูุง ุฒูุงู ุงุฑุฒุงุจ ฺฉูุฏ:

`count_values without(instance)("version", software_version)`

ูุชุฌู ุฒุฑ ุฑุง ุฏุฑุงูุช ุฎูุงูุฏ ฺฉุฑุฏ:

```
{job="j",version="7"} 2
{job="j",version="8"} 1
{job="j",version="4"} 3
```

ุฏู ุณุฑ ุฒูุงู ุฏุฑ ฺฏุฑูู ุจุง ููุฏุงุฑ ท ูุฌูุฏ ุฏุงุดุชุ ุจูุงุจุฑุงู ฺฉ ุณุฑ ุฒูุงู ุจุง `version="7"` ุจู ููุฑุงู ุจุฑฺุณุจโูุง ฺฏุฑูู ุจุง ููุฏุงุฑ ฒ ุจุฑฺฏุฑุฏุงูุฏู ุดุฏ. ูุชุฌู ุจุฑุง ุณุงุฑ ุณุฑโูุง ุฒูุงู ูุดุงุจู ุงุณุช. ููฺฏุงู ุงุฌุงุฏ ูุณุชูฺฏุฑุงู ูุฑุงูุงูุ ูฺ ุจุงฺฉุชโุจูุฏ (bucketing) ุงูุฌุงู ููโุดูุฏุ ุงุฒ ููุงุฏุฑ ุฏูู ุณุฑโูุง ุฒูุงู ุงุณุชูุงุฏู ูโุดูุฏ. ุจูุงุจุฑุงูุ ุงู ุนููฺฏุฑ ุชููุง ุจุง ููุงุฏุฑ ุตุญุญ ู ุฏุฑ ุฌุง ฺฉู ุชุนุฏุงุฏ ููุงุฏุฑ ููุญุตุฑุจูโูุฑุฏ ุฒุงุฏ ูุจุงุดุฏุ ูุงูุนุงู ููุฏ ุงุณุช. ุงู ุจุดุชุฑ ุจุง ุดูุงุฑูโูุง ูุณุฎูุ ุง ุจุง ุชุนุฏุงุฏ ุงุดุงุก ุงุฒ ููุน ุฎุงุต ฺฉู ูุฑ ููููู ุงุฒ ุจุฑูุงูู ุดูุง ูุดุงูุฏู ูโฺฉูุฏุ ููุฏ ุงุณุช. ุงฺฏุฑ ูุณุฎูโูุง ุฒุงุฏ ุฑุง ููุฒูุงู ูุณุชูุฑ ฺฉุฑุฏู ุจุงุดุฏุ ุง ุจุฑูุงููโูุง ูุฎุชูู ููฺูุงู ุชุนุฏุงุฏ ูุชูุงูุช ุงุฒ ุงุดุงุก ุฑุง ูุดุงูุฏู ฺฉููุฏุ ููฺฉู ุงุณุช ฺุฒ ุฏุฑ ุฌุง ฺฏุฑ ฺฉุฑุฏู ุจุงุดุฏ. `count_values` ุฑุง ูโุชูุงู ุจุง `count` ุชุฑฺฉุจ ฺฉุฑุฏ ุชุง ุชุนุฏุงุฏ ููุงุฏุฑ ููุญุตุฑุจูโูุฑุฏ ุฑุง ุจุฑุง ฺฉ ฺฏุฑูู ุชุฌูุน ูุนู ูุญุงุณุจู ฺฉุฑุฏ. ุจุฑุง ูุซุงูุ ุชุนุฏุงุฏ ูุณุฎูโูุง ูุฑูโุงูุฒุงุฑ ฺฉู ูุณุชูุฑ ุดุฏูโุงูุฏ ุฑุง ูโุชูุงู ุจุง ุฏุณุชูุฑ ุฒุฑ ูุญุงุณุจู ฺฉุฑุฏ:

`count without(version)( count_values without(instance)("version", software_version) )`

ฺฉู ุฏุฑ ุงู ููุฑุฏ ูุชุฌู ุฒุฑ ุฑุง ุจุฑูโฺฏุฑุฏุงูุฏ:

`{job="j"} 3`

ููฺูู ูโุชูุงูุฏ `count_values` ุฑุง ุจุง `count` ุฏุฑ ุฌูุช ุฏฺฏุฑ ุชุฑฺฉุจ ฺฉูุฏุ ุจุฑุง ูุซุงูุ ุจุฑุง ุฏุฏู ุงูฺฉู ฺู ุชุนุฏุงุฏ ุงุฒ ูุงุดูโูุง ุดูุง ฺู ุชุนุฏุงุฏ ุฏุณุชฺฏุงู ุฏุณฺฉ ุฏุงุฑูุฏ:

`count_values without(instance)( "devices", count without(device) (node_disk_io_now) )`

ุฏุฑ ููุฑุฏ ูุงุ ฺฉ ูุงุดู ุจุง ูพูุฌ ุฏุณุชฺฏุงู ุฏุณฺฉ ุฏุงุฑู:

`{devices="5",job="node"} 1`

ุงฺฉููู ฺฉู ุจุง ุนููฺฏุฑูุง ุชุฌูุน ุขุดูุง ุดุฏุฏุ ุจู ุนููฺฏุฑูุง ุฏูุฏู (binary operators) ูุงููุฏ ุฌูุน ู ุชูุฑู ู ูุญูู ุนููฺฉุฑุฏ ุชุทุงุจู ุจุฑุฏุงุฑ (vector matching) ุฎูุงูู ูพุฑุฏุงุฎุช.

---
**ุชูุถุญุงุช ูพุงูุฑูโูุง (footnotes) ฺฉู ุฏุฑ ูุชู ุจุง ุดูุงุฑู ูุดุฎุต ุดุฏูโุงูุฏ:**

ฒ. ุฏุฑ ููุฑุฏ ุดูุงุฑูุฏูโูุง (counters) ุตุญุจุช ูโุดูุฏ.
ณ. ููุธูุฑ `count` ุฏุงุฎู ุฏุฑ ุนุจุงุฑุช `count without(cpu)(count without (mode)(node_cpu_seconds_total))` ุงุณุช.
ด. ููุธูุฑ ููุงุฏุฑ ุนุฏุฏ ุณุฑโูุง ุฒูุงู ุงุณุช.
ต. ุจู ุงู ุฏูู ฺฉู ุชูุณู ุจุฑ ุตูุฑ (0/1) ูุชุฌู `NaN` (Not a Number) ูโุฏูุฏ.
ถ. ููุธูุฑ ุนุฏุฏ ฑ.ถณณ ุจู ุนููุงู ุงูุญุฑุงู ูุนุงุฑ ุจุฑุง ูุซุงู [ฒุดุถ] ุงุณุช.
ท. ุงู ฺฉ ุฎุงุตุช ุขูุงุฑ ุชูุฒุน ูุฑูุงู ุงุณุช.
ธ. ูุงุฑุงูุณ ูุนุงุฑ ุจุฑุงุจุฑ ุงุณุช ุจุง (ุงูุญุฑุงู ูุนุงุฑ) ุจู ุชูุงู ฒ.
น. ุงฺฏุฑ ูโุฎูุงูุฏ ุณุฑ ุฒูุงู ูุฑูุฏ ุจุฑฺฏุฑุฏุงูุฏู ุดูุฏุ ุงุฒ `topk` ุง `bottomk` ุงุณุชูุงุฏู ฺฉูุฏ.
ฑฐ. ุฏุฑ ุฑุงุถุงุช ููุฒ ุดูุงูุฑุ ูุฑ ููุงุณูโุง ุจุง `NaN` ููุดู `false` ุจุฑูโฺฏุฑุฏุงูุฏ. ุฌุฏุง ุงุฒ ุงุฌุงุฏ ููุงุฑุฏ ุนุฌุจ ูุงููุฏ `NaN != NaN` ฺฉู `false` ุจุฑูโฺฏุฑุฏุงูุฏุ ฺฉ ูพุงุฏูโุณุงุฒ ุณุงุฏู ุงุฒ `min` ู `max` (ฺฉู ูุจูุงู ูู ุงุชูุงู ุงูุชุงุฏู) ุงฺฏุฑ ุงููู ููุฏุงุฑ ุจุฑุฑุณ ุดุฏู `NaN` ุจูุฏุ ุฑู ุขู ฺฏุฑ ูโฺฉุฑุฏ.
ฑฑ. ุฏุฑ ุงู ูุซุงูุ k ุจุฑุงุจุฑ ฒ ุงุณุช.
ฑฒ. ุตุฏฺฉโูุง (Percentiles)
ฑณ. ูุงููุฏ ุดูุงุฑู ูุณุฎูโูุง ูุฑูโุงูุฒุงุฑ.